# L1_設計・実装の方針

**作成日**: 2025年12月8日  
**カテゴリ**: 第1層 - 基礎  
**バージョン**: 1.1  
**更新日**: 2025年12月8日

---

## 📖 このドキュメントについて

このドキュメントは、**プロジェクトBの設計・実装における具体的な方針**を定義します。

特に、**3人体制（ユーザー・Claude・GitHub Copilot）での協働において、GitHub Copilotの誤実装を防ぐための方針**を詳細に記述します。

### 対象読者

- **Claude**（設計担当）← 最重要
- **ユーザー**（レビュー担当）
- **GitHub Copilot**（実装担当）← 実装指示書を通じて間接的に

### 読了後に理解できること

- 設計品質の5原則
- 実装指示書の書き方（データ型の明示、インタラクション、状態遷移）
- LLM誤解予測レビューの方法
- レビュー方法（設計、実装、ギャップ分析）
- 引継ぎルール

### 重要な前提

**GitHub Copilotは設計書を直接参照できます**

- VSCodeのプロジェクトフォルダ構造: `docs/L0/`, `docs/L1/`, `docs/L2/`, `docs/L3/`, `docs/templates/`
- GitHub Copilotは `docs/L1/L1_概要_プロジェクト概要.md` のようなパスで設計書を読める
- 実装指示書には**設計書への参照**を明記し、要点のみを再掲する
- これにより実装指示書が短くなり、タイムアウトを回避できる


### このドキュメントを読むタイミング

```
設計書を作成する前 → 5原則を確認
  ↓
実装指示書を作成する前 → セクション2を熟読
  ↓
LLM誤解予測レビューを実施 → セクション3を熟読
  ↓
実装レビュー → セクション4を確認
  ↓
チャット切り替え → セクション5を確認
```

---

## 1. 設計品質の5原則

このプロジェクトの設計は、前プロジェクトの教訓から以下の5原則を守ります。

### 原則1: 曖昧さは実装時ではなく、設計時に排除する

**問題**:
```
設計書: 「セルをクリックすると状態が変わる」
  ↓
GitHub Copilot: モーダルを作ってしまう
```

**解決**:
```
設計書: 「左クリックすると、空欄→○→◓→◒→空欄の順にトグルする」
  ↓
GitHub Copilot: トグル機能を実装する
```

**チェック方法**: 「これだけ読んで実装できるか？」を自問する

---

### 原則2: データ型を明示する

**悪い例**:
```
日付を保存する
```

**良い例**:
```
日付を保存する
- 型: string
- 形式: 'YYYY-MM-DD'
- 例: '2025-11-01'
- バリデーション: /^\d{4}-\d{2}-\d{2}$/
```

**重要**: 「文字列」「数値」「Date型」を明確に区別する

---

### 原則3: インタラクションを詳細に記述する

**悪い例**:
```
セルをクリックすると状態が変わる
```

**良い例**:
```
左クリック時の動作:
1. 現在の状態を取得（空欄/'○'/'◓'/'◒'）
2. 次の状態に遷移（空欄→○→◓→◒→空欄）
3. データを更新（KayoiSchedule.symbol）
4. localStorageに保存
5. 表示を更新（0.2秒フェード）
6. 定員カウントを再計算
7. 色分けを更新
8. 履歴に記録（Ctrl+Z用）
```

---

### 原則4: 状態遷移を図示する

**必ず図示する**:
```
[空欄] --左クリック--> [○終日]
  ↑                        |
  |                   左クリック
  |                        ↓
[◒後半] <--左クリック-- [◓前半]
  |
左クリック
  |
  ↓
[空欄]（戻る）
```

図がないと、GitHub Copilotは勝手に解釈します。

---

### 原則5: テスト仕様書を先に書く

**実装前に書く**:
```
テスト1: 空欄→終日
  操作: 空欄のセルを左クリック
  期待: '○'が表示される、定員カウント+1

テスト2: 終日→前半
  操作: '○'のセルを左クリック
  期待: '◓'が表示される、定員カウント変わらず

テスト3: 定員超過時の色分け
  操作: 前半の定員が15人になった
  期待: 前半の日別サマリーの背景色が赤（rgba(255,0,0,0.1)）
```

テスト仕様があれば、実装の正しさを確認できます。

---

## 2. 実装指示書の書き方

実装指示書は、GitHub Copilotが**そのまま実装できるレベル**で書きます。

### 2.1 必須要素

```
✓ 目的（WHY）
✓ 設計書への参照（WHERE）← 最重要
✓ 仕様（WHAT）← 要点のみ
✓ 制約（DON'T）← 最重要
✓ データ型の明示
✓ インタラクションの詳細
✓ 状態遷移図
✓ テストケース
✓ 警告セクション← LLM誤解予測レビュー後に追加
```

**重要**: GitHub Copilotは `docs/` フォルダ配下の設計書を直接読めます。実装指示書には必ず**設計書への参照**を含めてください。

---

### 2.2 目的（WHY）

**なぜこの機能が必要なのか**を明記します。

**例**:
```markdown
## 目的

通いセクションで、利用者の前半・後半の利用状況を管理する。

業務上の理由:
- 通い定員は15人
- 前半・後半で別々にカウントする必要がある
- 定員超過を防ぐため、リアルタイムにカウントする
```

---

### 2.3 仕様（WHAT）

**何を実装するのか**を明記します。

**重要**: GitHub Copilotは `docs/` フォルダ配下の設計書を直接参照できます。実装指示書には**参照先を明記**し、要点のみを再掲してください。

**例**:
```markdown
## 仕様

### データ構造

**参照**: `docs/L2/L2_通い_データ構造.md` セクション2.1

重要な点のみ再掲:
- `KayoiSchedule` クラスを使用
- `symbol` は string型（''/'○'/'◓'/'◒'）
- `date` は 'YYYY-MM-DD' 形式

⚠️ 詳細は上記設計書を参照してください。

### UI

**参照**: `docs/L2/L2_通い_UI設計.md` セクション3.2

重要な点のみ再掲:
- 利用者×日付のマトリクス
- セル内に記号を表示（空欄/○/◓/◒）
- 定員超過時は背景色を赤に

⚠️ 詳細は上記設計書を参照してください。
```

**メリット**:
- 実装指示書が短くなる（タイムアウト回避）
- 設計書との二重管理を避けられる
- GitHub Copilotが設計書を直接読むので、より正確に理解できる

---

### 2.4 制約（DON'T）← 最重要

**やってはいけないこと**を明記します。

**例**:
```markdown
## 制約（DON'T）

### ❌ モーダルを使わない
- 理由: 左クリックでトグルのみ
- 代わりに: handleCellClick()でトグル
- 根拠: `docs/L2/L2_通い_UI設計.md` セクション4.1

### ❌ ライブラリを導入しない
- 理由: バニラJavaScriptのみ
- 代わりに: 標準APIを使用
- 根拠: `docs/L1/L1_技術_実装制約.md` セクション2.3

### ❌ 横スクロールを発生させない
- 理由: 31日分を画面幅に収める必須要件
- 代わりに: CSS変数 `var(--date-cell-width)` を使用
- 根拠: `docs/L1/L1_技術_実装制約.md` セクション3.6
```

**重要**: 
- 必ず設計書への参照（`docs/xxx`）を含める
- GitHub Copilotが根拠を確認できるようにする

---

### 2.5 データ型の明示

**すべてのデータに型を明記**します。

**悪い例**:
```
日付を保存する
```

**良い例**:
```
日付を保存する
- 型: string
- 形式: 'YYYY-MM-DD'
- 例: '2025-11-01'
- バリデーション: /^\d{4}-\d{2}-\d{2}$/
- 理由: Date型は時刻を含むため、日付のみの場合はstring推奨
```

---

### 2.6 インタラクションの詳細

**すべての操作に対して、ステップバイステップで記述**します。

**悪い例**:
```
セルをクリックすると状態が変わる
```

**良い例**:
```
左クリック時の動作:

1. 現在の状態を取得
   ```javascript
   const currentSymbol = cell.querySelector('.symbol').textContent;
   // ''（空欄）, '○', '◓', '◒' のいずれか
   ```

2. 次の状態を決定
   ```
   空欄('') → '○'（終日）
   '○' → '◓'（前半）
   '◓' → '◒'（後半）
   '◒' → ''（空欄に戻る）
   ```

3. データを更新
   ```javascript
   schedule.symbol = nextSymbol;
   saveToLocalStorage();
   ```

4. 表示を更新
   ```javascript
   cell.querySelector('.symbol').textContent = nextSymbol;
   cell.style.transition = 'all 0.2s ease';
   ```

5. 定員カウントを再計算
   ```javascript
   updateCapacityCount(date, section);
   ```

6. 色分けを更新
   ```javascript
   updateCellColor(date, section);
   ```

7. 履歴に記録
   ```javascript
   history.push({ type: 'update', schedule });
   ```
```

---

### 2.7 状態遷移図

**必ず図示**します。テキストだけでは誤解されます。

**例**:
```
[空欄] --左クリック--> [○終日]
  ↑                        |
  |                   左クリック
  |                        ↓
[◒後半] <--左クリック-- [◓前半]
  |
左クリック
  |
  ↓
[空欄]（戻る）

右クリック:
  └─> コンテキストメニュー表示（Phase 2で実装予定）
```

---

### 2.8 テストケース

**実装前に書く**ことで、実装の完成度を確認できます。

**例**:
```
テスト1: 空欄→終日
  前提: セルが空欄
  操作: 左クリック
  期待:
    - セル内に '○' が表示される
    - 定員カウント +1（該当する時間帯）
    - localStorageに保存される

テスト2: 定員超過時の色分け
  前提: 前半の定員が14人
  操作: 15人目を追加
  期待:
    - 前半の日別サマリーの背景色が黄色（rgba(255,255,0,0.1)）
    - 16人目を追加すると赤色（rgba(255,0,0,0.1)）

テスト3: Ctrl+Zで元に戻す
  前提: 空欄のセルを '○' に変更した
  操作: Ctrl+Z
  期待:
    - セルが空欄に戻る
    - 定員カウント -1
    - localStorageが更新される
```

---

### 2.9 警告セクション

**LLM誤解予測レビュー後に追加**します（セクション3参照）。

**例**:
```markdown
## ⚠️ 警告：GitHub Copilotへ

### 📚 実装前に必読

以下のドキュメントを必ず読んでください:
1. `docs/L2/L2_通い_UI設計.md`（UI仕様）
2. `docs/L2/L2_通い_データ構造.md`（データ構造）
3. `docs/templates/GUIDE_LLM誤解予測レビュー.md`（誤実装パターン）

---

### ❌ やってはいけないこと

#### 1. モーダルを使わない
- 理由: 左クリックでトグルのみ
- 代わりに: handleCellClick()でトグル
- 根拠: `docs/L2/L2_通い_UI設計.md` セクション4.1

#### 2. 日別サマリーを5行にしない
- 理由: タブ別に表示内容が異なる
- 通いタブ: 3行（通い、迎え、送り）
- 泊まりタブ: 4行（泊まり、重度、中度、軽度）
- 根拠: `docs/L3/U3_UI_日別サマリー.md` セクション1.4

#### 3. CSS変数を無視しない
- 理由: 横スクロール禁止のため
- 必ず: `var(--date-cell-width)` を使用
- 根拠: `docs/L1/L1_技術_実装制約.md` セクション3.6
```

**重要**:
- 冒頭に「必読ドキュメント」リストを追加
- 各警告に設計書への参照（`docs/xxx`）を含める

---

## 3. LLM誤解予測レビュー

実装指示書を作成したら、必ず**LLM誤解予測レビュー**を実施します。

### 3.1 目的

**GitHub Copilotの「効率化の誘惑」を予測し、先回りして警告する**

---

### 3.2 「効率化の誘惑」とは

GitHub Copilotは、以下のような「効率化」を勝手に行う傾向があります：

#### 誘惑1: モーダルを作る

```
設計: 「セルをクリックして編集」
  ↓
GitHub Copilot: 「モーダルで実装した方が綺麗」
  ↓
結果: モーダルを勝手に作る
```

**理由**: モーダルは一般的なUIパターンだから

---

#### 誘惑2: ライブラリを導入する

```
設計: 「日付処理」
  ↓
GitHub Copilot: 「moment.jsを使おう」
  ↓
結果: ライブラリを勝手に導入
```

**理由**: ライブラリの方が便利だから

---

#### 誘惑3: 仕様を簡略化する

```
設計: 「タブ別に3行表示（通い、迎え、送り）」
  ↓
GitHub Copilot: 「全部表示した方が簡単」
  ↓
結果: 5行表示（通い、迎え、送り、泊まり、訪問）
```

**理由**: 条件分岐を減らしたいから

---

#### 誘惑4: 重複コードを削除する

```
設計: 「カレンダーヘッダーを独立表示」
  ↓
GitHub Copilot: 「各セクションのグリッドに統合した方が効率的」
  ↓
結果: 日付ヘッダーが重複表示
```

**理由**: DRY原則（Don't Repeat Yourself）に従いたいから

---

#### 誘惑5: CSS変数を無視する

```
設計: 「var(--date-cell-width) を使用」
  ↓
GitHub Copilot: 「calc()が複雑すぎる、固定値でいいや」
  ↓
結果: 横スクロールが発生
```

**理由**: 複雑なCSSを避けたいから

---

**これらは全て「親切心」から来るが、設計を壊す**

---

### 3.3 レビュー方法

```
手順:
1. 実装指示書を読む
2. 「GitHub Copilotが誤実装しそうな箇所」を列挙
3. 各誤実装について警告を書く
4. 警告セクションを実装指示書に追加
```

**詳細**: GUIDE_LLM誤解予測レビュー.md を参照

---

### 3.4 警告の書き方

**警告セクションの例**:
```markdown
## ⚠️ 警告：GitHub Copilotへ

### 📚 実装前に必読

以下のドキュメントを必ず読んでください:
1. `docs/L2/L2_通い_UI設計.md`（UI仕様）
2. `docs/L2/L2_通い_データ構造.md`（データ構造）
3. `docs/templates/GUIDE_LLM誤解予測レビュー.md`（誤実装パターン）

---

### ❌ やってはいけないこと

#### 1. モーダルを使わない
- 理由: 左クリックでトグルのみ
- 代わりに: handleCellClick()でトグル
- 根拠: `docs/L2/L2_通い_UI設計.md` セクション4.1

#### 2. 日別サマリーを5行にしない
- 理由: タブ別に表示内容が異なる
- 通いタブ: 3行（通い、迎え、送り）
- 泊まりタブ: 4行（泊まり、重度、中度、軽度）
- 根拠: `docs/L3/U3_UI_日別サマリー.md` セクション1.4

#### 3. CSS変数を無視しない
- 理由: 横スクロール禁止のため
- 必ず: `var(--date-cell-width)` を使用
- 根拠: `docs/L1/L1_技術_実装制約.md` セクション3.6
```

**重要**: 
- **「❌」で否定形**
- **理由を明記**
- **代わりに何をするか明記**
- **設計書への参照を必ず含める**（`docs/xxx` 形式）

---

### 3.5 Phase 1で発生した誤実装の例

Phase 1実装後に発覚した5つの問題は、全てこの「効率化の誘惑」が原因でした：

```
1. 日別サマリー5行 → 誘惑3（仕様の簡略化）
2. 日付ヘッダー重複 → 誘惑4（重複コードの削除）
3. モーダル表示 → 誘惑1（モーダルを作る）
4. 横スクロール → 誘惑5（CSS変数を無視）
5. セル幅ズレ → 誘惑5（CSS変数を無視）
```

**警告セクションがあれば、これらは全て防げます。**

---

## 4. レビュー方法

### 4.1 設計レビュー

設計書を作成したら、必ず以下をチェック：

```
□ 曖昧な表現がないか
  例: 「セルをクリックすると状態が変わる」→NG
  
□ データ型が明示されているか
  例: string/number/Date/boolean

□ インタラクションが詳細に記述されているか
  例: 左クリック時の動作を8ステップで記述

□ 状態遷移図があるか
  例: [空欄]→[○]→[◓]→[◒]→[空欄]

□ テストケースが書かれているか
  例: テスト1, 2, 3...

□ L0層（業務知識）と矛盾していないか
  例: 定員15人、前半・後半別
```

**詳細**: CHECKLIST_設計レビュー.md を参照

---

### 4.2 実装レビュー

実装後、必ず以下を確認：

```
□ 設計書通りに実装されているか
  - データ型が正しいか
  - インタラクションが正しいか
  - 状態遷移が正しいか

□ 警告セクションの指示が守られているか
  - モーダルが作られていないか
  - ライブラリが導入されていないか
  - 仕様が簡略化されていないか

□ 横スクロールが発生していないか
  - 31日分が画面幅に収まっているか

□ 縦軸が完璧に揃っているか
  - カレンダーヘッダー
  - 日別サマリー
  - メインコンテンツ

□ 定員チェックが正しく動作するか
  - 前半・後半別にカウント
  - 超過時に赤色

□ 色分けが正しいか
  - 超過: 赤（rgba(255,0,0,0.1)）
  - ギリギリ: 黄（rgba(255,255,0,0.1)）
  - 余裕: 通常

□ Ctrl+Zが動作するか
  - 履歴スタックが正しく管理されているか
```

---

### 4.3 ギャップ分析

実装と設計にズレがある場合：

```
手順:
1. ズレの内容を明確にする
   例: 「日別サマリーが5行（設計: タブ別3行）」

2. ズレの原因を特定する
   - 設計書が曖昧だった？
     → 次回は詳細に記述
   - 警告が不足していた？
     → LLM誤解予測レビューを改善
   - GitHub Copilotが無視した？
     → 警告の書き方を改善

3. 修正指示書を作成
   - 同じ誤実装を防ぐ警告を追加

4. 設計書・実装指示書を改善（次回に活かす）
   - 改善点をドキュメントに反映
```

---

## 5. 引継ぎルール

チャット切り替え時は、必ず引継ぎドキュメントを作成します。

### 5.1 引継ぎドキュメントの構成

```
1. プロジェクトの現状（50行）
   - 何が完成しているか
   - 何が未完成か
   - 現在の課題

2. 必ず読むべきドキュメント（50行）
   - 読む順序を明記
   - 読む理由を説明

3. 読まなくていいドキュメント（20行）
   - 理由を明記

4. 次のタスク（30行）
   - 具体的な作業内容
   - 注意点

5. 重要な判断事項（20行）
   - ユーザーに確認すべきこと
```

**詳細**: GUIDE_引継ぎドキュメント作成ルール.md を参照

---

### 5.2 必読ドキュメントの明示

**悪い例**:
```
L0層を全部読んでください
```

**良い例**:
```
必ず読むべきドキュメント（この順序で）:

1. `docs/INDEX_ドキュメント構成.md`
   理由: 全体の構造を理解するため
   所要時間: 5分

2. `docs/L0/L0_業務_調整業務の制約.md`
   理由: 制約パズルの本質を理解するため
   所要時間: 10分

3. `docs/L0/L0_業務_定員の法的枠組み.md`
   理由: 定員チェックのロジックに必須
   所要時間: 10分

4. `docs/L1/L1_概要_プロジェクト概要.md`
   理由: 3人体制と道筋を理解するため
   所要時間: 15分

5. `docs/L1/L1_設計・実装の方針.md`（このドキュメント）
   理由: 実装指示書の書き方を理解するため
   所要時間: 20分

6. `docs/L2/L2_通い_データ構造.md`
   理由: 通いセクションの実装に必須
   所要時間: 15分

---

読まなくていいドキュメント:

- `docs/L0/L0_業務_新規利用者獲得.md`
  理由: Phase 2の営業支援機能に関連、Phase 1では不要

- `docs/L0/L0_業務_介護ソフトとの関係.md`
  理由: CSV連携は完成済み、次のタスクに不要
```

**重要**: `docs/` から始まる**正確なパス**、読む順序、理由、所要時間を明記する

---

### 5.3 引継ぎの失敗例

Phase 1の引継ぎで以下の問題がありました：

```
失敗1: 「L0層を全部読んで」と指示
  ↓
問題: 6文書（約6,000行）を読むのに時間がかかる
  ↓
改善: 必要なドキュメントだけを明示

失敗2: 「横スクロール禁止（新要件）」と記載
  ↓
問題: 実際はL0層に既に記載されていた
  ↓
改善: L0層を確認してから引継ぎドキュメントを作成
```

---

## 📚 関連ドキュメント

- **`docs/templates/CHECKLIST_設計レビュー.md`**: 設計レビューの詳細チェックリスト
- **`docs/templates/GUIDE_LLM誤解予測レビュー.md`**: LLM誤解予測レビューの詳細ガイド
- **`docs/templates/GUIDE_引継ぎドキュメント作成ルール.md`**: 引継ぎドキュメントの詳細ルール
- **`docs/L1/L1_概要_プロジェクト概要.md`**: プロジェクトの全体像（ゴールと道筋）

---

## 📅 更新履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|----------|---------|------|
| 2025-12-08 | 1.0 | 初版作成（L1_概要_プロジェクト概要 v2.0 セクション6から独立） | Claude |
| 2025-12-08 | 1.1 | GitHub Copilotが設計書を直接読めることを反映、実装指示書の書き方を修正（設計書への参照を推奨、`docs/` パスを明記） | Claude |

---

**最終更新**: 2025年12月8日  
**次回更新予定**: Phase 1実装完了後、フィードバック反映時

---

## 💡 このドキュメントの活用方法

### 設計書を作成する前

- **セクション1「設計品質の5原則」を確認**
- 曖昧さを排除する意識を持つ

### 実装指示書を作成する時

- **セクション2「実装指示書の書き方」を熟読**
- データ型、インタラクション、状態遷移、テストケースを必ず記述

### LLM誤解予測レビューを実施する時

- **セクション3「LLM誤解予測レビュー」を熟読**
- 「効率化の誘惑」5パターンを意識
- 警告セクションを必ず追加

### 実装をレビューする時

- **セクション4「レビュー方法」を確認**
- 設計書とのギャップを分析
- 次回に活かす改善点を記録

### チャットを切り替える時

- **セクション5「引継ぎルール」を確認**
- 必読ドキュメントを明示
- 読む順序と理由を記載

---

**このドキュメントを読了したら、実際の設計・実装に進んでください。**