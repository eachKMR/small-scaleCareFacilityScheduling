# L1_設計・実装の方針

**作成日**: 2025年12月8日  
**カテゴリ**: 第1層 - 基礎  
**バージョン**: 2.0  
**更新日**: 2025年12月17日

---

## 📖 このドキュメントについて

このドキュメントは、**プロジェクトBの設計・実装における方針（WHY）**を定義します。

特に、**3人体制（ユーザー・Claude・GitHub Copilot）での協働において、GitHub Copilotの誤実装を防ぐための原則**を説明します。

### 対象読者

- **Claude**（設計担当）← 最重要
- **ユーザー**（レビュー担当）
- **GitHub Copilot**（実装担当）← 実装指示書を通じて間接的に

### 読了後に理解できること

- 設計品質の5原則（なぜその原則が必要か）
- 実装指示書に書くべきこと・書かないべきこと（原則）
- LLM誤解予測レビューの必要性
- レビューの目的
- 引継ぎの目的

### v2.0での主要な変更

- **原則（WHY）に集中**（具体的な手順はGUIDEへ）
- **GUIDE_実装指示書作成.mdとの役割分担を明確化**
- **INDEX v2.0の活用を追加**
- **約380行 → 約300行（-21%）**

### 重要な前提

**GitHub Copilotは設計書を直接参照できます**

- VSCodeのプロジェクトフォルダ構造: `docs/L0/`, `docs/L1/`, `docs/L2/`, `docs/L3/`, `docs/templates/`
- GitHub Copilotは `docs/L1/L1_概要_プロジェクト概要.md` のようなパスで設計書を読める
- 実装指示書には**設計書への参照**を明記し、要点のみを再掲する
- これにより実装指示書が短くなり、タイムアウトを回避できる

### このドキュメントを読むタイミング

```
設計書を作成する前 → セクション1を確認
  ↓
実装指示書を作成する前 → セクション2を確認
  ↓
LLM誤解予測レビューを実施 → セクション3を確認
  ↓
実装レビュー → セクション4を確認
  ↓
チャット切り替え → セクション5を確認
```

---

## 1. 設計品質の5原則

このプロジェクトの設計は、前プロジェクトの教訓から以下の5原則を守ります。

### 原則1: 曖昧さは実装時ではなく、設計時に排除する

**なぜこの原則が必要か**:
- LLM実装者（GitHub Copilot）は曖昧な指示を自分なりに解釈する
- 解釈が設計意図と異なると誤実装になる
- 曖昧さを残すと、修正コストが増大する

**問題の例**:
```
設計書: 「セルをクリックすると状態が変わる」
  ↓
GitHub Copilot: モーダルを作ってしまう
```

**解決の例**:
```
設計書: 「左クリックすると、空欄→○→◓→◒→空欄の順にトグルする」
  ↓
GitHub Copilot: トグル機能を実装する
```

**チェック方法**: 「これだけ読んで実装できるか？」を自問する

---

### 原則2: データ型を明示する

**なぜこの原則が必要か**:
- JavaScriptは動的型付け言語
- 型が曖昧だと、比較・計算・保存で問題が起きる
- Date型と文字列の混在は特に問題

**悪い例**:
```
日付を保存する
```

**良い例**:
```
日付を保存する
- 型: string
- 形式: 'YYYY-MM-DD'
- 例: '2025-11-01'
- バリデーション: /^\d{4}-\d{2}-\d{2}$/
```

**重要**: 「文字列」「数値」「Date型」を明確に区別する

---

### 原則3: インタラクションを詳細に記述する

**なぜこの原則が必要か**:
- 「クリックしたらどうなる」だけでは不十分
- 実装者は8ステップの処理を理解する必要がある
- 処理の順序、副作用を明示しないと誤実装になる

**悪い例**:
```
セルをクリックすると状態が変わる
```

**良い例**:
```
左クリック時の動作:
1. 現在の状態を取得（空欄/'○'/'◓'/'◒'）
2. 次の状態に遷移（空欄→○→◓→◒→空欄）
3. データを更新（KayoiSchedule.symbol）
4. localStorageに保存
5. 表示を更新（0.2秒フェード）
6. 定員カウントを再計算
7. 色分けを更新
8. 履歴に記録（Ctrl+Z用）
```

---

### 原則4: 状態遷移を図示する

**なぜこの原則が必要か**:
- 状態遷移はテキストだけでは理解しにくい
- 図があれば一目で分かる
- 実装者が遷移パターンを見落とさない

**必ず図示する**:
```
[空欄] --左クリック--> [○終日]
  ↑                        |
  |                   左クリック
  |                        ↓
[◒後半] <--左クリック-- [◓前半]
  |
左クリック
  |
  ↓
[空欄]（戻る）
```

図がないと、GitHub Copilotは勝手に解釈します。

---

### 原則5: テスト仕様書を先に書く

**なぜこの原則が必要か**:
- 「完成」の定義が明確になる
- 実装者が何を確認すればいいか分かる
- テスト駆動設計（TDD）の考え方

**実装前に書く**:
```
テスト1: 空欄→終日
  操作: 空欄のセルを左クリック
  期待: '○'が表示される、定員カウント+1

テスト2: 終日→前半
  操作: '○'のセルを左クリック
  期待: '◓'が表示される、定員カウント変わらず

テスト3: 定員超過時の色分け
  操作: 前半の定員が15人になった
  期待: 前半の日別サマリーの背景色が赤（rgba(255,0,0,0.1)）
```

テスト仕様があれば、実装の正しさを確認できます。

---

## 2. 実装指示書の原則

### 2.0 なぜ実装指示書が必要か

**設計書だけでは不十分な理由**:
- 設計書は「何を作るか」を定義（WHAT）
- 実装指示書は「どう作るか」を指示（HOW）
- GitHub Copilotは明確な指示が必要

**曖昧さは誤実装を生む**:
- 「日別サマリーを作る」→ 5行作られた（正しくはタブ別3行）
- 「カレンダーヘッダーを配置」→ 通いグリッド内に作られた（正しくは統合UI）

**警告がないと「効率化の誘惑」に負ける**:
- モーダルを勝手に作る
- ライブラリを導入する
- 共通化してセクション独立性を壊す

---

### 2.1 実装指示書の必須要素

**必須要素**:
```
✓ 目的（WHY）
✓ 仕様（WHAT）
✓ 制約（DON'T）← 最重要
✓ 設計書への参照
✓ 完成の定義
✓ 警告セクション← LLM誤解予測レビュー後に追加
```

**詳細なテンプレート**: GUIDE_実装指示書作成.md セクション3を参照

---

### 2.2 データ型を明示する（原則1の適用）

実装指示書では、設計書のデータ型を再確認させる：

```markdown
## データ型の確認

L2_通い_データ構造.md で定義されている通り：
- 日付: string（'YYYY-MM-DD'）
- 利用者ID: string
- 記号: string（'○'/'◓'/'◒'/空欄）
```

**なぜ再確認が必要か**: 実装者がDate型を使ってしまう誤りを防ぐ

---

### 2.3 インタラクションを詳細に記述する（原則3の適用）

実装指示書では、設計書のインタラクションを再確認させる：

```markdown
## 左クリック時の動作

L2_通い_UI設計.md セクション3.2で定義されている通り、
以下の8ステップを実装してください：

1. 現在の状態を取得
2. 次の状態に遷移
... （省略）
```

**なぜ再確認が必要か**: 処理の順序、副作用を見落とさないため

---

### 2.4 状態遷移を図示する（原則4の適用）

実装指示書では、設計書の状態遷移図を再掲する：

```markdown
## 状態遷移

L2_通い_UI設計.md セクション3.3の状態遷移図を参照してください：

[空欄] → [○] → [◓] → [◒] → [空欄]
```

**なぜ再掲が必要か**: 実装者が図を見落とさないため

---

### 2.5 実装指示書に書くべきこと・書かないべきこと

#### 書くべきこと（原則）

**1. 非自明な部分の完全なコード**

なぜ: 設計書の計算式を読んでも、実装者が「どう書くか」迷う

例: カラーグラデーション計算式（完全なコードを提供）

---

**2. 警告セクション**

なぜ: LLM誤解予測レビューで特定した誤実装パターンを防ぐ

---

**3. 完成の定義**

なぜ: 実装者が「完成」を判断できるようにする

---

#### 書かないべきこと（原則）

**1. HTML構造の詳細**

なぜ: 設計書（L2_×××_UI設計.md）に書いてある

書き方: 「L2_通い_UI設計.md セクション2.1を参照してください」

---

**2. CSS変数の固定値**

書くべき: 「CSS変数 `--date-cell-width` を使用してください」

書かない: 「セル幅を 30px にしてください」

なぜ: CSS変数は設計書で定義済み、固定値は縦軸整列を壊す

---

**3. 統合UIの構造**

なぜ: 責任範囲外（L3_UI_統合UI設計.mdの責任）

書き方: 「⚠️ カレンダーヘッダーは作成しないでください。理由: L3の責任範囲です」

---

**詳細な判断基準**: GUIDE_実装指示書作成.md セクション3.5を参照

---

### 2.6 INDEX v2.0の活用

**なぜINDEX v2.0を確認するのか**:
- タスク別ナビゲーションで依存関係が分かる
- 責任分界マップで「作らないもの」が分かる
- 今回のミス（カレンダーヘッダーを通いグリッドに含めた）を防げる

**確認すべきこと**:
1. タスク別ナビゲーション（例: 「通いUI実装指示書を作成する」）
2. ドキュメント間の依存関係（例: L2_通い → L3_統合UI）
3. 責任分界マップ（例: カレンダーヘッダーは統合UIの責任）

**詳細**: GUIDE_実装指示書作成.md ステップ0.5を参照

---

## 3. LLM誤解予測レビュー

### 3.1 なぜLLM誤解予測が必要か

**GitHub Copilotの「効率化の誘惑」**:
- 優秀なプログラマーだからこそ、効率化したくなる
- 共通化、汎用化、DRY原則を適用したくなる
- しかし、それが設計思想（セクション独立性）と矛盾する

**誤実装を先回りして防ぐ**:
- 警告セクションで「やってはいけないこと」を明記
- 理由を説明することで、納得して実装できる

---

### 3.2 効率化の誘惑5パターン

```
誘惑1: モーダルを作る
  理由: セルクリックで編集するなら、モーダルが便利

誘惑2: ライブラリを導入する
  理由: jQueryやReactがあれば楽

誘惑3: 仕様を簡略化する
  理由: タブ別3行より、共通5行の方が簡単

誘惑4: 重複コードを削除する
  理由: カレンダーヘッダーが重複しているから統合

誘惑5: CSS変数を無視する
  理由: 固定値の方が書きやすい
```

**詳細な説明**: GUIDE_LLM誤解予測レビュー.md を参照

---

### 3.3 警告セクションの役割

**警告セクションは誤実装を防ぐための最後の砦**

**必須要素**:
```
❌ やってはいけないこと
✅ やること
💡 理由
```

**なぜ理由が必要か**: 実装者が納得して実装できる

**具体的な書き方**: GUIDE_実装指示書作成.md セクション3.4を参照

---

## 4. レビュー方法

### 4.1 なぜレビューが必要か

**設計レビュー**:
- 曖昧さを排除するため
- 実装前に問題を発見するため
- 実装コストを削減するため

**実装レビュー**:
- 設計書との整合性を確認するため
- 警告が守られているか確認するため
- 誤実装パターンを記録し、次回に活かすため

---

### 4.2 レビューのポイント

**設計レビュー**:
```
□ 曖昧な表現がないか
□ データ型が明示されているか
□ インタラクションが詳細か
□ 状態遷移図があるか
□ テストケースがあるか
```

**詳細**: CHECKLIST_設計レビュー.md を参照

---

**実装レビュー**:
```
□ 設計書通りに実装されているか
□ 警告セクションが守られているか
□ 横スクロールが発生していないか
□ 縦軸が揃っているか
□ 定員チェックが正しいか
```

---

### 4.3 ギャップ分析の目的

**なぜギャップ分析が必要か**:
- 設計書の曖昧さを特定するため
- 警告の不足を特定するため
- 次回の実装指示書を改善するため

**手順**:
```
1. ズレの内容を明確にする
2. ズレの原因を特定する
3. 修正指示書を作成
4. 設計書・実装指示書を改善
```

---

## 5. 引継ぎルール

### 5.1 なぜ引継ぎドキュメントが必要か

**チャット切り替え時の情報ロス**:
- Claudeはチャットを切り替えると記憶がリセットされる
- 引継ぎドキュメントがないと、最初から説明が必要
- 作業効率が大幅に低下する

**引継ぎドキュメントの役割**:
- 現状を正確に伝える
- 必読ドキュメントを明示する
- 次のタスクを明確にする

---

### 5.2 引継ぎドキュメントの必須要素

```
1. プロジェクトの現状（何が完成、未完成、課題）
2. 必ず読むべきドキュメント（読む順序、理由、所要時間）
3. 読まなくていいドキュメント（理由）
4. 次のタスク（具体的な作業内容、注意点）
5. 重要な判断事項（ユーザーに確認すべきこと）
```

**詳細**: GUIDE_引継ぎドキュメント作成ルール.md を参照

---

### 5.3 必読ドキュメントの明示が重要な理由

**悪い例**: 「L0層を全部読んでください」
- 問題: 6文書（約6,000行）を読むのに時間がかかる

**良い例**: 「L0_業務_定員の法的枠組み.md を読んでください（理由: 定員チェックのロジックに必須、所要時間: 10分）」
- メリット: 必要なドキュメントだけを読める

---

## 📚 関連ドキュメント

- **GUIDE_実装指示書作成.md**: 実装指示書の具体的な書き方、テンプレート、チェックリスト
- **CHECKLIST_設計レビュー.md**: 設計レビューの詳細チェックリスト
- **GUIDE_LLM誤解予測レビュー.md**: LLM誤解予測レビューの詳細ガイド
- **GUIDE_引継ぎドキュメント作成ルール.md**: 引継ぎドキュメントの詳細ルール
- **INDEX_ドキュメント構成.md**: タスク別ナビゲーション、依存関係、責任分界マップ

---

## 📅 更新履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|----------|---------|------|
| 2025-12-08 | 1.0 | 初版作成（L1_概要_プロジェクト概要 v2.0 セクション6から独立） | Claude |
| 2025-12-08 | 1.1 | GitHub Copilotが設計書を直接読めることを反映、実装指示書の書き方を修正 | Claude |
| 2025-12-17 | 2.0 | 原則（WHY）に集中、GUIDE_実装指示書作成.mdとの役割分担明確化、INDEX v2.0活用追加 | Claude |

---

**最終更新**: 2025年12月17日  
**次回更新予定**: 新しい原則が確立された時、または重大な問題が発見された時

---

## 💡 このドキュメントの活用方法

### 設計書を作成する前

- **セクション1「設計品質の5原則」を確認**
- 曖昧さを排除する意識を持つ

### 実装指示書を作成する時

- **セクション2「実装指示書の原則」を確認**
- GUIDE_実装指示書作成.md を参照して具体的に書く

### LLM誤解予測レビューを実施する時

- **セクション3「LLM誤解予測レビュー」を確認**
- GUIDE_LLM誤解予測レビュー.md を参照して警告を作成

### 実装をレビューする時

- **セクション4「レビュー方法」を確認**
- 設計書とのギャップを分析

### チャットを切り替える時

- **セクション5「引継ぎルール」を確認**
- GUIDE_引継ぎドキュメント作成ルール.md を参照して引継ぎドキュメントを作成

---

**このドキュメントを読了したら、GUIDE_実装指示書作成.md で具体的な手順を確認してください。**