# L1_技術_技術仕様

**作成日**: 2025年11月23日  
**カテゴリ**: 第1層 - プロジェクト共通  
**バージョン**: 1.0

---

## 📖 このドキュメントについて

このドキュメントは、**プロジェクトBの技術的な仕様**を定義します。

### 対象読者

- プロジェクトBの開発メンバー全員
- 技術選定の意思決定者
- 新規参加メンバー

### 読了後に理解できること

- 使用技術スタックとその選定理由
- アーキテクチャの全体像
- Phase別の実装方針
- 開発環境のセットアップ方法
- デプロイ戦略

### このドキュメントと他ドキュメントの関係

```
L1_技術_技術仕様.md（このドキュメント）
  ↓ 技術スタックを定義
L1_技術_実装制約.md
  ↓ 実装ルールを定義
L2_各セクション_設計.md
  ↓ 詳細設計
実装
```

---

## 1. 技術スタック

### 1.1 Phase 1（ローカル環境）

#### フロントエンド

| 技術 | バージョン | 選定理由 |
|------|----------|---------|
| **HTML5** | 最新 | 標準仕様 |
| **CSS3** | 最新 | スタイリング |
| **JavaScript（ES2022+）** | 最新 | モダンな構文を活用 |
| **Vanilla JS** | - | フレームワーク不要（シンプル） |

**重要**: Phase 1ではフレームワーク（React, Vue等）は使用しない

---

#### 理由

**シンプルさを優先**

```
メリット:
✅ 学習コストが低い
✅ バンドルツール不要
✅ 即座に実行可能
✅ GitHub Copilotとの相性が良い

デメリット:
❌ 大規模化すると管理が難しい
→ Phase 2で検討
```

---

#### データ永続化

| 技術 | 用途 | 容量制限 |
|------|------|---------|
| **localStorage** | マスタデータ、予定データ | 5-10MB程度 |

**Phase 2以降**: IndexedDB または サーバー連携

---

#### 開発ツール

| ツール | 用途 |
|--------|------|
| **VS Code** | 統合開発環境 |
| **GitHub Copilot** | コード生成支援 |
| **Claude** | 設計支援、レビュー |
| **Live Server** | ローカルサーバー |

---

### 1.2 Phase 2（サーバー連携）

#### バックエンド（検討中）

| 技術候補 | メリット | デメリット |
|---------|---------|----------|
| **Node.js + Express** | JavaScript統一、学習コスト低 | - |
| **Python + Flask** | AI連携しやすい | 言語が増える |
| **Firebase** | インフラ不要、リアルタイム同期 | ベンダーロック |

**Phase 1終了後に決定**

---

#### データベース（検討中）

| 技術候補 | メリット | デメリット |
|---------|---------|----------|
| **SQLite** | セットアップ不要、軽量 | 同時書き込みに弱い |
| **PostgreSQL** | 高機能、拡張性高い | セットアップ必要 |
| **Firebase Realtime DB** | リアルタイム同期 | NoSQL（設計変更必要） |

---

### 1.3 Phase 3（AI連携）

#### AI/ML

| 技術候補 | 用途 |
|---------|------|
| **Claude API** | 調整提案、最適化 |
| **OpenAI API** | 代替候補 |
| **ローカルLLM** | プライバシー重視の場合 |

**Phase 2の実装状況を見て決定**

---

## 2. アーキテクチャ

### 2.1 全体構成

#### Phase 1

```
┌───────────────────────────────────────┐
│         ブラウザ（Chrome等）           │
├───────────────────────────────────────┤
│  HTML/CSS/JavaScript                  │
│  ┌─────────────────────────────────┐ │
│  │  共通データ管理                  │ │
│  │  - MasterDataManager             │ │
│  │  - User, Staff, Room             │ │
│  ├─────────────────────────────────┤ │
│  │  セクション（独立）               │ │
│  │  ┌──────┬──────┬──────┐       │ │
│  │  │ 通い │泊まり│ 訪問 │       │ │
│  │  └──────┴──────┴──────┘       │ │
│  ├─────────────────────────────────┤ │
│  │  localStorage（データ永続化）    │ │
│  └─────────────────────────────────┘ │
└───────────────────────────────────────┘
```

---

#### Phase 2

```
┌───────────────────────────────────────┐
│         ブラウザ                       │
│  ┌─────────────────────────────────┐ │
│  │  フロントエンド                  │ │
│  │  - HTML/CSS/JavaScript          │ │
│  └─────────────────────────────────┘ │
└──────────────┬────────────────────────┘
               │ REST API / WebSocket
┌──────────────┴────────────────────────┐
│         サーバー                       │
│  ┌─────────────────────────────────┐ │
│  │  バックエンド                    │ │
│  │  - API Server                   │ │
│  │  - ビジネスロジック              │ │
│  ├─────────────────────────────────┤ │
│  │  データベース                    │ │
│  │  - マスタデータ                  │ │
│  │  - トランザクションデータ        │ │
│  └─────────────────────────────────┘ │
└───────────────────────────────────────┘
```

---

### 2.2 ディレクトリ構造

#### Phase 1

```
project-b/
├─ index.html                    # メインHTML
├─ css/
│  ├─ common.css                 # 共通スタイル
│  ├─ kayoi.css                  # 通いセクション
│  ├─ tomari.css                 # 泊まりセクション
│  └─ houmon.css                 # 訪問セクション
├─ js/
│  ├─ main.js                    # エントリーポイント
│  ├─ common/
│  │  ├─ MasterDataManager.js   # マスタデータ管理
│  │  ├─ User.js                 # 利用者クラス
│  │  ├─ Staff.js                # 職員クラス
│  │  ├─ Room.js                 # 居室クラス
│  │  └─ utils/
│  │     ├─ DateUtils.js         # 日付ユーティリティ
│  │     ├─ ValidationUtils.js   # バリデーション
│  │     └─ StorageUtils.js      # localStorage操作
│  ├─ kayoi/
│  │  ├─ KayoiSection.js         # 通いセクションクラス
│  │  ├─ KayoiSchedule.js        # 通い予定データ
│  │  └─ KayoiUI.js              # 通いUI処理
│  ├─ tomari/
│  │  ├─ TomariSection.js        # 泊まりセクションクラス
│  │  ├─ TomariReservation.js    # 泊まり予約データ
│  │  └─ TomariUI.js             # 泊まりUI処理
│  └─ houmon/
│     ├─ HoumonSection.js        # 訪問セクションクラス
│     ├─ HoumonSchedule.js       # 訪問予定データ
│     └─ HoumonUI.js             # 訪問UI処理
├─ docs/                         # ドキュメント（このフォルダ）
└─ README.md                     # プロジェクト概要
```

---

### 2.3 モジュール設計

#### ES Modules の使用

```javascript
// main.js（エントリーポイント）
import { MasterDataManager } from './common/MasterDataManager.js';
import { KayoiSection } from './kayoi/KayoiSection.js';
import { TomariSection } from './tomari/TomariSection.js';
import { HoumonSection } from './houmon/HoumonSection.js';

// 初期化
const masterData = new MasterDataManager();
const kayoiSection = new KayoiSection(masterData);
const tomariSection = new TomariSection(masterData);
const houmonSection = new HoumonSection(masterData);

// アプリ起動
document.addEventListener('DOMContentLoaded', async () => {
  await masterData.initialize();
  kayoiSection.initialize();
  tomariSection.initialize();
  houmonSection.initialize();
});
```

---

#### HTML での読み込み

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>小規模多機能予定調整B</title>
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/kayoi.css">
  <link rel="stylesheet" href="css/tomari.css">
  <link rel="stylesheet" href="css/houmon.css">
</head>
<body>
  <div id="app">
    <header>...</header>
    <main>
      <section id="kayoi-section">...</section>
      <section id="tomari-section">...</section>
      <section id="houmon-section">...</section>
    </main>
  </div>
  
  <!-- ES Modules -->
  <script type="module" src="js/main.js"></script>
</body>
</html>
```

---

## 3. データフロー

### 3.1 Phase 1（ローカル環境）

#### 起動時のデータフロー

```
1. ページ読み込み
   ↓
2. main.js 実行
   ↓
3. MasterDataManager.initialize()
   - localStorage から User, Staff, Room を読み込み
   ↓
4. 各セクション.initialize()
   - localStorage から予定データを読み込み
   - UI を構築
   ↓
5. ユーザー操作可能
```

---

#### データ更新のフロー

```
1. ユーザー操作（予定追加等）
   ↓
2. セクションのメソッド実行
   - バリデーション
   - データ追加
   ↓
3. イベント発火
   - CustomEvent で他セクションに通知（必要な場合）
   ↓
4. localStorage に保存
   ↓
5. UI 更新
```

---

### 3.2 Phase 2（サーバー連携）

#### データフロー

```
1. フロントエンドでの操作
   ↓
2. API リクエスト
   - POST /api/kayoi/schedules
   ↓
3. サーバー側処理
   - バリデーション
   - DB 保存
   ↓
4. レスポンス
   - 成功/エラー
   ↓
5. フロントエンド更新
   - UI 反映
   - ローカルキャッシュ更新
```

---

## 4. パフォーマンス戦略

### 4.1 Phase 1

#### 目標

| 指標 | 目標値 |
|------|--------|
| **初回読み込み** | 2秒以内 |
| **操作レスポンス** | 100ms以内 |
| **グリッド描画** | 500ms以内（300セル程度） |

---

#### 最適化手法

**DOM操作の最小化**
```javascript
// ✅ DocumentFragment を使用
const fragment = document.createDocumentFragment();
cells.forEach(cell => fragment.appendChild(cell));
container.appendChild(fragment); // 1回のみ
```

**イベントデリゲーション**
```javascript
// ✅ 親要素で一括管理
grid.addEventListener('click', (e) => {
  const cell = e.target.closest('.cell');
  if (cell) handleCellClick(cell);
});
```

**キャッシュ戦略**
```javascript
// ✅ 計算結果をキャッシュ
class TomariSection {
  #occupancyCache = new Map();
  
  getRoomOccupancy(roomId, date) {
    const key = `${roomId}_${date}`;
    if (this.#occupancyCache.has(key)) {
      return this.#occupancyCache.get(key);
    }
    
    const result = this.calculate(roomId, date);
    this.#occupancyCache.set(key, result);
    return result;
  }
}
```

---

### 4.2 Phase 2

#### 追加の最適化

- **遅延読み込み**: 表示中の月のみデータ取得
- **差分更新**: 変更部分のみサーバーに送信
- **WebSocket**: リアルタイム同期（複数ユーザー対応）
- **Service Worker**: オフライン対応

---

## 5. セキュリティ

### 5.1 Phase 1（ローカル環境）

#### 考慮事項

| 項目 | 対応 |
|------|------|
| **XSS対策** | textContent を使用、innerHTML は避ける |
| **データ検証** | クライアント側バリデーション |
| **localStorage** | 機密情報は保存しない |

**注意**: Phase 1はローカル環境のみ、認証・認可は不要

---

### 5.2 Phase 2（サーバー連携）

#### 追加の対策

| 項目 | 対応 |
|------|------|
| **認証** | JWT または セッション認証 |
| **認可** | ロールベースアクセス制御（RBAC） |
| **CSRF対策** | トークン検証 |
| **SQL Injection** | プリペアドステートメント |
| **HTTPS** | TLS 1.3 以上 |

---

## 6. テスト戦略

### 6.1 Phase 1

#### テストレベル

```
テストピラミッド
       /\
      /  \   E2E（手動）
     /────\
    /      \  統合テスト（一部）
   /────────\
  /          \ 単体テスト（主力）
 /────────────\
```

---

#### 単体テスト

**ツール**: なし（Phase 1では手動テスト）

**Phase 2以降**: Jest または Vitest を検討

**テスト対象**:
```javascript
// 各クラスのメソッド
describe('KayoiSchedule', () => {
  test('バリデーション: 日付が必須', () => {
    const schedule = new KayoiSchedule({ userId: 'user001' });
    const result = schedule.validate();
    expect(result.valid).toBe(false);
  });
});
```

---

#### E2Eテスト

**Phase 1**: 手動テスト（チェックリスト）

**Phase 2以降**: Playwright または Cypress を検討

---

### 6.2 テストチェックリスト（Phase 1）

#### 通いセクション

- [ ] 予定追加（○、◓、◒の切り替え）
- [ ] 前半・後半の定員チェック
- [ ] 記号の遷移順序（○→◓→◒→空欄）
- [ ] 右クリックメニュー（クリア）
- [ ] 月の切り替え

#### 泊まりセクション

- [ ] 予約追加（期間選択）
- [ ] 期間重複チェック
- [ ] 定員チェック（9人/日）
- [ ] 居室の視覚化

#### 訪問セクション

- [ ] 訪問追加（時間帯選択）
- [ ] 厳守時刻の入力
- [ ] 移動時間の警告表示
- [ ] 複数訪問の表示

---

## 7. 開発環境のセットアップ

### 7.1 必要なツール

#### Phase 1

| ツール | バージョン | インストール方法 |
|--------|----------|----------------|
| **VS Code** | 最新 | https://code.visualstudio.com/ |
| **Live Server** | 最新 | VS Code拡張機能 |
| **GitHub Copilot** | 最新 | VS Code拡張機能（サブスクリプション必要） |

---

### 7.2 セットアップ手順

#### 1. リポジトリのクローン

```bash
git clone https://github.com/your-org/project-b.git
cd project-b
```

#### 2. VS Code で開く

```bash
code .
```

#### 3. Live Server の起動

1. VS Code で `index.html` を開く
2. 右クリック → "Open with Live Server"
3. ブラウザが自動で開く（http://localhost:5500）

---

### 7.3 ブラウザ要件

#### 対応ブラウザ

| ブラウザ | バージョン |
|---------|----------|
| **Chrome** | 最新版（推奨） |
| **Edge** | 最新版 |
| **Firefox** | 最新版 |
| **Safari** | 最新版 |

**注意**: IE11 は非対応

---

## 8. デプロイ戦略

### 8.1 Phase 1（ローカル配布）

#### 配布方法

**方法1: ZIP配布**
```
1. プロジェクトを ZIP 圧縮
2. 利用者に配布
3. 解凍して index.html をブラウザで開く
```

**方法2: GitHub Pages**
```bash
# GitHub Pages にデプロイ
git push origin main

# Settings > Pages で有効化
# https://your-org.github.io/project-b/
```

---

### 8.2 Phase 2（サーバーデプロイ）

#### デプロイ先候補

| サービス | メリット | デメリット |
|---------|---------|----------|
| **Vercel** | 無料枠あり、自動デプロイ | ベンダーロック |
| **Netlify** | 無料枠あり、簡単 | ベンダーロック |
| **AWS** | 拡張性高い | 複雑、コスト |
| **オンプレミス** | データ管理可能 | 運用コスト |

**Phase 1終了後に決定**

---

## 9. 移行戦略（Phase 1 → Phase 2）

### 9.1 データ移行

```
Phase 1（localStorage）
  ↓ エクスポート
JSONファイル
  ↓ インポート
Phase 2（サーバー）
```

#### エクスポート機能

```javascript
function exportData() {
  const data = {
    users: loadUsers(),
    staff: loadStaff(),
    rooms: loadRooms(),
    kayoiSchedules: loadKayoiSchedules(),
    tomariReservations: loadTomariReservations(),
    houmonSchedules: loadHoumonSchedules()
  };
  
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = 'project-b-data.json';
  a.click();
}
```

---

### 9.2 コードの移行

**変更が必要な箇所**:
1. データ永続化層（localStorage → API）
2. 認証・認可の追加
3. エラーハンドリングの強化

**変更不要な箇所**:
1. データクラス（User, KayoiSchedule等）
2. ビジネスロジック（定員チェック等）
3. UI コンポーネント（グリッド表示等）

---

## 10. モニタリング（Phase 2以降）

### 10.1 ログ収集

```javascript
// エラーログ
window.addEventListener('error', (event) => {
  logError({
    message: event.message,
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno,
    error: event.error
  });
});

// パフォーマンスログ
const perfData = performance.timing;
const loadTime = perfData.loadEventEnd - perfData.navigationStart;
logPerformance({ loadTime });
```

---

### 10.2 分析

- **アクセス解析**: Google Analytics（検討中）
- **エラートラッキング**: Sentry（検討中）
- **パフォーマンス**: Lighthouse

---

## 11. まとめ

### 11.1 技術選定の方針

```
Phase 1: シンプルさ優先
  ├─ Vanilla JS（フレームワーク不要）
  ├─ localStorage（サーバー不要）
  └─ 手動テスト

Phase 2: 拡張性重視
  ├─ サーバー連携（認証・同期）
  ├─ データベース（永続化）
  └─ 自動テスト

Phase 3: AI連携
  └─ 調整提案、最適化
```

---

### 11.2 このドキュメントで定義したこと

```
✅ 定義したこと
├─ 技術スタック（Phase 1～3）
├─ アーキテクチャ（全体構成）
├─ ディレクトリ構造
├─ データフロー
├─ パフォーマンス戦略
├─ セキュリティ対策
├─ テスト戦略
├─ 開発環境セットアップ
├─ デプロイ戦略
└─ 移行戦略
```

---

### 11.3 次のステップ

技術仕様が確定したので、実装に進むことができます。

**実装前に確認すべきドキュメント**:
1. **L1_技術_実装制約.md** - コーディング規約
2. **L1_データ_共通データ構造.md** - マスタデータ
3. **L2_各セクション_データ構造.md** - 詳細設計

**実装の順序**:
1. 共通部分（MasterDataManager, User, Staff, Room）
2. 通いセクション
3. 泊まりセクション
4. 訪問セクション
5. 統合

---

## 📚 次に読むべきドキュメント

このドキュメントを読了したら、以下のドキュメントに進んでください。

### 関連ドキュメント

- **L1_技術_実装制約.md** - コーディング規約（必読）
- **L1_データ_共通データ構造.md** - マスタデータ構造
- **L1_概要_プロジェクト概要.md** - プロジェクトの背景と目的

---

## 📝 参考資料

- MDN Web Docs（JavaScript リファレンス）
- VS Code ドキュメント
- GitHub Copilot ドキュメント

---

## 📅 更新履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|----------|---------|------|
| 2025-11-23 | 1.0 | 初版作成 | Claude |

---

**最終更新**: 2025年11月23日  
**次回更新予定**: Phase 1実装開始後、技術的な問題が発見された時

---

## 💡 このドキュメントの活用方法

### 技術選定時

- **Phase 1の技術スタック**: Vanilla JS + localStorage
- **Phase 2の候補**: Node.js, PostgreSQL, Firebase等
- **選定理由**: シンプルさ、学習コスト、拡張性

### 開発環境構築時

- **必要ツール**: VS Code, Live Server, GitHub Copilot
- **セットアップ手順**: リポジトリクローン → VS Code で開く → Live Server 起動

### デプロイ時

- **Phase 1**: GitHub Pages または ZIP 配布
- **Phase 2**: Vercel, Netlify, AWS等を検討

---

**このドキュメントを読了したら、INDEX_ドキュメント構成.md に戻り、次のドキュメントに進んでください。**
