# L1_制約ゲーム_全体設計

**作成日**: 2025年12月13日  
**カテゴリ**: 第1層 - 基礎  
**バージョン**: 1.1  
**更新日**: 2025年12月13日  
**根拠**: セッション記録 2025-12-10「制約ゲーム設計確定」、2025-12-13「カラーグラデーション確定」

---

## 📖 このドキュメントについて

このドキュメントは、**プロジェクトBの核心である「制約ゲーム」の全体設計**を定義します。

### 対象読者

- プロジェクトBの設計担当者
- 実装担当者
- プロジェクトオーナー

### 読了後に理解できること

- なぜ「ゲーム」として設計するのか
- 基準線と充填率の計算方法（確定事項）
- カラーコーディングの設計（確定事項）
- 制約の操作性と充足判定
- Phase別の実装方針

### 確度を示す記号

このドキュメントでは、以下の記号で確度を明示します：

| 記号 | 意味 | 使用条件 |
|------|------|---------|
| 📌【確定】 | 確定事項（変更しない） | セッション記録で確定、法令で規定、ユーザーが明言 |
| 💭【提案】 | 提案・アイディア（議論の余地あり） | Claudeの提案、「いいかも」レベルの発言 |
| 🤔【要議論】 | 要議論（まだ決まっていない） | 疑問符が残った、実装時に判断が必要 |
| 📚【参考】 | 参考情報 | 背景知識、補足説明 |
| 🗑️【廃案】 | 検討したが不採用 | 議論の過程で否定された案 |

---

## 1. 📌【確定】制約ゲームとは

### 1.1 プロジェクトBの本質

小規模多機能型居宅介護の利用調整業務は、**制約パズル**です。

```
同時に満たすべき制約：
├─ 登録定員29人
├─ 通い定員15人（前半・後半別）
├─ 泊まり定員9人
├─ 夜勤1人体制のリスク
├─ 職員配置基準
├─ 過少サービス減算（週4回未満）
├─ 利用者の希望
├─ 送迎ルート
└─ 突発的な変更

→ これらを同時に満たす「解」を見つける
```

**根拠**: セッション記録 2025-12-10、L0_業務_調整業務の制約.md

---

### 1.2 なぜ「ゲーム」なのか

**従来のシステムとの違い**:

```
従来のシステム：
「業務を効率化する」
  ↓
義務感、負担感
  ↓
使いたくない

プロジェクトB：
「パズルを解く」
  ↓
達成感、楽しさ
  ↓
使いたくなる
```

**重要**: 制約を敵ではなく、パズルの「ルール」として捉える

---

### 1.3 📌【確定】ゴールと主指標

**セッション記録 2025-12-10で確定**

#### ゴール

```
登録率100%を目指しながら、
過少サービス減算を回避し、
リソースを最適に活用する
```

#### Phase 1の主指標

```
【主指標】機会損失の削減
現状：月○件の機会損失
目標：月0件

【副指標】
1. 登録率：100%を目指す
2. 平均サービス提供回数：週4.5回以上/人
3. 空き状況確認時間：5秒以内
4. 定員チェック精度：自動化100%
```

---

### 1.4 🗑️【廃案】Claudeの初期誤解

**廃案となった考え方**:

```
❌ 登録率85-90%が適正範囲
❌ 100%だと新規受入不可で問題

正しい理解：
✅ 登録率100%が理想（常に満杯を目指す）
✅ 登録率が100%未満になる理由：
   - 【A】需要不足（営業課題）
   - 【B】供給制約 ← プロジェクトBが解決
```

**廃案理由**: 「利用の問い合わせが続いているにもかかわらず登録率100%を阻むものがあるとすれば空き状況だ」（ユーザー発言）

---

### 1.5 🗑️【廃案】転換率という指標

**廃案となった指標**:

```
転換率 = 登録成功 ÷ 問い合わせ件数

問題：人気施設ほど低くなる（逆説的）
```

**代替案（採用）**:

```
機会損失 = 受入可能だったのに断った件数

例：「泊まり満室」と言ったが、実は特定日だけ
→ プロジェクトBで減らすべき指標
```

**廃案理由**: 「機会損失率を減らすのは分かりやすい。しかし直感的ではない（後から分析でわかること？）ので、制約ゲームというコンセプトにどうあてはめられますか？」（ユーザー発言）

→ リアルタイムで分かる「制約充足率」を採用

---

## 2. 📌【確定】制約の可視化：基準線と充填率

### 2.1 基準線の定義

**セッション記録 2025-12-10で確定**

#### 基準線の計算方法（統一ルール）

```javascript
基準線 = 定員（またはリソース量） × 登録率

例：登録20人（登録率80%）の場合
├─ 通い基準線：15人 × 0.8 = 12人/日
├─ 泊まり基準線：5人 × 0.8 = 4人/日
└─ 訪問基準線：1.5人日 × 0.8 = 1.2人日/日
```

**重要な原則**:
- 基準線 = 定員 × 登録率
- 登録率が変わると基準線も変わる（動的）
- リアルタイムで「パズルの難易度」が見える

---

### 2.2 充填率の定義

**セッション記録 2025-12-10で確定**

#### 充填率の計算

```javascript
充填率 = 実績 ÷ 基準線

例：通い基準線12人、実績11人
充填率 = 11 ÷ 12 = 92%
```

#### 判定単位

- **日別判定**を採用（確定）
- 月平均はPhase 2以降の分析機能

---

### 2.3 📚【参考】基準線の本質

```
基準線は「期待値」ではなく「適切な使用量」

- 基準線内：適切に使えている
- 基準線超え：使いすぎ（許容はする）
- 定員超え：ルール違反
```

**根拠**: セッション記録での議論

---

### 2.4 📚【参考】離散値と連続値

```
人数（離散値）：
- 14.25人は存在しない
- グラデーションで誤差を吸収

時間（連続値）：
- 7時間36分は存在する
- 細かい管理が可能
```

**通いと泊まりは離散値、訪問は連続値**という違いがあるが、基準線の考え方は統一。

---

## 3. 📌【確定】カラーコーディング

### 3.1 📌【確定】カラースキーム

**セッション記録 2025-12-10で議論、2025-12-13で確定**

```
🔵 80-100%：青系グラデーション（5-6段階）
       ├─ 80%未満：薄い青グレー（余裕あり）
       ├─ 80-85%：青グレー
       ├─ 85-90%：青
       ├─ 90-95%：濃い青
       └─ 95-100%：最濃い青（理想に到達！）

🟡 100%超〜定員：黄色 + 2px枠
   基準超えだけど許容範囲

🔴 定員超：赤 + 4px二重枠
   アウト、ルール違反
```

**色覚特性対応**：
- 明度差で主に区別（明度：85% → 70% → 60% → 55% → 50%）
- 色は補助的
- 重要な警告（100%超、定員超）は枠線で強調

---

### 3.2 特殊ケース（登録率100%）

```
基準線 = 定員の場合
→ 定員超えたら即座に赤
→ 黄色ゾーンをすっ飛ばす
```

**理由**: 「ピッタリとオーバーって全然違うと思うんです」（ユーザー発言）

---

### 3.3 📌【確定】グラデーションの実装詳細

**2025-12-13確定**

#### HSL色空間での実装（5-6段階、明度ベース）

```javascript
// ゾーン閾値（Settingsで変更可能）
const ZONE_THRESHOLDS = {
  GRADIENT_START: 0.80,     // 80%からグラデーション開始（デフォルト）
  BASELINE_TARGET: 1.00,    // 100%が理想（基準線）
}

// 判定ロジック
function getColorAndBorder(actual, baseline, capacity) {
  const ratio = actual / baseline;
  
  // 定員超過
  if (actual > capacity) {
    return { 
      backgroundColor: 'hsl(0, 100%, 90%)',      // 薄い赤
      border: '4px double hsl(0, 100%, 50%)',    // 二重枠
      class: 'over-capacity'
    };
  }
  
  // 基準線超過（定員以内）
  if (ratio > 1.0) {
    return { 
      backgroundColor: 'hsl(45, 100%, 85%)',     // 薄い黄色
      border: '2px solid hsl(45, 100%, 50%)',    // 枠線
      class: 'over-baseline'
    };
  }
  
  // グラデーション範囲（80-100%）
  if (ratio >= ZONE_THRESHOLDS.GRADIENT_START) {
    const progress = (ratio - 0.80) / 0.20;      // 0.0 → 1.0
    
    // 明度を段階的に変化（85% → 50%）
    const lightness = 85 - (35 * progress);
    
    // 彩度も段階的に変化（30% → 60%）
    const saturation = 30 + (30 * progress);
    
    return { 
      backgroundColor: `hsl(200, ${saturation}%, ${lightness}%)`,
      border: 'none',
      class: 'in-gradient'
    };
  }
  
  // 80%未満（余裕あり）
  return { 
    backgroundColor: 'hsl(200, 30%, 85%)',       // 薄い青グレー
    border: 'none',
    class: 'plenty'
  };
}
```

#### 色覚特性への配慮

```
主な判別要素：明度差（85% → 70% → 60% → 55% → 50%）
補助要素：色相（青系）
重要な警告：枠線（2px、4px二重枠）

利点：
- 色弱の方でも明暗で判別可能
- 枠線で重要度を強調
- 通常モードと色覚特性モードを分ける必要なし
```

---

### 3.4 📌【確定】ゾーン境界の設定

**2025-12-13確定**

#### デフォルト値と設定範囲

```
デフォルト：80%
設定範囲：50%-90%

理由：
- 登録20人（80%）の場合、通い16人で色づき始める
- 登録25人（86%）の場合、通い20人で色づき始める
- 70%だと早すぎる、80%がちょうどよい
```

#### Settings画面での設定

```
Phase 1から実装：
- ゾーン境界をSettings画面で変更可能
- 事業所ごとに設定を保存
- 全サービス（通い・泊まり・訪問）共通の設定値
```

---

## 4. 📌【確定】訪問リソースの管理方法

### 4.1 人日（person-day）ベースの管理

**セッション記録 2025-12-10で確定**

```
訪問リソース = X人日/日
1人日 = 8時間

例：訪問リソース1.5人日/日
= 12時間/日の訪問キャパシティ

訪問基準線 = 訪問リソース × 登録率
例：1.5人日 × 80% = 1.2人日/日（9.6時間）
```

**利点**:
- 通い・泊まりと統一的な考え方
- 個人を追わず、数的リソースで管理
- 時間の計算は連続値なので細かく管理可能

---

### 4.2 利用者＆訪問内容ごとの時間キャッシュ

```javascript
// 利用者＆訪問内容ごとに時間をキャッシュ
cache = {
  "Aさん-身体介護": 60分,
  "Aさん-生活援助": 30分,
  "Bさん-身体介護": 45分,
  ...
}
```

**Phase 1での実装**:
- 時間帯別管理（朝・昼・夕・夜）
- 所要時間の入力
- リソース総量の自動計算

---

## 5. 📌【確定】制約の操作性（パズルとして解く）

### 5.1 試行錯誤の容易さ

```
✅ Ctrl+Z（元に戻す）
  - 履歴スタックで管理
  - 何度でもやり直せる

✅ ドラッグ移動
  - セル間の移動
  - 日付の変更が簡単

✅ 即座のフィードバック（0.2秒）
  - transition: all 0.2s ease
  - 色が即座に変わる
```

**重要**: 「試してみる→ダメだった→戻す」が簡単

---

### 5.2 履歴管理

```
変更履歴の記録：
  11/20 10:30 利用者A 通い→泊まりに変更（担当：山田）
  11/21 14:15 利用者B 訪問追加（担当：田中）
  11/22 09:00 利用者C 泊まりキャンセル（担当：山田）

→ いつでも振り返り可能
→ トラブル時の確認
→ モニタリングの資料
```

**Phase 1での実装**:
- Ctrl+Zのための履歴スタック
- Phase 2で永続化と詳細記録

---

## 6. 📌【確定】制約の充足判定（ルール違反の検出）

### 6.1 定員チェック

```
通い定員: 前半15人、後半15人（それぞれ独立）
泊まり定員: 9人/日
訪問: 定員制限なし（リソース制約のみ）
```

**自動化率100%**（Phase 1の成功基準）

---

### 6.2 過少サービス減算チェック

**L0_業務_定員の法的枠組み.md v1.1で追加**

```
登録者1人当たり平均回数 = 
  (月間サービス提供回数合計 ÷ 当該月の日数 ÷ 登録者数) × 7

基準：週4回以上
減算：週4回未満の場合、所定単位数の70%（実質30%減）
```

**Phase 1での実装**:
- 月間集計機能
- 警告表示（週4回未満になりそうな利用者）

**Phase 2での拡張**:
- 自動計算
- 予測機能（このままだと減算対象になる）

---

### 6.3 💭【提案】夜勤負担度の表示

**L0_業務_居室管理の重要性.md に記載あり**

```
利用者ごとにリスク情報を登録：
  ├─ 夜間徘徊リスク: あり/なし
  ├─ 夜間不穏: あり/なし
  ├─ 医療的ケア: あり/なし
  └─ 要介護度: 1〜5

日付ごとに「夜勤負担度」を自動算出：
  11月25日（月）: ★★☆☆☆（やや軽い）
  11月26日（火）: ★★★★★（非常に重い）
  11月27日（水）: ★★★☆☆（標準的）
```

**Phase 2以降で実装**

---

## 7. 制約ゲームとしての体験設計

### 7.1 📌【確定】リアルタイム指標

```
制約充足スコア（日別）：
├─ カレンダーでパズルボードを俯瞰
├─ 色分けで制約の厳しさを可視化
└─ リアルタイムで制約チェック

調整担当者の体験：
「この日は青いから余裕がある」
「この日は黄色いから基準超えてる」
「この日は赤いからアウト」
```

---

### 7.2 📚【参考】制約ゲームの直感性

```
機会損失率：後から分かる（事後分析）
制約充足率：今分かる（リアルタイム）

→ リアルタイムフィードバックが重要
```

**従来の「稼働率」との違い**:
- 稼働率：定員を基準（固定値）
- 充填率：基準線を基準（動的、登録率に応じて変化）

---

## 8. Phase別の実装

### 8.1 📌【確定】Phase 1: 可視化と基本操作（4-6ヶ月）

```
✅ 3セクションの月別予定表
  ├─ 通いセクション（利用者×日付）
  ├─ 泊まりセクション（居室×日付）
  └─ 訪問セクション（時間帯×回数）

✅ 制約の可視化
  ├─ 基準線の計算
  ├─ 充填率の表示
  ├─ カラーグラデーション（70-100%）
  └─ 即フィードバック（0.2秒）

✅ 基本操作
  ├─ 予定の入力・編集・削除
  ├─ Ctrl+Z（元に戻す）
  └─ ドラッグ移動

✅ 定員チェック
  ├─ 自動化100%
  └─ 色分け表示

✅ ブラウザ完結
  ├─ サーバー不要
  ├─ localStorage（データ永続化）
  └─ オフラインで動作
```

**成功基準**:
```
✓ 1事業所で実運用開始
✓ 3セクションすべての月別予定表が紙から置き換わる
✓ 調整担当者が「使いやすい」と評価
✓ 定員チェックの自動化率100%
✓ 空き状況への回答時間：5-10分 → 5秒以内
```

---

### 8.2 💭【提案】Phase 2: 分析と警告（6-12ヶ月後）

```
目標: 複数デバイスでデータ共有、分析機能の追加

追加機能:
├─ バックエンドAPI
├─ データベース
├─ 認証機能
├─ 過少サービス減算の自動計算
├─ 機会損失の可視化
├─ 利用パターン分析
└─ 実績データの分析

期間: 3-6ヶ月
```

**重要**: Phase 1完成後、実運用のフィードバックを踏まえて判断

---

### 8.3 💭【提案】Phase 3: AI支援とゲーム化（12-18ヶ月後）

```
目標: 調整業務を本格的にゲーム化

追加機能:
├─ スコアリング（制約充足度の数値化）
├─ AI提案（最適な調整案の提示）
├─ 成長の可視化（習熟度グラフ）
├─ 送迎ルート最適化
└─ 予測機能（このままだと減算対象になる）

期間: 3-6ヶ月
```

---

## 9. Settings画面での設定

### 9.1 📌【確定】Phase 1で実装する設定項目

**2025-12-13更新**

```
Settings画面で設定可能：

1. ゾーン境界
   - グラデーション開始：80%（デフォルト）
   - 設定範囲：50%-90%
   - 全サービス（通い・泊まり・訪問）共通

2. 保存単位
   - 事業所ごとに設定を保存
   - localStorageに保存

3. 固定値（Phase 1では変更不可）
   - 基準線ターゲット：100%
```

---

### 9.2 💭【提案】Phase 2以降で追加する設定項目

```
訪問リソース設定：
├─ 訪問リソース総量：1.5人日/日（変更可能）
└─ 移動時間マトリックスの更新

夜勤負担度設定：
├─ リスク項目の重み付け
└─ 負担度の閾値

その他：
├─ 警告レベルの細かい設定
└─ 表示カスタマイズ
```

---

## 10. まとめ

### 10.1 📌【確定】制約ゲームの核心

```
1. 基準線 = 定員 × 登録率（動的）
2. 充填率 = 実績 ÷ 基準線
3. カラーグラデーション（80-100%：明度ベース青系5-6段階）
4. リアルタイムフィードバック（0.2秒）
5. 試行錯誤の容易さ（Ctrl+Z、ドラッグ）
```

これら5つが揃って初めて「制約ゲーム」が成立する。

---

### 10.2 📌【確定】Phase 1で達成すべきこと

```
主指標：機会損失の削減（月0件）

副指標：
1. 登録率100%を目指す
2. 平均サービス提供回数：週4.5回以上/人
3. 空き状況確認時間：5秒以内
4. 定員チェック精度：自動化100%
```

---

### 10.3 重要な学び

```
1. 基準線の本質
   基準線は「期待値」ではなく「適切な使用量」

2. 離散値と連続値
   人数（離散値）：グラデーションで誤差を吸収
   時間（連続値）：細かい管理が可能

3. 制約ゲームの直感性
   機会損失率：後から分かる（事後分析）
   制約充足率：今分かる（リアルタイム）
   → リアルタイムフィードバックが重要
```

---

## 📚 次に読むべきドキュメント

このドキュメントを読了したら、以下のドキュメントに進んでください。

### 関連ドキュメント

1. **L1_概要_プロジェクト概要.md**
   - プロジェクトBの全体像
   - 3人体制での協働

2. **L0_業務_定員の法的枠組み.md**
   - 定員の法令根拠
   - 過少サービス減算（v1.1）

3. **L0_業務_調整業務の制約.md**
   - 調整業務の本質
   - 稼働率の課題

4. **L2_通い_データ構造.md**
   - 通いセクションの実装
   - 基準線・充填率の適用例

---

## 📝 参考資料

- セッション記録「制約ゲーム設計確定」（2025-12-10）
- L0_業務_定員の法的枠組み.md v1.1
- 厚生労働省告示（令和6年度報酬改定）
- 介護ソフト「カイポケ」過少サービス減算の解説

---

## 📅 更新履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|----------|---------|------|
| 2025-12-13 | 1.0 | 初版作成（セッション記録を整理） | Claude |
| 2025-12-13 | 1.1 | カラーグラデーション確定（70%→80%、5-6段階、明度ベース）、Settings画面設計確定 | Claude |

---

**最終更新**: 2025年12月13日  
**次回更新予定**: Phase 1実装開始前のレビュー時

---

## 💡 このドキュメントの活用方法

### 設計時

- 基準線・充填率の計算ロジック設計
- カラーグラデーションのCSS設計
- 訪問リソース管理の設計

### 実装時

- 充填率計算関数の実装
- グラデーション表示の実装
- リアルタイム更新の実装

### レビュー時

- 📌【確定】事項が守られているか
- 💭【提案】事項の実装判断
- 🤔【要議論】事項のユーザー確認

---

**このドキュメントを読了したら、L2層のセクション別設計に進んでください。**