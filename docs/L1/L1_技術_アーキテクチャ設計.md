  # プロジェクトB - アーキテクチャ設計

**作成日**: 2025年11月23日  
**カテゴリ**: 設計補足資料  
**バージョン**: 1.0（誤認修正版）

---

## 📖 このドキュメントについて

このドキュメントは、**プロジェクトBのアーキテクチャ**を2つの視点から説明します：

1. **レイヤーアーキテクチャ図** - 共有と独立の境界を明確化
2. **データ共有マトリックス** - 何を共有、何を独立させるか

### 重要な前提（L0業務知識の確認）

```
【法令上の定員】
├─ 登録定員: 29人以下（全体）
├─ 通い定員: 15人（前半・後半それぞれ）
├─ 泊まり定員: 9人/日
└─ 訪問定員: なし

【重要】
「通い+泊まり+訪問≤25人」のような合算制約は存在しない
各サービスの定員は独立してカウント
```

**参照**: L0_業務_定員の法的枠組み.md

---

## 1. レイヤーアーキテクチャ図

### 1.1 全体構成

```
┌──────────────────────────────────────────────────┐
│                                                  │
│  【共有レイヤー】業務上の共有リソース              │
│                                                  │
│  ┌────────────────────────────────────────┐     │
│  │ 利用者マスタ（User）                    │     │
│  │  - 同じ人が通い・泊まり・訪問を利用     │     │
│  │  - 登録定員29人の管理                   │     │
│  └────────────────────────────────────────┘     │
│                                                  │
│  ┌────────────────────────────────────────┐     │
│  │ 職員マスタ（Staff）                     │     │
│  │  - 同じ職員が3サービスに対応            │     │
│  └────────────────────────────────────────┘     │
│                                                  │
│  ┌────────────────────────────────────────┐     │
│  │ 居室マスタ（Room）                      │     │
│  │  - 泊まりサービス固有だが共通管理       │     │
│  └────────────────────────────────────────┘     │
│                                                  │
│  ┌────────────────────────────────────────┐     │
│  │ 移動時間マトリックス                    │     │
│  │  - 訪問の移動時間計算                   │     │
│  │  - 通いの送迎にも将来的に使用可能       │     │
│  └────────────────────────────────────────┘     │
│                                                  │
│  ┌────────────────────────────────────────┐     │
│  │ MasterDataManager                       │     │
│  │  - 上記マスタデータの一元管理           │     │
│  └────────────────────────────────────────┘     │
│                                                  │
└──────────┬────────────┬────────────┬─────────────┘
           │            │            │
        参照のみ     参照のみ     参照のみ
           │            │            │
    ┌──────┴──────┬─────┴──────┬─────┴──────┐
    │             │            │            │
┌───┴──────────┐ ┌┴──────────┐ ┌┴──────────┐
│              │ │           │ │           │
│【実装レイヤー】│ │【実装レイヤー】│ │【実装レイヤー】│
│              │ │           │ │           │
│ 通いセクション│ │泊まりセクション│ │訪問セクション │
│              │ │           │ │           │
├──────────────┤ ├───────────┤ ├───────────┤
│データ:       │ │データ:    │ │データ:    │
│KayoiSchedule │ │TomariReser│ │HoumonSched│
│              │ │vation     │ │ule        │
│              │ │           │ │           │
│ロジック:     │ │ロジック:  │ │ロジック:  │
│・定員チェック│ │・定員チェック│ │・移動時間チェック│
│ 前半15人    │ │ 9人/日   │ │（定員なし）│
│ 後半15人    │ │・期間重複 │ │           │
│・バリデーション│ │・居室割当 │ │・バリデーション│
│              │ │           │ │           │
│UI:           │ │UI:        │ │UI:        │
│・月別予定表  │ │・居室軸予定表│ │・時間帯別予定表│
│・記号(○◓◒) │ │・記号(入○退)│ │・朝昼夕夜  │
│              │ │           │ │           │
└──────────────┘ └───────────┘ └───────────┘
       │               │              │
       └───────────────┴──────────────┘
                      │
                イベント駆動通信
              （直接依存なし）
                      │
              ┌───────┴────────┐
              │   EventBus     │
              │  (オプション)   │
              └────────────────┘
```

---

### 1.2 各レイヤーの役割

#### 共有レイヤー

| 要素 | 役割 | 利用セクション |
|------|------|--------------|
| **利用者マスタ** | 登録利用者の管理（29人以下） | 通い・泊まり・訪問 |
| **職員マスタ** | 職員情報の管理 | 通い・泊まり・訪問 |
| **居室マスタ** | 9室の居室情報管理 | 泊まり |
| **移動時間マトリックス** | 利用者間の移動時間 | 訪問（将来的に通いも） |
| **MasterDataManager** | マスタデータの一元管理 | 全セクション |

**重要**: 
- 共有レイヤーは「データの提供」のみ
- 定員チェックなどのビジネスロジックは含まない
- 各セクションは参照のみ（更新は管理機能で）

---

#### 実装レイヤー（各セクション）

| セクション | 独自データ | 独自ロジック | 独自UI |
|-----------|----------|------------|--------|
| **通い** | KayoiSchedule | 定員チェック（前半・後半） | 月別予定表 |
| **泊まり** | TomariReservation | 定員チェック（9人/日）、期間重複 | 居室軸予定表 |
| **訪問** | HoumonSchedule | 移動時間チェック | 時間帯別予定表 |

**重要**:
- 各セクションは他セクションのデータを直接参照しない
- イベント駆動で通信（必要な場合のみ）
- セクション固有の定員は独立してカウント

---

### 1.3 データの流れ

#### 起動時

```
1. アプリ起動
   ↓
2. MasterDataManager.initialize()
   - localStorage から利用者マスタ読み込み
   - localStorage から職員マスタ読み込み
   - localStorage から居室マスタ読み込み
   ↓
3. 各セクション.initialize()
   - 共有レイヤーのマスタデータを参照
   - localStorage から各セクションの予定データ読み込み
   - UI構築
   ↓
4. ユーザー操作可能
```

---

#### 予定追加時

```
1. ユーザーがセルをクリック
   ↓
2. セクションのバリデーション
   - 入力値チェック
   - セクション固有の定員チェック
   ↓
3. データ追加
   - KayoiSchedule / TomariReservation / HoumonSchedule
   ↓
4. イベント発火（オプション）
   - CustomEvent で他セクションに通知
   ↓
5. localStorage に保存
   ↓
6. UI更新
```

**重要**: 他セクションの定員は確認しない（独立しているため）

---

### 1.4 イベント駆動通信（オプション）

セクション間で情報共有が必要な場合のみ使用：

```javascript
// 通いセクション（送信側）
class KayoiSection {
  addSchedule(date, userId) {
    // データ追加
    this.schedules.push(newSchedule);
    
    // イベント発火（オプション）
    window.dispatchEvent(new CustomEvent('kayoi:scheduleAdded', {
      detail: { date, userId, section }
    }));
  }
}

// 泊まりセクション（受信側・オプション）
class TomariSection {
  constructor() {
    // 必要なら受け取る
    window.addEventListener('kayoi:scheduleAdded', (e) => {
      console.log('通いで予定追加:', e.detail);
      // 特に処理は不要（独立しているため）
    });
  }
}
```

**Phase 1では不要**:
- 各セクションは独立して動作
- イベント通信は将来的な拡張用

---

## 2. データ共有マトリックス

### 2.1 全体マトリックス

| データ/リソース | 通い | 泊まり | 訪問 | 共有方法 | 備考 |
|---------------|-----|-------|-----|---------|------|
| **利用者マスタ** | ✅ | ✅ | ✅ | MasterDataManager | 同じ人が複数サービス利用 |
| **職員マスタ** | ✅ | ✅ | ✅ | MasterDataManager | 同じ職員が対応 |
| **居室マスタ** | - | ✅ | - | MasterDataManager | 泊まり固有だが共通管理 |
| **移動時間マトリックス** | (将来) | - | ✅ | MasterDataManager | 訪問の移動時間 |
| **祝日カレンダー** | ✅ | ✅ | ✅ | MasterDataManager | 曜日表示に使用 |
| **登録定員29人** | ✅ | ✅ | ✅ | User.isActive | 全体での上限 |
| **通い定員15人** | ✅ | - | - | 独立カウント | 前半・後半それぞれ |
| **泊まり定員9人** | - | ✅ | - | 独立カウント | 1日あたり |
| **訪問定員** | - | - | - | なし | 法令上の定員なし |
| **予定データ** | 独立 | 独立 | 独立 | 各セクション | 相互参照なし |

---

### 2.2 詳細マトリックス

#### 利用者マスタ（User）

| プロパティ | 通い | 泊まり | 訪問 | 説明 |
|-----------|-----|-------|-----|------|
| userId | ✅ | ✅ | ✅ | 利用者の一意識別子 |
| name | ✅ | ✅ | ✅ | 利用者名（表示用） |
| displayName | ✅ | ✅ | ✅ | 短縮表示名 |
| isActive | ✅ | ✅ | ✅ | 登録定員29人のカウント |
| address | - | - | (将来) | 訪問時の移動時間計算 |
| latitude/longitude | - | - | (将来) | 訪問時の移動時間計算 |

**共有の理由**:
- 同じ山田さんが月曜は通い、火曜は泊まり、水曜は訪問
- 利用者情報の一元管理
- 登録定員29人は全体での上限

---

#### 職員マスタ（Staff）

| プロパティ | 通い | 泊まり | 訪問 | 説明 |
|-----------|-----|-------|-----|------|
| staffId | ✅ | ✅ | ✅ | 職員の一意識別子 |
| name | ✅ | ✅ | ✅ | 職員名 |
| isActive | ✅ | ✅ | ✅ | 勤務中の職員 |

**共有の理由**:
- 同じ職員が3サービスに対応
- Phase 2以降のシフト管理で必要

**Phase 1での使用**:
- 訪問セクションで担当職員を任意で記録

---

#### 居室マスタ（Room）

| プロパティ | 通い | 泊まり | 訪問 | 説明 |
|-----------|-----|-------|-----|------|
| roomId | - | ✅ | - | 居室の一意識別子 |
| name | - | ✅ | - | 居室名（例: "1号室"） |
| displayOrder | - | ✅ | - | グリッド表示順序 |
| isActive | - | ✅ | - | 使用可/不可 |

**泊まり固有だが共通管理の理由**:
- 将来的な拡張性（AI連携時に属性追加）
- マスタデータの一元管理

---

#### 移動時間マトリックス

| 使用セクション | 用途 | Phase 1 | Phase 2以降 |
|--------------|------|---------|------------|
| 訪問 | 訪問間の移動時間チェック | 一律20分 | 自動計算 |
| 通い | （将来）送迎ルート最適化 | 未使用 | 検討 |
| 泊まり | 未使用 | - | - |

---

#### 祝日カレンダー

| 使用セクション | 用途 | 実装 |
|--------------|------|------|
| 通い | 祝日の色分け表示 | 2025年固定 |
| 泊まり | 祝日の色分け表示 | 2025年固定 |
| 訪問 | 祝日の色分け表示 | 2025年固定 |

---

### 2.3 定員管理マトリックス

#### 定員の独立性

| 定員 | チェック箇所 | 他セクションへの影響 | 法令根拠 |
|------|------------|------------------|---------|
| **登録定員29人** | User.isActive のカウント | 全セクション共通 | 基準第66条第1項 |
| **通い定員15人** | 通いセクション独立 | なし | 基準第66条第2項 |
| **泊まり定員9人** | 泊まりセクション独立 | なし | 基準第66条第2項 |
| **訪問定員** | なし | なし | （規定なし） |

**重要**: 
- ❌ 「通い+泊まり+訪問≤25人」のような合算制約は存在しない
- ✅ 各サービスの定員は独立してカウント

---

#### 定員チェックの実装箇所

```javascript
// 通いセクション（独立）
class KayoiSection {
  checkCapacity(date, section) {
    const count = this.getCount(date, section);
    return count < 15; // 前半・後半それぞれ
  }
}

// 泊まりセクション（独立）
class TomariSection {
  checkCapacity(date) {
    const count = this.getCount(date);
    return count < 9; // 1日あたり
  }
}

// 訪問セクション（定員なし）
class HoumonSection {
  checkCapacity() {
    return true; // 定員なし
  }
}

// 登録定員（全体）
class MasterDataManager {
  checkRegisteredUsers() {
    const activeUsers = this.users.filter(u => u.isActive);
    return activeUsers.length <= 29;
  }
}
```

---

### 2.4 データの独立性マトリックス

| データ | 通い | 泊まり | 訪問 | 相互参照 |
|--------|-----|-------|-----|---------|
| **予定データ** | KayoiSchedule | TomariReservation | HoumonSchedule | ❌ なし |
| **定員カウント** | 独立 | 独立 | なし | ❌ なし |
| **バリデーション** | 独立 | 独立 | 独立 | ❌ なし |
| **UI表示** | 独立 | 独立 | 独立 | ❌ なし |

**重要**: 各セクションは他セクションのデータを直接参照しない

---

## 3. 実装時の判断フロー

### 3.1 「これは共有すべき？独立すべき？」の判断

```
【判断フロー】

質問1: 複数のセクションで同じデータを使う？
  YES → 次へ
  NO  → 独立（セクション固有データ）

質問2: データの意味は全セクションで同じ？
  YES → 共有レイヤー（マスタデータ）
  NO  → 独立（セクション固有の解釈）

質問3: セクションごとに異なるロジックで処理？
  YES → 独立
  NO  → 共有レイヤー
```

---

### 3.2 具体例

#### 例1: 利用者の住所

```
質問1: 複数セクションで使う？
  → YES（訪問で移動時間、将来的に通いで送迎）

質問2: 意味は同じ？
  → YES（どのセクションでも「山田さんの住所」）

質問3: セクションごとに異なる処理？
  → NO（住所データは共通）

結論: 共有レイヤー（User.address）
```

---

#### 例2: 通いの前半・後半の記号

```
質問1: 複数セクションで使う？
  → NO（通いセクション専用）

結論: 独立（KayoiSchedule.section）
```

---

#### 例3: 定員チェック

```
質問1: 複数セクションで使う？
  → YES（各セクションで定員チェック）

質問2: 意味は同じ？
  → NO（通いは15人、泊まりは9人、訪問は定員なし）

質問3: セクションごとに異なる処理？
  → YES（カウント方法が異なる）

結論: 独立（各セクションで実装）
```

---

## 4. よくある誤解

### 誤解1: 「セクション独立性 = 完全にバラバラ」

```
❌ 誤解
通い・泊まり・訪問は完全に別物
関連性は一切ない

✅ 正しい理解
実装上は分離（並行開発、保守性）
業務上は密接に関連（同じ利用者、共通職員）
```

---

### 誤解2: 「共有レイヤー = すべてのデータ」

```
❌ 誤解
すべてのデータを共有レイヤーに配置

✅ 正しい理解
共有レイヤー: 利用者、職員など複数セクションで使うマスタ
実装レイヤー: 各セクション固有の予定データ
```

---

### 誤解3: 「通い+泊まり+訪問の合算定員がある」

```
❌ 誤解（私の過去の誤った説明）
利用定員25人 = 通い + 泊まり + 訪問 ≤ 25人

✅ 正しい理解（法令確認済み）
各サービスの定員は独立
合算制約は存在しない
```

---

## 5. まとめ

### 5.1 共有するもの

```
✅ マスタデータ
  - 利用者マスタ（同じ人が複数サービス利用）
  - 職員マスタ（同じ職員が対応）
  - 居室マスタ（泊まり固有だが共通管理）
  - 移動時間マトリックス
  - 祝日カレンダー

✅ 全体の制約
  - 登録定員29人（User.isActive のカウント）
```

---

### 5.2 独立するもの

```
✅ 予定データ
  - KayoiSchedule（通い固有）
  - TomariReservation（泊まり固有）
  - HoumonSchedule（訪問固有）

✅ 定員チェック
  - 通い: 15人（前半・後半）
  - 泊まり: 9人/日
  - 訪問: 定員なし
  ※各セクション独立、合算制約なし

✅ ビジネスロジック
  - バリデーション
  - データ操作
  - UI処理

✅ UI表示
  - 通い: 月別予定表（○◓◒）
  - 泊まり: 居室軸予定表（入○退）
  - 訪問: 時間帯別予定表（朝昼夕夜）
```

---

### 5.3 重要な原則

```
1. 共有レイヤーは「データ提供」のみ
   - ビジネスロジックは含まない

2. 各セクションは独立して実装
   - 他セクションのデータを直接参照しない
   - イベント駆動で通信（必要な場合のみ）

3. 定員は各セクション独立
   - 合算制約は存在しない
   - 各セクションで独立してチェック

4. 実装上の分離 ≠ 業務上の分離
   - 同じ利用者が複数サービス利用
   - 職員も共通
   - ただし実装は分離
```

---

## 6. 実装への適用

### 6.1 Phase 1実装順序

```
1. 共有レイヤー（1週間）
   ├─ MasterDataManager
   ├─ User クラス
   ├─ Staff クラス
   ├─ Room クラス
   └─ ユーティリティ

2. 通いセクション（2-3週間）
   ├─ KayoiSchedule
   ├─ KayoiSection
   ├─ 定員チェック（独立）
   └─ UI

3. 泊まりセクション（2-3週間）
   ├─ TomariReservation
   ├─ TomariSection
   ├─ 定員チェック（独立）
   └─ UI

4. 訪問セクション（2-3週間）
   ├─ HoumonSchedule
   ├─ HoumonSection
   └─ UI
```

---

### 6.2 実装時のチェックリスト

#### 共有レイヤー実装時

- [ ] MasterDataManager が各マスタを一元管理
- [ ] 利用者マスタの登録定員29人チェック
- [ ] localStorage での永続化
- [ ] 各セクションからの参照のみ（更新は管理機能）

#### 各セクション実装時

- [ ] 他セクションのデータを直接参照していないか
- [ ] 定員チェックは独立しているか
- [ ] イベント駆動通信（必要な場合のみ）
- [ ] セクション固有のDOM領域のみ操作

---

## 📚 参考ドキュメント

- **L0_業務_定員の法的枠組み.md** - 定員の法令根拠
- **L0_業務_小規模多機能とは.md** - 業務の基本
- **L1_概要_プロジェクト概要.md** - セクション独立性の原則
- **L1_技術_実装制約.md** - 実装ルール
- **L1_データ_共通データ構造.md** - マスタデータの詳細

---

## 📅 更新履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|----------|---------|------|
| 2025-11-23 | 1.0 | 初版作成（誤認修正版） | Claude |

---

## ⚠️ 重要な修正点

このドキュメントは、以前の誤った説明を修正したものです：

**誤った説明（削除）**:
- ❌ 「利用定員25人 = 通い+泊まり+訪問≤25人」
- ❌ 合算チェックが必要

**正しい理解（L0確認済み）**:
- ✅ 各サービスの定員は独立
- ✅ 合算制約は存在しない
- ✅ 登録定員29人のみが全体の上限

---

**最終更新**: 2025年11月23日  
**根拠法令**: 指定地域密着型サービスの事業の人員、設備及び運営に関する基準 第66条

---

**このドキュメントを実装時の指針として活用してください。**