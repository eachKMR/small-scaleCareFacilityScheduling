# L2_æ³Šã¾ã‚Š_ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ

**ä½œæˆæ—¥**: 2025å¹´11æœˆ23æ—¥  
**ã‚«ãƒ†ã‚´ãƒª**: ç¬¬2å±¤ - ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0  
**æ›´æ–°æ—¥**: 2025å¹´12æœˆ31æ—¥

---

## ğŸ“– ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€**æ³Šã¾ã‚Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯**ã‚’å®šç¾©ã—ã¾ã™ã€‚

### å¯¾è±¡èª­è€…

- æ³Šã¾ã‚Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…æ‹…å½“è€…
- ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“è€…
- ãƒ†ã‚¹ãƒˆæ‹…å½“è€…

### èª­äº†å¾Œã«ç†è§£ã§ãã‚‹ã“ã¨

- å®šå“¡ãƒã‚§ãƒƒã‚¯ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆ9äºº/æ—¥ï¼‰
- æœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…æ–¹æ³•
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è©³ç´°
- ãƒ‡ãƒ¼ã‚¿æ“ä½œï¼ˆè¿½åŠ ã€å‰Šé™¤ã€æ›´æ–°ï¼‰
- ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®é †åº
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã®æ–¹æ³•
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### è¨­è¨ˆã®å‰æ

- **L2_æ³Šã¾ã‚Š_ãƒ‡ãƒ¼ã‚¿æ§‹é€ .md** ã®TomariReservationã‚¯ãƒ©ã‚¹ã«åŸºã¥ã
- **L2_æ³Šã¾ã‚Š_UIè¨­è¨ˆ.md** ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã
- **L1_æŠ€è¡“_å®Ÿè£…åˆ¶ç´„.md** ã«æº–æ‹ 

---

## 1. å®šå“¡ãƒã‚§ãƒƒã‚¯ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### 1.1 åŸºæœ¬ãƒ«ãƒ¼ãƒ«

```
æ³Šã¾ã‚Šå®šå“¡: 9äºº/æ—¥ï¼ˆå›ºå®šï¼‰

ã‚«ã‚¦ãƒ³ãƒˆæ–¹æ³•:
æŒ‡å®šæ—¥ã®å®¿æ³Šè€…æ•° = startDate <= æŒ‡å®šæ—¥ <= endDate ã®äºˆç´„æ•°
```

**é‡è¦**: 1ã¤ã®äºˆç´„ã¯æœŸé–“ä¸­ã®ã™ã¹ã¦ã®æ—¥ã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹

---

### 1.2 å®šå“¡ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…

#### 1.2.1 1æ—¥åˆ†ã®å®šå“¡ãƒã‚§ãƒƒã‚¯

```javascript
/**
 * æŒ‡å®šæ—¥ã®å®¿æ³Šè€…æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
 * @param {TomariReservation[]} reservations - å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿
 * @param {string} date - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®æ—¥ä»˜ï¼ˆ"YYYY-MM-DD"ï¼‰
 * @returns {number} å®¿æ³Šè€…æ•°
 */
function countReservations(reservations, date) {
  return reservations.filter(r => 
    r.startDate <= date && date <= r.endDate
  ).length;
}
```

---

#### 1.2.2 æœŸé–“å…¨ä½“ã®å®šå“¡ãƒã‚§ãƒƒã‚¯

```javascript
/**
 * æŒ‡å®šæœŸé–“ã®ã™ã¹ã¦ã®æ—¥ã®å®šå“¡ã‚’ãƒã‚§ãƒƒã‚¯
 * @param {TomariReservation[]} reservations - ç¾åœ¨ã®å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿
 * @param {string} startDate - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®é–‹å§‹æ—¥
 * @param {string} endDate - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®çµ‚äº†æ—¥
 * @returns {Object} { ok: boolean, message?: string, overDates?: string[] }
 */
function checkCapacity(reservations, startDate, endDate) {
  const CAPACITY = 9;
  const overDates = [];
  
  // æœŸé–“å†…ã®ã™ã¹ã¦ã®æ—¥ã‚’ãƒã‚§ãƒƒã‚¯
  const dates = getDateRange(startDate, endDate);
  
  for (const date of dates) {
    const count = countReservations(reservations, date);
    
    if (count >= CAPACITY) {
      overDates.push({ date, count });
    }
  }
  
  if (overDates.length > 0) {
    const dateList = overDates.map(d => `${d.date}(${d.count}äºº)`).join(', ');
    return {
      ok: false,
      message: `ä»¥ä¸‹ã®æ—¥ãŒå®šå“¡ã«é”ã—ã¦ã„ã¾ã™: ${dateList}`,
      overDates: overDates.map(d => d.date)
    };
  }
  
  return { ok: true };
}

/**
 * æ—¥ä»˜ç¯„å›²ã‚’é…åˆ—ã§å–å¾—
 * @param {string} startDate - é–‹å§‹æ—¥
 * @param {string} endDate - çµ‚äº†æ—¥
 * @returns {string[]} æ—¥ä»˜ã®é…åˆ—
 */
function getDateRange(startDate, endDate) {
  const dates = [];
  let current = new Date(startDate);
  const end = new Date(endDate);
  
  while (current <= end) {
    dates.push(current.toISOString().split('T')[0]);
    current.setDate(current.getDate() + 1);
  }
  
  return dates;
}
```

---

#### 1.2.3 å®šå“¡ãƒã‚§ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```javascript
describe('checkCapacity', () => {
  test('å…¨æ—¥ç¨‹ã§ä½™è£•ã‚ã‚Šï¼ˆ8äººï¼‰â†’ OK', () => {
    const reservations = Array(8).fill(null).map((_, i) => ({
      userId: `user${i}`,
      roomId: `room0${i + 1}`,
      startDate: "2025-11-01",
      endDate: "2025-11-03"
    }));
    
    const result = checkCapacity(reservations, "2025-11-01", "2025-11-03");
    expect(result.ok).toBe(true);
  });
  
  test('æº€å“¡ï¼ˆ9äººï¼‰â†’ NG', () => {
    const reservations = Array(9).fill(null).map((_, i) => ({
      userId: `user${i}`,
      roomId: `room0${(i % 9) + 1}`,
      startDate: "2025-11-01",
      endDate: "2025-11-03"
    }));
    
    const result = checkCapacity(reservations, "2025-11-01", "2025-11-03");
    expect(result.ok).toBe(false);
    expect(result.overDates).toEqual(["2025-11-01", "2025-11-02", "2025-11-03"]);
  });
  
  test('æœŸé–“ã®ä¸€éƒ¨ã ã‘æº€å“¡ â†’ NGï¼ˆè©²å½“æ—¥ã®ã¿ãƒªã‚¹ãƒˆï¼‰', () => {
    const reservations = [
      // 11/1-11/2: 8äºº
      ...Array(8).fill(null).map((_, i) => ({
        userId: `user${i}`,
        roomId: `room0${i + 1}`,
        startDate: "2025-11-01",
        endDate: "2025-11-02"
      })),
      // 11/2-11/3: +1äººï¼ˆ11/2ã ã‘9äººã«ãªã‚‹ï¼‰
      {
        userId: "user999",
        roomId: "room09",
        startDate: "2025-11-02",
        endDate: "2025-11-03"
      }
    ];
    
    const result = checkCapacity(reservations, "2025-11-01", "2025-11-03");
    expect(result.ok).toBe(false);
    expect(result.overDates).toEqual(["2025-11-02"]);
  });
});
```

---

## 2. æœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯

### 2.1 é‡è¤‡åˆ¤å®šã®ãƒ­ã‚¸ãƒƒã‚¯

**ãƒ«ãƒ¼ãƒ«**: åŒã˜å±…å®¤ã§æœŸé–“ãŒé‡è¤‡ã™ã‚‹äºˆç´„ã¯ä¸å¯

```
æœŸé–“Aã¨æœŸé–“BãŒé‡è¤‡ã—ãªã„æ¡ä»¶ï¼ˆã©ã¡ã‚‰ã‹ï¼‰:
1. A.endDate < B.startDate ï¼ˆAã®å¾Œã«Bï¼‰
2. B.endDate < A.startDate ï¼ˆBã®å¾Œã«Aï¼‰

â†’ é‡è¤‡ã™ã‚‹æ¡ä»¶ï¼ˆå¦å®šï¼‰:
!(A.endDate < B.startDate || B.endDate < A.startDate)
```

---

### 2.2 å®Ÿè£…

```javascript
/**
 * å±…å®¤ã®æœŸé–“é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
 * @param {TomariReservation[]} reservations - ç¾åœ¨ã®å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿
 * @param {string} roomId - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®å±…å®¤ID
 * @param {string} startDate - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®é–‹å§‹æ—¥
 * @param {string} endDate - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®çµ‚äº†æ—¥
 * @param {string} excludeId - é™¤å¤–ã™ã‚‹äºˆç´„IDï¼ˆç·¨é›†æ™‚ã«ä½¿ç”¨ï¼‰
 * @returns {Object} { valid: boolean, error?: string, conflictReservation?: Object }
 */
function checkRoomConflict(reservations, roomId, startDate, endDate, excludeId = null) {
  // åŒã˜å±…å®¤ã®äºˆç´„ã‚’æŠ½å‡º
  const roomReservations = reservations.filter(r => 
    r.roomId === roomId && r.id !== excludeId
  );
  
  // æœŸé–“ãŒé‡è¤‡ã™ã‚‹äºˆç´„ã‚’æ¤œç´¢
  const conflict = roomReservations.find(r => {
    // é‡è¤‡åˆ¤å®š
    return !(r.endDate < startDate || endDate < r.startDate);
  });
  
  if (conflict) {
    return {
      valid: false,
      error: `${roomId}ã¯${conflict.startDate}ï½${conflict.endDate}ã«æ—¢ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™`,
      conflictReservation: conflict
    };
  }
  
  return { valid: true };
}
```

---

### 2.3 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

```javascript
describe('checkRoomConflict', () => {
  const existingReservation = {
    id: "tomari_001",
    userId: "user001",
    roomId: "room01",
    startDate: "2025-11-10",
    endDate: "2025-11-15"
  };
  
  test('å®Œå…¨ã«å‰ â†’ OK', () => {
    const result = checkRoomConflict(
      [existingReservation],
      "room01",
      "2025-11-05",  // æ—¢å­˜ã®å‰
      "2025-11-09"
    );
    expect(result.valid).toBe(true);
  });
  
  test('å®Œå…¨ã«å¾Œ â†’ OK', () => {
    const result = checkRoomConflict(
      [existingReservation],
      "room01",
      "2025-11-16",  // æ—¢å­˜ã®å¾Œ
      "2025-11-20"
    );
    expect(result.valid).toBe(true);
  });
  
  test('å‰æ—¥ã¾ã§ â†’ OK', () => {
    const result = checkRoomConflict(
      [existingReservation],
      "room01",
      "2025-11-08",
      "2025-11-09"  // æ—¢å­˜ã®é–‹å§‹æ—¥ã®å‰æ—¥
    );
    expect(result.valid).toBe(true);
  });
  
  test('ç¿Œæ—¥ã‹ã‚‰ â†’ OK', () => {
    const result = checkRoomConflict(
      [existingReservation],
      "room01",
      "2025-11-16",  // æ—¢å­˜ã®çµ‚äº†æ—¥ã®ç¿Œæ—¥
      "2025-11-20"
    );
    expect(result.valid).toBe(true);
  });
  
  test('é–‹å§‹æ—¥ãŒåŒã˜ â†’ NG', () => {
    const result = checkRoomConflict(
      [existingReservation],
      "room01",
      "2025-11-10",  // æ—¢å­˜ã¨åŒã˜é–‹å§‹æ—¥
      "2025-11-12"
    );
    expect(result.valid).toBe(false);
  });
  
  test('æœŸé–“ã®é€”ä¸­ â†’ NG', () => {
    const result = checkRoomConflict(
      [existingReservation],
      "room01",
      "2025-11-12",  // æ—¢å­˜ã®æœŸé–“å†…
      "2025-11-14"
    );
    expect(result.valid).toBe(false);
  });
  
  test('æœŸé–“ã‚’åŒ…å« â†’ NG', () => {
    const result = checkRoomConflict(
      [existingReservation],
      "room01",
      "2025-11-08",  // æ—¢å­˜ã‚ˆã‚Šå‰ã‹ã‚‰
      "2025-11-18"   // æ—¢å­˜ã‚ˆã‚Šå¾Œã¾ã§
    );
    expect(result.valid).toBe(false);
  });
  
  test('åˆ¥ã®å±…å®¤ â†’ OK', () => {
    const result = checkRoomConflict(
      [existingReservation],
      "room02",  // åˆ¥ã®å±…å®¤
      "2025-11-10",
      "2025-11-15"
    );
    expect(result.valid).toBe(true);
  });
});
```

---

## 3. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### 3.1 ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®éšå±¤

```
ãƒ¬ãƒ™ãƒ«1: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼ˆå³åº§ï¼‰
  â”œâ”€ å…¥åŠ›æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‹ã€å½¢å¼ï¼‰
  â”œâ”€ æ—¥ä»˜ã®å‰å¾Œé–¢ä¿‚
  â””â”€ æœŸé–“ã®é•·ã•

ãƒ¬ãƒ™ãƒ«2: ãƒ‡ãƒ¼ã‚¿å±¤ï¼ˆä¿å­˜å‰ï¼‰
  â”œâ”€ å¿…é ˆãƒã‚§ãƒƒã‚¯
  â”œâ”€ æœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯
  â”œâ”€ å®šå“¡ãƒã‚§ãƒƒã‚¯
  â””â”€ ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

ï¼ˆPhase 2ä»¥é™ï¼‰
ãƒ¬ãƒ™ãƒ«3: ã‚µãƒ¼ãƒãƒ¼å´
  â””â”€ æœ€çµ‚çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```

---

### 3.2 å…¥åŠ›æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

#### 3.2.1 æ—¥ä»˜ã®å½¢å¼ãƒã‚§ãƒƒã‚¯

```javascript
/**
 * æ—¥ä»˜å½¢å¼ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * @param {string} date - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®æ—¥ä»˜
 * @returns {Object} { valid: boolean, error?: string }
 */
function validateDate(date) {
  if (!date) {
    return { valid: false, error: 'æ—¥ä»˜ã¯å¿…é ˆã§ã™' };
  }
  
  // å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆYYYY-MM-DDï¼‰
  const regex = /^\d{4}-\d{2}-\d{2}$/;
  if (!regex.test(date)) {
    return { 
      valid: false, 
      error: 'æ—¥ä»˜ã®å½¢å¼ãŒä¸æ­£ã§ã™ï¼ˆYYYY-MM-DDå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰' 
    };
  }
  
  // å®Ÿåœ¨ã™ã‚‹æ—¥ä»˜ã‹ãƒã‚§ãƒƒã‚¯
  const d = new Date(date);
  if (isNaN(d.getTime())) {
    return { valid: false, error: 'å®Ÿåœ¨ã—ãªã„æ—¥ä»˜ã§ã™' };
  }
  
  return { valid: true };
}
```

---

#### 3.2.2 æ—¥ä»˜ã®å‰å¾Œé–¢ä¿‚ãƒã‚§ãƒƒã‚¯

```javascript
/**
 * æ—¥ä»˜ã®å‰å¾Œé–¢ä¿‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * @param {string} startDate - é–‹å§‹æ—¥
 * @param {string} endDate - çµ‚äº†æ—¥
 * @returns {Object} { valid: boolean, error?: string }
 */
function validateDateRange(startDate, endDate) {
  // å½¢å¼ãƒã‚§ãƒƒã‚¯
  const startValidation = validateDate(startDate);
  if (!startValidation.valid) return startValidation;
  
  const endValidation = validateDate(endDate);
  if (!endValidation.valid) return endValidation;
  
  // å‰å¾Œé–¢ä¿‚ãƒã‚§ãƒƒã‚¯
  if (startDate >= endDate) {
    return { 
      valid: false, 
      error: 'é€€æ‰€æ—¥ã¯å…¥æ‰€æ—¥ã‚ˆã‚Šå¾Œã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™' 
    };
  }
  
  // æœŸé–“ãŒé•·ã™ããªã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: 30æ—¥ä»¥å†…ï¼‰
  const start = new Date(startDate);
  const end = new Date(endDate);
  const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
  
  if (diffDays > 30) {
    return { 
      valid: false, 
      error: 'å®¿æ³ŠæœŸé–“ã¯30æ—¥ä»¥å†…ã«ã—ã¦ãã ã•ã„' 
    };
  }
  
  return { valid: true };
}
```

---

#### 3.2.3 åˆ©ç”¨è€…IDãƒ»å±…å®¤IDã®ãƒã‚§ãƒƒã‚¯

```javascript
/**
 * åˆ©ç”¨è€…IDã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * @param {string} userId - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®åˆ©ç”¨è€…ID
 * @returns {Object} { valid: boolean, error?: string }
 */
function validateUserId(userId) {
  if (!userId) {
    return { valid: false, error: 'åˆ©ç”¨è€…IDã¯å¿…é ˆã§ã™' };
  }
  
  if (typeof userId !== 'string') {
    return { valid: false, error: 'åˆ©ç”¨è€…IDã¯æ–‡å­—åˆ—ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“' };
  }
  
  return { valid: true };
}

/**
 * å±…å®¤IDã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * @param {string} roomId - ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®å±…å®¤ID
 * @param {Room[]} rooms - å±…å®¤ãƒã‚¹ã‚¿
 * @returns {Object} { valid: boolean, error?: string }
 */
function validateRoomId(roomId, rooms) {
  if (!roomId) {
    return { valid: false, error: 'å±…å®¤IDã¯å¿…é ˆã§ã™' };
  }
  
  // å±…å®¤ãƒã‚¹ã‚¿ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  const room = rooms.find(r => r.id === roomId);
  if (!room) {
    return { valid: false, error: 'æŒ‡å®šã•ã‚ŒãŸå±…å®¤ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
  }
  
  // ä½¿ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
  if (!room.isActive) {
    return { valid: false, error: 'ã“ã®å±…å®¤ã¯ç¾åœ¨ä½¿ç”¨ã§ãã¾ã›ã‚“' };
  }
  
  return { valid: true };
}
```

---

### 3.3 ä¿å­˜å‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

#### 3.3.1 çµ±åˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°

```javascript
/**
 * äºˆç´„è¿½åŠ æ™‚ã®çµ±åˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * @param {TomariReservation[]} reservations - ç¾åœ¨ã®å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿
 * @param {Room[]} rooms - å±…å®¤ãƒã‚¹ã‚¿
 * @param {string} userId - åˆ©ç”¨è€…ID
 * @param {string} roomId - å±…å®¤ID
 * @param {string} startDate - é–‹å§‹æ—¥
 * @param {string} endDate - çµ‚äº†æ—¥
 * @returns {Object} { valid: boolean, errors?: string[], warnings?: string[] }
 */
function validateReservationAdd(reservations, rooms, userId, roomId, startDate, endDate) {
  const errors = [];
  const warnings = [];
  
  // åˆ©ç”¨è€…IDãƒã‚§ãƒƒã‚¯
  const userIdValidation = validateUserId(userId);
  if (!userIdValidation.valid) {
    errors.push(userIdValidation.error);
  }
  
  // å±…å®¤IDãƒã‚§ãƒƒã‚¯
  const roomIdValidation = validateRoomId(roomId, rooms);
  if (!roomIdValidation.valid) {
    errors.push(roomIdValidation.error);
  }
  
  // æ—¥ä»˜ç¯„å›²ãƒã‚§ãƒƒã‚¯
  const dateRangeValidation = validateDateRange(startDate, endDate);
  if (!dateRangeValidation.valid) {
    errors.push(dateRangeValidation.error);
  }
  
  // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ã€ä»¥é™ã®ãƒã‚§ãƒƒã‚¯ã¯ã‚¹ã‚­ãƒƒãƒ—
  if (errors.length > 0) {
    return { valid: false, errors };
  }
  
  // æœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯
  const conflictCheck = checkRoomConflict(reservations, roomId, startDate, endDate);
  if (!conflictCheck.valid) {
    errors.push(conflictCheck.error);
  }
  
  // å®šå“¡ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ã€ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„ï¼‰
  const capacityCheck = checkCapacity(reservations, startDate, endDate);
  if (!capacityCheck.ok) {
    warnings.push(capacityCheck.message);
  }
  
  return {
    valid: errors.length === 0,
    errors: errors.length > 0 ? errors : undefined,
    warnings: warnings.length > 0 ? warnings : undefined
  };
}
```

---

## 4. ãƒ‡ãƒ¼ã‚¿æ“ä½œ

### 4.1 äºˆç´„ã®è¿½åŠ 

```javascript
/**
 * äºˆç´„ã‚’è¿½åŠ 
 * @param {TomariReservation[]} reservations - ç¾åœ¨ã®å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿ï¼ˆç ´å£Šçš„å¤‰æ›´ï¼‰
 * @param {Room[]} rooms - å±…å®¤ãƒã‚¹ã‚¿
 * @param {string} userId - åˆ©ç”¨è€…ID
 * @param {string} roomId - å±…å®¤ID
 * @param {string} startDate - é–‹å§‹æ—¥
 * @param {string} endDate - çµ‚äº†æ—¥
 * @returns {Object} { success: boolean, reservation?: TomariReservation, errors?: string[], warnings?: string[] }
 */
function addReservation(reservations, rooms, userId, roomId, startDate, endDate) {
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const validation = validateReservationAdd(reservations, rooms, userId, roomId, startDate, endDate);
  if (!validation.valid) {
    return { 
      success: false, 
      errors: validation.errors 
    };
  }
  
  // æ–°ã—ã„äºˆç´„ã‚’ä½œæˆ
  const newReservation = new TomariReservation({
    userId: userId,
    roomId: roomId,
    startDate: startDate,
    endDate: endDate
  });
  
  // é…åˆ—ã«è¿½åŠ 
  reservations.push(newReservation);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  dispatchReservationEvent('tomari:reservationAdded', {
    reservation: newReservation
  });
  
  return { 
    success: true, 
    reservation: newReservation,
    warnings: validation.warnings  // å®šå“¡è¶…éã®è­¦å‘Š
  };
}
```

---

### 4.2 äºˆç´„ã®å‰Šé™¤

```javascript
/**
 * äºˆç´„ã‚’å‰Šé™¤
 * @param {TomariReservation[]} reservations - ç¾åœ¨ã®å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿ï¼ˆç ´å£Šçš„å¤‰æ›´ï¼‰
 * @param {string} reservationId - äºˆç´„ID
 * @returns {Object} { success: boolean, error?: string }
 */
function removeReservation(reservations, reservationId) {
  const index = reservations.findIndex(r => r.id === reservationId);
  
  if (index === -1) {
    return { 
      success: false, 
      error: 'äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' 
    };
  }
  
  // å‰Šé™¤ã•ã‚Œã‚‹äºˆç´„ã‚’ä¿æŒï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç”¨ï¼‰
  const removedReservation = reservations[index];
  
  // é…åˆ—ã‹ã‚‰å‰Šé™¤
  reservations.splice(index, 1);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  dispatchReservationEvent('tomari:reservationRemoved', {
    reservation: removedReservation
  });
  
  return { success: true };
}
```

---

### 4.3 äºˆç´„ã®æ›´æ–°

```javascript
/**
 * äºˆç´„ã‚’æ›´æ–°
 * @param {TomariReservation[]} reservations - ç¾åœ¨ã®å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿ï¼ˆç ´å£Šçš„å¤‰æ›´ï¼‰
 * @param {Room[]} rooms - å±…å®¤ãƒã‚¹ã‚¿
 * @param {string} reservationId - äºˆç´„ID
 * @param {Object} updates - æ›´æ–°å†…å®¹ { roomId?, startDate?, endDate? }
 * @returns {Object} { success: boolean, reservation?: TomariReservation, errors?: string[], warnings?: string[] }
 */
function updateReservation(reservations, rooms, reservationId, updates) {
  const reservation = reservations.find(r => r.id === reservationId);
  if (!reservation) {
    return { 
      success: false, 
      error: 'äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' 
    };
  }
  
  // æ›´æ–°å¾Œã®å€¤ã‚’å–å¾—
  const newRoomId = updates.roomId || reservation.roomId;
  const newStartDate = updates.startDate || reservation.startDate;
  const newEndDate = updates.endDate || reservation.endDate;
  
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ï¼‰
  const validation = validateReservationAdd(
    reservations, 
    rooms, 
    reservation.userId, 
    newRoomId, 
    newStartDate, 
    newEndDate
  );
  
  // æœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–ï¼‰
  const conflictCheck = checkRoomConflict(
    reservations, 
    newRoomId, 
    newStartDate, 
    newEndDate, 
    reservationId  // è‡ªåˆ†è‡ªèº«ã‚’é™¤å¤–
  );
  
  if (!conflictCheck.valid) {
    return { 
      success: false, 
      errors: [conflictCheck.error] 
    };
  }
  
  // æ›´æ–°
  Object.assign(reservation, updates);
  reservation.updatedAt = new Date().toISOString();
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  dispatchReservationEvent('tomari:reservationUpdated', {
    reservation: reservation
  });
  
  return { 
    success: true, 
    reservation: reservation,
    warnings: validation.warnings
  };
}
```

---

## 5. ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®é †åº

### 5.1 æœŸé–“é¸æŠï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼‰æ™‚ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚»ãƒ«ã§ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ï¼ˆé–‹å§‹ï¼‰
   â†“
2. ãƒã‚¦ã‚¹ç§»å‹•ï¼ˆæœŸé–“é¸æŠï¼‰
   - é€šéã—ãŸã‚»ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
   - åŒã˜å±…å®¤ã®æ¨ªæ–¹å‘ã®ã¿é¸æŠå¯èƒ½
   â†“
3. ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—ï¼ˆçµ‚äº†ï¼‰
   - é¸æŠè§£é™¤
   â†“
4. åˆ©ç”¨è€…é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
   showUserSelectDialog(roomId, startDate, endDate)
   â†“
5. åˆ©ç”¨è€…ã‚’é¸æŠ â†’ [è¿½åŠ ]ãƒœã‚¿ãƒ³
   â†“
6. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   validateReservationAdd()
   â†“ æˆåŠŸ
7. ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
   addReservation()
   â†“
8. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
   invalidateCache(reservation)
   â†“
9. UIæ›´æ–°
   renderGrid()
   â†“
10. å®šå“¡è¡¨ç¤ºã‚’æ›´æ–°
    updateCapacityDisplay()
    â†“
11. ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆæˆåŠŸ or è­¦å‘Šï¼‰
    if (warnings) {
      showWarning(warnings);
    } else {
      showToast('äºˆç´„ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'info');
    }
    â†“
12. localStorage ã«ä¿å­˜
    saveToStorage(reservations)

---

ã‚¨ãƒ©ãƒ¼æ™‚:
6. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   â†“ å¤±æ•—ï¼ˆæœŸé–“é‡è¤‡ç­‰ï¼‰
7. ã‚¨ãƒ©ãƒ¼å‡¦ç†
   â†“
8. ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰
   showToast('ã“ã®æœŸé–“ã¯æ—¢ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™', 'error')
   â†“
9. å‡¦ç†çµ‚äº†ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯æ›´æ–°ã•ã‚Œãªã„ï¼‰
```

---

### 5.2 ã‚¤ãƒ™ãƒ³ãƒˆã®å„ªå…ˆé †ä½

```
å„ªå…ˆåº¦1: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  - ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’æœ€å„ªå…ˆ

å„ªå…ˆåº¦2: ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸå¾Œã®ã¿å®Ÿè¡Œ

å„ªå…ˆåº¦3: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
  - ãƒ‡ãƒ¼ã‚¿æ›´æ–°æˆåŠŸå¾Œã«å¿…ãšå®Ÿè¡Œ

å„ªå…ˆåº¦4: UIæ›´æ–°
  - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–å¾Œã«å®Ÿè¡Œ

å„ªå…ˆåº¦5: é€šçŸ¥ãƒ»ä¿å­˜
  - UIæ›´æ–°å¾Œã«å®Ÿè¡Œ
```

---

### 5.3 ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

```javascript
// ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«é–¢æ•°
function dispatchReservationEvent(eventName, detail) {
  const event = new CustomEvent(eventName, { detail });
  document.dispatchEvent(event);
}

// ä½¿ç”¨ä¾‹
addReservation() {
  // ...ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
  dispatchReservationEvent('tomari:reservationAdded', {
    reservation: newReservation
  });
}

// ãƒªã‚¹ãƒŠãƒ¼ï¼ˆä»–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰
document.addEventListener('tomari:reservationAdded', (e) => {
  console.log('æ³Šã¾ã‚Šã§äºˆç´„è¿½åŠ :', e.detail.reservation);
  // å¿…è¦ãªã‚‰ä½•ã‹ã™ã‚‹
});
```

**ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§**:
- `tomari:reservationAdded` - äºˆç´„è¿½åŠ æ™‚
- `tomari:reservationRemoved` - äºˆç´„å‰Šé™¤æ™‚
- `tomari:reservationUpdated` - äºˆç´„æ›´æ–°æ™‚
- `tomari:capacityExceeded` - å®šå“¡è¶…éæ™‚ï¼ˆè­¦å‘Šï¼‰

---

## 6. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†

### 6.1 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç›®çš„

**å•é¡Œ**: å±…å®¤è¦–ç‚¹ã®è¡¨ç¤ºã®ãŸã³ã«è¨ˆç®— â†’ é‡ã„

**è§£æ±ºç­–**: è¨ˆç®—çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```javascript
class TomariSection {
  #reservations = [];
  #occupancyCache = new Map();  // key: "roomId_date", value: { userId, status, userName }
  
  getRoomOccupancy(roomId, date) {
    const key = `${roomId}_${date}`;
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ã‚Œã°è¿”ã™
    if (this.#occupancyCache.has(key)) {
      return this.#occupancyCache.get(key);
    }
    
    // è¨ˆç®—ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
    const result = this.calculateOccupancy(roomId, date);
    this.#occupancyCache.set(key, result);
    
    return result;
  }
}
```

---

### 6.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç„¡åŠ¹åŒ–

**ãƒ«ãƒ¼ãƒ«**: äºˆç´„ã‚’è¿½åŠ ãƒ»å‰Šé™¤ãƒ»æ›´æ–°ã—ãŸã‚‰ã€é–¢é€£ã™ã‚‹æ—¥ä»˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤

```javascript
class TomariSection {
  /**
   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ï¼ˆäºˆç´„è¿½åŠ ãƒ»å‰Šé™¤ãƒ»æ›´æ–°æ™‚ã«å‘¼ã¶ï¼‰
   * @param {TomariReservation} reservation - å¯¾è±¡ã®äºˆç´„
   */
  invalidateCache(reservation) {
    // ã“ã®äºˆç´„ã«é–¢é€£ã™ã‚‹æ—¥ä»˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
    const dates = this.getDateRange(reservation.startDate, reservation.endDate);
    
    dates.forEach(date => {
      this.#occupancyCache.delete(`${reservation.roomId}_${date}`);
    });
  }
  
  /**
   * ã™ã¹ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
   */
  invalidateAllCache() {
    this.#occupancyCache.clear();
  }
  
  /**
   * äºˆç´„è¿½åŠ ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã‚’å¿˜ã‚Œãªã„ï¼‰
   */
  addReservation(reservation) {
    this.#reservations.push(reservation);
    this.invalidateCache(reservation);  // â† å¿…é ˆ
  }
  
  /**
   * äºˆç´„å‰Šé™¤ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã‚’å¿˜ã‚Œãªã„ï¼‰
   */
  removeReservation(reservationId) {
    const reservation = this.#reservations.find(r => r.id === reservationId);
    if (!reservation) return { success: false };
    
    // å‰Šé™¤å‰ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ï¼ˆäºˆç´„æƒ…å ±ãŒå¿…è¦ãªãŸã‚ï¼‰
    this.invalidateCache(reservation);
    
    // å‰Šé™¤
    this.#reservations = this.#reservations.filter(r => r.id !== reservationId);
    
    return { success: true };
  }
  
  /**
   * äºˆç´„æ›´æ–°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã‚’å¿˜ã‚Œãªã„ï¼‰
   */
  updateReservation(reservationId, updates) {
    const reservation = this.#reservations.find(r => r.id === reservationId);
    if (!reservation) return { success: false };
    
    // æ›´æ–°å‰ã®æœŸé–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
    this.invalidateCache(reservation);
    
    // æ›´æ–°
    Object.assign(reservation, updates);
    
    // æ›´æ–°å¾Œã®æœŸé–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ç„¡åŠ¹åŒ–ï¼ˆæœŸé–“ãŒå¤‰ã‚ã£ãŸå ´åˆï¼‰
    this.invalidateCache(reservation);
    
    return { success: true };
  }
}
```

---

### 6.3 ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

```
1. åˆæœŸçŠ¶æ…‹: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ç©º
   â†“
2. è¡¨ç¤ºæ™‚: getRoomOccupancy() ã§è¨ˆç®—ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
   â†“
3. äºˆç´„è¿½åŠ ãƒ»å‰Šé™¤ãƒ»æ›´æ–°: invalidateCache() ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
   â†“
4. æ¬¡å›è¡¨ç¤ºæ™‚: å†è¨ˆç®—ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
```

**é‡è¦**: äºˆç´„ã‚’è¿½åŠ ãƒ»å‰Šé™¤ãƒ»æ›´æ–°ã—ãŸã‚‰ã€**å¿…ãš**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹

---

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 7.1 ã‚¨ãƒ©ãƒ¼ã®åˆ†é¡

| ã‚¨ãƒ©ãƒ¼åˆ†é¡ | ä¾‹ | å‡¦ç† |
|-----------|----|----|
| **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼** | æ—¥ä»˜å½¢å¼ãŒä¸æ­£ã€æœŸé–“ã®å‰å¾Œé–¢ä¿‚ | ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã€å‡¦ç†ä¸­æ–­ |
| **æœŸé–“é‡è¤‡ã‚¨ãƒ©ãƒ¼** | åŒã˜å±…å®¤ã§æœŸé–“ãŒé‡è¤‡ | ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã€å‡¦ç†ä¸­æ–­ |
| **å®šå“¡è¶…éã‚¨ãƒ©ãƒ¼** | 9äººè¶…é | ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆè­¦å‘Šï¼‰ã€å‡¦ç†ç¶šè¡Œ |
| **ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼** | localStorageæ›¸ãè¾¼ã¿å¤±æ•— | ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ |

---

### 7.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…

```javascript
function handleReservationAdd(roomId, startDate, endDate, userId) {
  try {
    // äºˆç´„è¿½åŠ 
    const result = addReservation(reservations, rooms, userId, roomId, startDate, endDate);
    
    if (!result.success) {
      // ã‚¨ãƒ©ãƒ¼å‡¦ç†
      handleAddError(result.errors);
      return;
    }
    
    // è­¦å‘ŠãŒã‚ã‚‹å ´åˆï¼ˆå®šå“¡è¶…éï¼‰
    if (result.warnings) {
      showWarning(result.warnings.join('\n'));
    }
    
    // UIæ›´æ–°
    renderGrid();
    updateCapacityDisplay();
    
    // æˆåŠŸé€šçŸ¥
    showToast('äºˆç´„ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'info');
    
    // ä¿å­˜
    saveToStorage(reservations);
    
  } catch (error) {
    // ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼
    console.error('äºˆç´„è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
    showToast('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
  }
}

function handleAddError(errors) {
  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  const errorMessage = errors.join('\n');
  showToast(errorMessage, 'error');
}
```

---

### 7.3 ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è¨˜éŒ²

```javascript
function logError(error, context) {
  const log = {
    timestamp: new Date().toISOString(),
    error: error.message,
    stack: error.stack,
    context: context
  };
  
  // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
  console.error('Error:', log);
  
  // Phase 2ä»¥é™: ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
  // sendErrorLog(log);
}
```

---

## 8. çŠ¶æ…‹ç®¡ç†

### 8.1 çŠ¶æ…‹ã®å®šç¾©

```javascript
class TomariSection {
  #reservations = [];      // å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿
  #rooms = [];             // å±…å®¤ãƒã‚¹ã‚¿
  #currentMonth = null;    // ç¾åœ¨è¡¨ç¤ºä¸­ã®æœˆ
  #selectedCells = [];     // ç¾åœ¨é¸æŠä¸­ã®ã‚»ãƒ«ï¼ˆæœŸé–“é¸æŠä¸­ï¼‰
  #isDirty = false;        // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹ã‹
  
  constructor(rooms) {
    this.#reservations = [];
    this.#rooms = rooms;
    this.#currentMonth = new Date();
    this.#selectedCells = [];
    this.#isDirty = false;
  }
  
  // getter/setter
  get reservations() {
    return [...this.#reservations]; // ã‚³ãƒ”ãƒ¼ã‚’è¿”ã™
  }
  
  get rooms() {
    return [...this.#rooms]; // ã‚³ãƒ”ãƒ¼ã‚’è¿”ã™
  }
  
  get currentMonth() {
    return this.#currentMonth;
  }
  
  set currentMonth(month) {
    this.#currentMonth = month;
    this.render();
  }
  
  get isDirty() {
    return this.#isDirty;
  }
}
```

---

### 8.2 çŠ¶æ…‹ã®æ›´æ–°

```javascript
class TomariSection {
  addReservation(userId, roomId, startDate, endDate) {
    const result = addReservation(this.#reservations, this.#rooms, userId, roomId, startDate, endDate);
    
    if (result.success) {
      this.invalidateCache(result.reservation);
      this.#isDirty = true;
      this.render();
      return result;
    }
    
    return result;
  }
  
  removeReservation(reservationId) {
    const reservation = this.#reservations.find(r => r.id === reservationId);
    if (!reservation) return { success: false };
    
    this.invalidateCache(reservation);
    
    const result = removeReservation(this.#reservations, reservationId);
    
    if (result.success) {
      this.#isDirty = true;
      this.render();
      return result;
    }
    
    return result;
  }
  
  save() {
    if (!this.#isDirty) {
      return { success: true, message: 'ä¿å­˜ã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“' };
    }
    
    try {
      saveToStorage(this.#reservations);
      this.#isDirty = false;
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }
}
```

---

## 10. ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆv2.0æ–°è¦è¿½åŠ ï¼‰

### 10.1 æ¦‚è¦

**ç›®çš„**: æœªå‰²å½“ã®äºˆç´„ã‚’å±…å®¤ã«å‰²ã‚Šå½“ã¦ã€ã¾ãŸã¯å±…å®¤é–“ã§ç§»å‹•ã™ã‚‹

**æ“ä½œãƒ‘ã‚¿ãƒ¼ãƒ³**:
1. æœªå‰²å½“â†’å±…å®¤: éƒ¨å±‹å‰²ã‚Šå½“ã¦
2. å±…å®¤â†’æœªå‰²å½“: å‰²ã‚Šå½“ã¦è§£é™¤
3. å±…å®¤â†’å±…å®¤: éƒ¨å±‹å¤‰æ›´

---

### 10.2 ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹

```javascript
function handleDragStart(event) {
  const userId = event.target.dataset.userId;
  const date = event.target.closest('.schedule-cell').dataset.date;
  
  // ãƒ‰ãƒ©ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
  event.dataTransfer.setData('userId', userId);
  event.dataTransfer.setData('date', date);
  event.dataTransfer.effectAllowed = 'move';
  
  // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  event.target.style.opacity = '0.5';
}
```

---

### 10.3 ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†

#### 10.3.1 æœªå‰²å½“â†’å±…å®¤ï¼ˆéƒ¨å±‹å‰²ã‚Šå½“ã¦ï¼‰

```javascript
async function assignRoom(userId, date, targetRoomId) {
  // äºˆç´„ã‚’æ¤œç´¢
  const reservation = findReservation(userId, date);
  if (!reservation) {
    throw new Error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  // æœŸé–“å…¨ä½“ã‚’ãƒã‚§ãƒƒã‚¯
  if (!isEntirePeriod(reservation, date)) {
    throw new Error('æœŸé–“ã®é–‹å§‹æ—¥ã¾ãŸã¯çµ‚äº†æ—¥ã‹ã‚‰æ“ä½œã—ã¦ãã ã•ã„');
  }
  
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  const conflict = checkRoomConflict(
    reservations,
    targetRoomId,
    reservation.startDate,
    reservation.endDate
  );
  
  if (!conflict.valid) {
    throw new Error(conflict.error);
  }
  
  // éƒ¨å±‹ã‚’å‰²ã‚Šå½“ã¦
  reservation.roomId = targetRoomId;
  reservation.updatedAt = new Date().toISOString();
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
  invalidateCache(reservation);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  dispatchEvent(new CustomEvent('tomari:roomAssigned', {
    detail: { reservation }
  }));
  
  // UIæ›´æ–°
  renderGrid();
  
  return { success: true };
}
```

---

#### 10.3.2 å±…å®¤â†’æœªå‰²å½“ï¼ˆå‰²ã‚Šå½“ã¦è§£é™¤ï¼‰

```javascript
async function unassignRoom(userId, date) {
  // äºˆç´„ã‚’æ¤œç´¢
  const reservation = findReservation(userId, date);
  if (!reservation) {
    throw new Error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  // roomIdã‚’nullã«è¨­å®š
  reservation.roomId = null;
  reservation.updatedAt = new Date().toISOString();
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
  invalidateCache(reservation);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  dispatchEvent(new CustomEvent('tomari:roomUnassigned', {
    detail: { reservation }
  }));
  
  // UIæ›´æ–°
  renderGrid();
  
  return { success: true };
}
```

---

#### 10.3.3 å±…å®¤â†’å±…å®¤ï¼ˆéƒ¨å±‹å¤‰æ›´ï¼‰

```javascript
async function changeRoom(userId, date, newRoomId) {
  // äºˆç´„ã‚’æ¤œç´¢
  const reservation = findReservation(userId, date);
  if (!reservation) {
    throw new Error('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  const conflict = checkRoomConflict(
    reservations,
    newRoomId,
    reservation.startDate,
    reservation.endDate,
    reservation.id  // è‡ªåˆ†è‡ªèº«ã¯é™¤å¤–
  );
  
  if (!conflict.valid) {
    throw new Error(conflict.error);
  }
  
  // éƒ¨å±‹ã‚’å¤‰æ›´
  const oldRoomId = reservation.roomId;
  reservation.roomId = newRoomId;
  reservation.updatedAt = new Date().toISOString();
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
  invalidateCache(reservation);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  dispatchEvent(new CustomEvent('tomari:roomChanged', {
    detail: { reservation, oldRoomId, newRoomId }
  }));
  
  // UIæ›´æ–°
  renderGrid();
  
  return { success: true };
}
```

---

### 10.4 æœŸé–“ãƒã‚§ãƒƒã‚¯

```javascript
function isEntirePeriod(reservation, date) {
  // æœŸé–“ã®é–‹å§‹æ—¥ã¾ãŸã¯çµ‚äº†æ—¥ã§ã‚ã‚Œã°OK
  return date === reservation.startDate || date === reservation.endDate;
}
```

**ç†ç”±**: æœŸé–“ã®é€”ä¸­ã‹ã‚‰éƒ¨å±‹ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒå´©ã‚Œã‚‹

---

### 10.5 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```javascript
function handleDrop(event) {
  event.preventDefault();
  
  const userId = event.dataTransfer.getData('userId');
  const date = event.dataTransfer.getData('date');
  const targetRoomId = event.target.closest('tr').dataset.roomId;
  
  try {
    if (targetRoomId === 'unassigned') {
      // æœªå‰²å½“ã«æˆ»ã™
      await unassignRoom(userId, date);
      showToast('éƒ¨å±‹ã®å‰²ã‚Šå½“ã¦ã‚’è§£é™¤ã—ã¾ã—ãŸ', 'info');
    } else {
      // éƒ¨å±‹ã‚’å‰²ã‚Šå½“ã¦orå¤‰æ›´
      const reservation = findReservation(userId, date);
      if (reservation.roomId === null) {
        await assignRoom(userId, date, targetRoomId);
        showToast('éƒ¨å±‹ã‚’å‰²ã‚Šå½“ã¦ã¾ã—ãŸ', 'success');
      } else {
        await changeRoom(userId, date, targetRoomId);
        showToast('éƒ¨å±‹ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
      }
    }
  } catch (error) {
    showToast(error.message, 'error');
  }
}
```

---

## 9. ã¾ã¨ã‚

### 9.1 ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å®šç¾©ã—ãŸã“ã¨

```
âœ… å®šç¾©ã—ãŸã“ã¨
â”œâ”€ å®šå“¡ãƒã‚§ãƒƒã‚¯ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆ9äºº/æ—¥ï¼‰
â”œâ”€ æœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…
â”œâ”€ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®éšå±¤ï¼ˆå…¥åŠ›æ™‚ã€ä¿å­˜å‰ï¼‰
â”œâ”€ ãƒ‡ãƒ¼ã‚¿æ“ä½œï¼ˆè¿½åŠ ã€å‰Šé™¤ã€æ›´æ–°ï¼‰
â”œâ”€ ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®é †åºï¼ˆ12ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
â”œâ”€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ï¼ˆç„¡åŠ¹åŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
â”œâ”€ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆåˆ†é¡ã€å‡¦ç†ã€ãƒ­ã‚°ï¼‰
â””â”€ çŠ¶æ…‹ç®¡ç†ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆå¤‰æ•°ã€getter/setterï¼‰
```

---

### 9.2 é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

1. **å®šå“¡ãƒã‚§ãƒƒã‚¯**: æœŸé–“å†…ã®ã™ã¹ã¦ã®æ—¥ã‚’ãƒã‚§ãƒƒã‚¯
2. **æœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯**: åŒã˜å±…å®¤ã§æœŸé–“ãŒé‡è¤‡ã—ãªã„ã‹
3. **å®šå“¡è¶…éã§ã‚‚ä¿å­˜å¯èƒ½**: å¼¾åŠ›é‹ç”¨ã€è­¦å‘Šã®ã¿
4. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†**: äºˆç´„è¿½åŠ ãƒ»å‰Šé™¤ãƒ»æ›´æ–°æ™‚ã«å¿…ãšç„¡åŠ¹åŒ–
5. **ã‚¤ãƒ™ãƒ³ãƒˆé †åº**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ â†’ ãƒ‡ãƒ¼ã‚¿æ›´æ–° â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ– â†’ UIæ›´æ–°

---

### 9.3 ãƒ†ã‚¹ãƒˆã™ã¹ãé …ç›®

```
å˜ä½“ãƒ†ã‚¹ãƒˆ:
â”œâ”€ countReservations() - å®šå“¡ã‚«ã‚¦ãƒ³ãƒˆã®æ­£ç¢ºæ€§
â”œâ”€ checkCapacity() - å®šå“¡ãƒã‚§ãƒƒã‚¯ã®æ­£ç¢ºæ€§
â”œâ”€ checkRoomConflict() - æœŸé–“é‡è¤‡ãƒã‚§ãƒƒã‚¯
â”œâ”€ validateDateRange() - æ—¥ä»˜ç¯„å›²ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â””â”€ getDateRange() - æ—¥ä»˜ç¯„å›²ã®ç”Ÿæˆ

çµ±åˆãƒ†ã‚¹ãƒˆ:
â”œâ”€ addReservation() - äºˆç´„è¿½åŠ ã®ä¸€é€£ã®æµã‚Œ
â”œâ”€ removeReservation() - äºˆç´„å‰Šé™¤ã®ä¸€é€£ã®æµã‚Œ
â”œâ”€ updateReservation() - äºˆç´„æ›´æ–°ã®ä¸€é€£ã®æµã‚Œ
â””â”€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ•´åˆæ€§

ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹:
â”œâ”€ å®šå“¡ã‚®ãƒªã‚®ãƒªã§ã®è¿½åŠ ï¼ˆ9äººç›®ï¼‰
â”œâ”€ æœŸé–“ã®å¢ƒç•Œï¼ˆå‰æ—¥ã€ç¿Œæ—¥ï¼‰
â”œâ”€ é•·æœŸé–“ã®äºˆç´„ï¼ˆ30æ—¥ï¼‰
â””â”€ æœˆã‚’ã¾ãŸãäºˆç´„
```

---

### 9.4 æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

æ³Šã¾ã‚Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­è¨ˆï¼ˆãƒ‡ãƒ¼ã‚¿ã€UIã€ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

**æ¬¡ã«ä½œæˆã™ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
1. **L2_è¨ªå•_ãƒ‡ãƒ¼ã‚¿æ§‹é€ .md** - è¨ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­è¨ˆ
2. **L2_è¨ªå•_UIè¨­è¨ˆ.md**
3. **L2_è¨ªå•_ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ.md**

---

## ğŸ“š æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­äº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«é€²ã‚“ã§ãã ã•ã„ã€‚

### æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**L2_è¨ªå•_ãƒ‡ãƒ¼ã‚¿æ§‹é€ .md**
- è¨ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®äºˆå®šãƒ‡ãƒ¼ã‚¿
- æ™‚é–“å¸¯åˆ¥ç®¡ç†
- å›æ•°ã‚«ã‚¦ãƒ³ãƒˆ

---

## ğŸ“ å‚è€ƒè³‡æ–™

- L2_æ³Šã¾ã‚Š_ãƒ‡ãƒ¼ã‚¿æ§‹é€ .mdï¼ˆTomariReservationã‚¯ãƒ©ã‚¹ï¼‰
- L2_æ³Šã¾ã‚Š_UIè¨­è¨ˆ.mdï¼ˆã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã€æœŸé–“é¸æŠï¼‰
- L1_æŠ€è¡“_å®Ÿè£…åˆ¶ç´„.mdï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰
- L2_é€šã„_ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ.mdï¼ˆé€šã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã®å¯¾æ¯”ï¼‰

---

## ğŸ“… æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | æ‹…å½“ |
|------|----------|---------|------|
| 2025-11-23 | 1.0 | åˆç‰ˆä½œæˆ | Claude |
| 2025-12-31 | 2.0 | ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ  | Claude |

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´12æœˆ31æ—¥
**æ¬¡å›æ›´æ–°äºˆå®š**: Phase 1å®Ÿè£…ä¸­ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åæ˜ æ™‚

---

## âš ï¸ è¨­è¨ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å“è³ªãƒã‚§ãƒƒã‚¯ï¼š

- [x] ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç«é †åºãŒæ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã‚‹
- [x] ã‚¤ãƒ™ãƒ³ãƒˆã®å„ªå…ˆé †ä½ãŒæ±ºã¾ã£ã¦ã„ã‚‹
- [x] ç«¶åˆãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒæ¤œè¨ã•ã‚Œã¦ã„ã‚‹ï¼ˆæœŸé–“é‡è¤‡ï¼‰
- [x] çŠ¶æ…‹é·ç§»ãŒæ˜ç¢ºï¼ˆæœŸé–“é¸æŠã®æµã‚Œï¼‰
- [x] å„çŠ¶æ…‹ã§ã®æŒ™å‹•ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [x] ã‚¨ãƒ©ãƒ¼æ™‚ã®çŠ¶æ…‹å¾©æ—§æ–¹æ³•ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹

---

**ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­äº†ã—ãŸã‚‰ã€INDEX_ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹æˆ.md ã«æˆ»ã‚Šã€æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«é€²ã‚“ã§ãã ã•ã„ã€‚**  