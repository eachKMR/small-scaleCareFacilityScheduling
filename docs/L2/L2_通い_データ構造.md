# L2_通い_データ構造

**作成日**: 2025年11月23日  
**カテゴリ**: 第2層 - セクション別  
**バージョン**: 5.0  
**更新日**: 2025年12月31日

---

## 📖 このドキュメントについて

このドキュメントは、**通いセクションのデータ構造**を定義します。

### v5.0での重大な変更

**問題**: v4.0では`tomariPeriod`が単一オブジェクトで、1人が1ヶ月に1回しか泊まれなかった

**解決**: `UserScheduleData`から`tomariPeriod`を削除
- 泊まり情報は`TomariReservation`のみで管理（Single Source of Truth）
- 通いUIは`TomariReservation`を直接読む（複数期間に自然対応）
- **UIクラスは複数のデータクラスを扱ってOK**という原則に従う

### v4.0での主要な変更（参考）

1. **通い記号の簡略化**
   - 前半（◓）・後半（◒）を削除
   - 終日（○）のみを使用
   - ただし、前半・後半は引き続き利用可能（利用者設定で）

2. **泊まり期間の統合管理**
   - 通いセクションで泊まり期間も表示
   - 罫線（青/薄青）で泊まりを表現
   - 泊まり期間内は自動的に○が付く

### 対象読者

- 通いセクションの実装担当者
- データベース設計担当者
- テスト担当者

### 読了後に理解できること

- 通いデータ構造（`UserScheduleData`）
- **泊まりデータ（`TomariReservation`）との関係**
- デフォルト○の表示ロジック
- バリデーションルール
- 型変換の責任分担

---

## 1. データモデル概要

### 1.1 責務

**通いセクションが管理するデータ**:
- 利用者ごとの通いサービスの予定（`UserScheduleData`）

**通いセクションが参照するデータ**:
- **泊まり予約（`TomariReservation`）** - 罫線表示とデフォルト○のため

**重要な設計原則**:
- データクラス（`UserScheduleData`）は独立
- UIクラス（`KayoiUI`）は複数のデータクラスを扱ってOK
- 泊まり情報は`TomariReservation`のみ（Single Source of Truth）

---

### 1.2 データの粒度

#### 通い情報

```
1レコード = 1人 × 1日 × 通い情報

ただし、泊まり期間内でkayoiがnullの場合は
レコードを作らず、表示時にデフォルト○を表示
```

**例**:
```javascript
// 安藤さんが11月25日に終日利用（泊まりなし）
{
  userId: "user001",
  date: "2025-11-25",
  kayoi: "終日"
}

// 安藤さんが11月26日に前半のみ利用（泊まりなし）
{
  userId: "user001",
  date: "2025-11-26",
  kayoi: "前半"
}
```

#### 泊まり情報（参照のみ）

```
通いセクションは TomariReservation を参照する
1レコード = 1回の泊まり予約
```

**例**:
```javascript
// 安藤さんが11月15日〜18日に泊まり（1号室）
{
  id: "tomari_001",
  userId: "user001",
  roomId: "room01",
  startDate: "2025-11-15",
  endDate: "2025-11-18"
}

// 安藤さんが11月25日〜27日にも泊まり（2号室）
{
  id: "tomari_002",
  userId: "user001",
  roomId: "room02",
  startDate: "2025-11-25",
  endDate: "2025-11-27"
}
```

**重要**: 1人が1ヶ月に複数回泊まることは普通にある

---

## 2. データ構造定義

### 2.1 利用者ごとのデータ構造

#### UserScheduleData クラス

| プロパティ名 | 型 | 必須 | デフォルト値 | 説明 |
|------------|----|----|----------|------|
| **userId** | `string` | ✓ | - | 利用者ID（例: `"user001"`） |
| **kayoiSchedule** | `Map<string, KayoiType>` | ✓ | `{}` | 日付ごとの通い情報 |
| **updatedAt** | `string` | ✓ | 自動生成 | 更新日時（ISO形式） |

**重要な変更（v5.0）**:
- ~~`tomariPeriod`~~ を削除
- 泊まり情報は`TomariReservation`のみで管理

---

#### KayoiType（通い情報）

```typescript
type KayoiType = null | "終日" | "前半" | "後半";
```

| 値 | 意味 | 記号 | 使用頻度 |
|----|----|------|---------|
| `null` | デフォルト（泊まり期間内なら○） | ○ | 高 |
| `"終日"` | 明示的な終日通い | ○ | 高 |
| `"前半"` | 午前のみ通い | ◓ | 低 |
| `"後半"` | 午後のみ通い | ◒ | 低 |

**重要な仕様**:
- **泊まり期間内でkayoiがnull → デフォルト○を表示**
- **泊まり期間外でkayoiがnull → 空欄を表示**
- 明示的に設定されたkayoi値は常にその通りに表示

---

### 2.2 泊まりデータ（TomariReservation）

**通いUIが参照するデータ**:

| プロパティ名 | 型 | 説明 |
|------------|----|----|
| **id** | `string` | 予約ID |
| **userId** | `string` | 利用者ID |
| **roomId** | `string \| null` | 居室ID（null=未割当） |
| **startDate** | `string` | 入所日（`"YYYY-MM-DD"` 形式） |
| **endDate** | `string` | 退所日（`"YYYY-MM-DD"` 形式） |

**詳細**: `docs/L2_泊まり_データ構造.md v2.0` 参照

---

### 2.3 具体例

#### 例1：泊まりのみ（日中は自宅）

**データ**:
```javascript
// UserScheduleData
{
  userId: "user001",
  kayoiSchedule: {
    "2025-11-15": null,  // 空欄に明示的に変更
    "2025-11-16": null,
    "2025-11-17": null,
    "2025-11-18": null
  }
}

// TomariReservation（通いUIが参照）
{
  id: "tomari_001",
  userId: "user001",
  roomId: "room01",
  startDate: "2025-11-15",
  endDate: "2025-11-18"
}
```

**表示**:
```
        15  16  17  18
user001  -   -   -   -
        ━━  ━━  ━━  ━━
        青  青  青  薄青
```

---

#### 例2：泊まり+通い（デフォルト）

**データ**:
```javascript
// UserScheduleData
{
  userId: "user001",
  kayoiSchedule: {
    // すべてnull（デフォルト○）
  }
}

// TomariReservation
{
  id: "tomari_001",
  userId: "user001",
  roomId: "room01",
  startDate: "2025-11-15",
  endDate: "2025-11-18"
}
```

**表示**:
```
        15  16  17  18
user001  ○  ○  ○  ○
        ━━  ━━  ━━  ━━
        青  青  青  薄青
```

---

#### 例3：1ヶ月に複数回泊まる（v5.0で対応）

**データ**:
```javascript
// UserScheduleData
{
  userId: "user001",
  kayoiSchedule: {}  // すべてデフォルト
}

// TomariReservation（2件）
[
  {
    id: "tomari_001",
    userId: "user001",
    roomId: "room01",
    startDate: "2025-11-06",
    endDate: "2025-11-08"
  },
  {
    id: "tomari_002",
    userId: "user001",
    roomId: "room02",
    startDate: "2025-11-12",
    endDate: "2025-11-14"
  }
]
```

**表示**:
```
        6   7   8   9  10  11  12  13  14
user001  ○  ○  ○   -   -   -   ○   ○   ○
        ━━  ━━  ━━              ━━  ━━  ━━
        青  青  薄青             青  青  薄青
```

---

### 2.4 型に関する重要な注意

#### 日付は文字列

**日付は文字列（"YYYY-MM-DD"）を使用**

```javascript
✅ 正しい
const date = "2025-11-15";

❌ 間違い
const date = new Date("2025-11-15");  // Date型は使わない
```

**理由**:
- L1_技術_実装制約.md の「1.1 日付の扱い」に準拠
- HTMLの`data-date`属性との比較が容易
- タイムゾーンの問題を回避

---

## 3. 表示ロジック

### 3.1 セルの表示記号を決定する関数

```javascript
/**
 * セルに表示する記号を取得
 * @param {UserScheduleData} userData - 利用者のスケジュールデータ
 * @param {string} date - 日付（YYYY-MM-DD）
 * @param {TomariReservation[]} tomariReservations - 全泊まり予約
 * @returns {string} 表示記号（"", "○", "◓", "◒"）
 */
function getDisplaySymbol(userData, date, tomariReservations) {
  // 泊まり期間内かチェック（複数対応）
  const isInTomariPeriod = tomariReservations.some(r =>
    r.userId === userData.userId &&
    date >= r.startDate &&
    date <= r.endDate
  );
  
  // 明示的なkayoi設定を確認
  const kayoi = userData.kayoiSchedule[date];
  
  // ケース1: 明示的に設定されている
  if (kayoi === "終日") return "○";
  if (kayoi === "前半") return "◓";
  if (kayoi === "後半") return "◒";
  if (kayoi === null && !isInTomariPeriod) return "";  // 明示的に空欄
  
  // ケース2: 泊まり期間内でkayoi未設定 → デフォルト○
  if (isInTomariPeriod && kayoi === undefined) {
    return "○";
  }
  
  // ケース3: その他 → 空欄
  return "";
}
```

---

### 3.2 罫線の状態を決定する関数

```javascript
/**
 * セルの罫線状態を取得
 * @param {string} userId - 利用者ID
 * @param {string} date - 日付（YYYY-MM-DD）
 * @param {TomariReservation[]} tomariReservations - 全泊まり予約
 * @returns {string} 罫線状態（"none", "stay", "checkout"）
 */
function getBorderState(userId, date, tomariReservations) {
  // その日の泊まり予約を検索
  const reservation = tomariReservations.find(r =>
    r.userId === userId &&
    date >= r.startDate &&
    date <= r.endDate
  );
  
  if (!reservation) return "none";
  
  // 入所日〜退所日前日: 青罫線（stay）
  if (date < reservation.endDate) {
    return "stay";
  }
  
  // 退所日: 薄青罫線（checkout）
  if (date === reservation.endDate) {
    return "checkout";
  }
  
  return "none";
}
```

**重要**: 複数の泊まり期間がある場合、最初に見つかったものを使用

---

### 3.3 CSS適用例

```css
/* 通常の罫線 */
.schedule-cell {
  border-bottom: 1px solid #ddd;
}

/* 入所・連泊（青） */
.schedule-cell.tomari-stay {
  border-bottom: 4px solid #2196f3;
}

/* 退所（薄青） */
.schedule-cell.tomari-checkout {
  border-bottom: 4px solid rgba(33, 150, 243, 0.3);
}
```

---

## 4. バリデーション

### 4.1 通い情報のバリデーション

```javascript
/**
 * 通い情報のバリデーション
 * @param {string} date - 日付
 * @param {KayoiType} kayoi - 通い情報
 * @returns {Object} { valid: boolean, errors: string[] }
 */
function validateKayoi(date, kayoi) {
  const errors = [];
  
  // 日付の形式チェック
  const datePattern = /^\d{4}-\d{2}-\d{2}$/;
  if (!datePattern.test(date)) {
    errors.push('日付の形式が不正です（YYYY-MM-DD）');
  }
  
  // kayoiの値チェック
  const validKayoiValues = [null, "終日", "前半", "後半"];
  if (!validKayoiValues.includes(kayoi)) {
    errors.push('通い情報の値が不正です');
  }
  
  return {
    valid: errors.length === 0,
    errors: errors
  };
}
```

---

## 5. データ操作

### 5.1 通い情報の設定

```javascript
/**
 * 通い情報を設定
 * @param {UserScheduleData} userData - 利用者データ
 * @param {string} date - 日付
 * @param {KayoiType} kayoi - 通い情報
 * @returns {Object} { success: boolean, errors?: string[] }
 */
function setKayoi(userData, date, kayoi) {
  // バリデーション
  const validation = validateKayoi(date, kayoi);
  if (!validation.valid) {
    return { success: false, errors: validation.errors };
  }
  
  // 設定
  if (kayoi === null || kayoi === undefined) {
    // nullまたはundefinedなら削除（デフォルトに戻す）
    delete userData.kayoiSchedule[date];
  } else {
    userData.kayoiSchedule[date] = kayoi;
  }
  
  userData.updatedAt = new Date().toISOString();
  
  // イベント発火
  dispatchEvent(new CustomEvent('kayoi:updated', {
    detail: { userId: userData.userId, date, kayoi }
  }));
  
  return { success: true };
}
```

---

### 5.2 通い情報の取得

```javascript
/**
 * 通い情報を取得
 * @param {UserScheduleData} userData - 利用者データ
 * @param {string} date - 日付
 * @returns {KayoiType}
 */
function getKayoi(userData, date) {
  return userData.kayoiSchedule[date];
}
```

---

### 5.3 通い情報の削除

```javascript
/**
 * 通い情報を削除
 * @param {UserScheduleData} userData - 利用者データ
 * @param {string} date - 日付
 * @returns {Object} { success: boolean }
 */
function clearKayoi(userData, date) {
  delete userData.kayoiSchedule[date];
  userData.updatedAt = new Date().toISOString();
  
  // イベント発火
  dispatchEvent(new CustomEvent('kayoi:cleared', {
    detail: { userId: userData.userId, date }
  }));
  
  return { success: true };
}
```

---

## 6. 型変換

### 6.1 JSON ⇔ オブジェクト

#### エクスポート（オブジェクト → JSON）

```javascript
function toJSON(userData) {
  return {
    userId: userData.userId,
    kayoiSchedule: Object.fromEntries(
      Object.entries(userData.kayoiSchedule)
    ),
    updatedAt: userData.updatedAt
  };
}
```

#### インポート（JSON → オブジェクト）

```javascript
function fromJSON(json) {
  return {
    userId: json.userId,
    kayoiSchedule: json.kayoiSchedule || {},
    updatedAt: json.updatedAt
  };
}
```

---

### 6.2 CSV変換

#### エクスポート（データ → CSV）

```javascript
function exportToCSV(allUserData) {
  const rows = [];
  
  for (const userData of allUserData) {
    // 通い情報の行
    for (const [date, kayoi] of Object.entries(userData.kayoiSchedule)) {
      rows.push({
        利用者ID: userData.userId,
        種別: '通い',
        日付: date,
        内容: kayoi
      });
    }
  }
  
  return convertToCSV(rows);
}
```

**注意**: 泊まり情報は別途`TomariReservation`からエクスポート

---

## 7. まとめ

### 7.1 このドキュメントで定義したこと

```
✅ 定義したこと
├─ 通いデータ構造（UserScheduleData）
├─ 泊まりデータ参照（TomariReservation）
├─ デフォルト○の表示ロジック
├─ 罫線による泊まり表現
├─ バリデーションルール
└─ データ操作の方法
```

---

### 7.2 重要なポイント

1. **日付は文字列**（"YYYY-MM-DD"）
2. **泊まり情報はTomariReservationのみ**（Single Source of Truth）
3. **1人が1ヶ月に複数回泊まることに対応**
4. **通いUIはTomariReservationを参照**（UIクラスは複数データを扱ってOK）
5. **泊まり期間内でkayoi未設定 → デフォルト○**
6. **前半・後半は引き続き使用可能**（利用者が明示的に設定）

---

### 7.3 v4.0からの主な変更

| 項目 | v4.0 | v5.0 |
|------|------|------|
| 泊まり情報 | tomariPeriod（単一） | TomariReservation参照 |
| 複数回泊まり | **不可** | **対応** |
| データ重複 | あり | なし（Single Source of Truth） |

---

### 7.4 次のステップ

このデータ構造に基づいて、UI設計とロジック設計を行います：

1. **L2_通い_UI設計.md v4.1** - 複数泊まり期間の罫線表示
2. **L2_通い_ロジック.md v3.1** - 複数TomariReservationの扱い

---

## 📚 次に読むべきドキュメント

このドキュメントを読了したら、以下のドキュメントに進んでください。

### 次のドキュメント

**L2_通い_UI設計.md v4.1**
- カレンダーUI設計
- 短押し/長押しの操作
- 罫線による泊まり表現（複数期間対応）

---

## 📝 参考資料

- L1_技術_実装制約.md（データ型規約、セクション独立性）
- L0_業務_定員の法的枠組み.md（通い定員15人の根拠）
- L2_泊まり_データ構造.md v2.0（TomariReservationの詳細）

---

## 📅 更新履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|----------|---------|------|
| 2025-11-23 | 1.0 | 初版作成 | Claude |
| 2025-11-23 | 2.0 | startTime/endTime追加、時刻バリデーション追加 | Claude |
| 2025-11-27 | 3.0 | pickupType/dropoffType追加、送迎タイプ管理機能追加 | Claude |
| 2025-12-19 | 4.0 | 泊まり期間統合、デフォルト○、通い記号簡略化 | Claude |
| 2025-12-31 | 5.0 | **tomariPeriod削除、TomariReservation参照、複数泊まり対応** | Claude |

---

**最終更新**: 2025年12月31日  
**次回更新予定**: Phase 1実装中のフィードバック反映時

---

## ⚠️ 設計チェックリスト

このドキュメントの品質チェック（v5.0）：

- [x] すべてのプロパティの型が明記されている
- [x] Date型と文字列の使い分けが明確
- [x] 型変換の責任が明確（どこで変換するか）
- [x] null/undefinedの扱いが定義されている
- [x] バリデーションルールが網羅されている
- [x] デフォルト○の表示ロジックが明確
- [x] **複数泊まり期間に対応**
- [x] **Single Source of Truthの原則に従う**

---

**このドキュメントを読了したら、INDEX_ドキュメント構成.md に戻り、次のドキュメントに進んでください。**