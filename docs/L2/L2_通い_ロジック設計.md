# L2_é€šã„_ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ

**ä½œæˆæ—¥**: 2025å¹´11æœˆ23æ—¥  
**ã‚«ãƒ†ã‚´ãƒª**: ç¬¬2å±¤ - ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 3.0  
**æ›´æ–°æ—¥**: 2025å¹´12æœˆ19æ—¥

---

## ğŸ“– ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€**é€šã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ**ã‚’å®šç¾©ã—ã¾ã™ã€‚

### v3.0ã§ã®ä¸»è¦ãªå¤‰æ›´

1. **é•·æŠ¼ã—æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ã®è¿½åŠ **
   - 0.8ç§’ã®ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
   - mousedown/mouseup/mouseleave ã®å‡¦ç†

2. **ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã®è¿½åŠ **
   - æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰/ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
   - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é…ç½®è¨ˆç®—

3. **æœŸé–“é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã®è¿½åŠ **
   - èµ·ç‚¹ã®æ±ºå®š
   - å…¥æ‰€æ—¥ãƒ»é€€æ‰€æ—¥ã®æ±ºå®š

4. **ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†ã®è¿½åŠ **
   - ã‚¯ãƒªã‚¢â‡”å…ƒã«æˆ»ã™
   - ç¢ºå®š/æˆ»ã‚‹ ã®è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ

5. **å‰Šé™¤å‡¦ç†ã®è¿½åŠ **
   - æ³Šã¾ã‚ŠæœŸé–“ã¨é€šã„æƒ…å ±ã®ä¸€æ‹¬å‰Šé™¤

### å¯¾è±¡èª­è€…

- é€šã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…æ‹…å½“è€…
- ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆæ‹…å½“è€…
- ãƒ†ã‚¹ãƒˆæ‹…å½“è€…

### èª­äº†å¾Œã«ç†è§£ã§ãã‚‹ã“ã¨

- é•·æŠ¼ã—æ¤œå‡ºã®å®Ÿè£…æ–¹æ³•
- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
- æœŸé–“é¸æŠãƒ­ã‚¸ãƒƒã‚¯
- ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†
- ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®æµã‚Œ

---

## 1. å…¨ä½“æ§‹æˆ

### 1.1 KayoiSection ã‚¯ãƒ©ã‚¹

```javascript
class KayoiSection {
  #userData;              // Map<userId, UserScheduleData>
  #gridElement;           // HTMLElement
  #calendarElement;       // HTMLElement
  #longPressTimer;        // number | null
  #calendarState;         // CalendarState | null
  
  constructor(gridElement, calendarElement) {
    this.#userData = new Map();
    this.#gridElement = gridElement;
    this.#calendarElement = calendarElement;
    this.#longPressTimer = null;
    this.#calendarState = null;
    
    this.#initializeEventListeners();
  }
  
  // ... ãƒ¡ã‚½ãƒƒãƒ‰
}
```

---

### 1.2 CalendarState ã‚¯ãƒ©ã‚¹

```javascript
class CalendarState {
  mode;                   // 'add' | 'edit'
  userId;                 // string
  origin;                 // string (YYYY-MM-DD)
  checkInDate;            // string | null
  checkOutDate;           // string | null
  originalCheckInDate;    // string | null
  originalCheckOutDate;   // string | null
  isCleared;              // boolean
  
  constructor(mode, userId, origin, tomariPeriod = null) {
    this.mode = mode;
    this.userId = userId;
    this.origin = origin;
    
    if (tomariPeriod) {
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
      this.checkInDate = tomariPeriod.checkInDate;
      this.checkOutDate = tomariPeriod.checkOutDate;
      this.originalCheckInDate = tomariPeriod.checkInDate;
      this.originalCheckOutDate = tomariPeriod.checkOutDate;
    } else {
      // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
      this.checkInDate = null;
      this.checkOutDate = null;
      this.originalCheckInDate = null;
      this.originalCheckOutDate = null;
    }
    
    this.isCleared = false;
  }
  
  hasChanges() {
    return (
      this.isCleared ||
      this.checkInDate !== this.originalCheckInDate ||
      this.checkOutDate !== this.originalCheckOutDate
    );
  }
}
```

---

## 2. çŸ­æŠ¼ã—å‡¦ç†

### 2.1 ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†

```javascript
#initializeEventListeners() {
  this.#gridElement.addEventListener('click', (e) => {
    const cell = e.target.closest('.schedule-cell');
    if (!cell) return;
    
    this.#handleShortClick(cell);
  });
}

#handleShortClick(cell) {
  const userId = cell.dataset.userId;
  const date = cell.dataset.date;
  
  // ç¾åœ¨ã®è¨˜å·ã‚’å–å¾—
  const symbolElement = cell.querySelector('.symbol');
  const currentSymbol = symbolElement.textContent.trim();
  
  // æ¬¡ã®è¨˜å·ã‚’æ±ºå®š
  const nextSymbol = this.#getNextSymbol(currentSymbol);
  
  // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  const userData = this.#userData.get(userId);
  if (nextSymbol === '') {
    // ç©ºæ¬„
    delete userData.kayoiSchedule[date];
  } else {
    userData.kayoiSchedule[date] = this.#symbolToKayoiType(nextSymbol);
  }
  
  // è¡¨ç¤ºæ›´æ–°
  symbolElement.textContent = nextSymbol;
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  cell.classList.add('updated');
  setTimeout(() => cell.classList.remove('updated'), 200);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  this.dispatchEvent(new CustomEvent('kayoi:updated', {
    detail: { userId, date, symbol: nextSymbol }
  }));
}

#getNextSymbol(currentSymbol) {
  const sequence = ['', 'â—‹', 'â—“', 'â—’'];
  const index = sequence.indexOf(currentSymbol);
  return sequence[(index + 1) % sequence.length];
}

#symbolToKayoiType(symbol) {
  if (symbol === 'â—‹') return 'çµ‚æ—¥';
  if (symbol === 'â—“') return 'å‰åŠ';
  if (symbol === 'â—’') return 'å¾ŒåŠ';
  return null;
}
```

---

## 3. é•·æŠ¼ã—å‡¦ç†

### 3.1 é•·æŠ¼ã—æ¤œå‡º

```javascript
#initializeEventListeners() {
  // ... çŸ­æŠ¼ã—å‡¦ç†
  
  // é•·æŠ¼ã—å‡¦ç†
  this.#gridElement.addEventListener('mousedown', (e) => {
    const cell = e.target.closest('.schedule-cell');
    if (!cell) return;
    
    // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    this.#longPressTimer = setTimeout(() => {
      this.#handleLongPress(cell);
    }, 800); // 0.8ç§’
  });
  
  this.#gridElement.addEventListener('mouseup', () => {
    // ã‚¿ã‚¤ãƒãƒ¼ã‚¯ãƒªã‚¢ï¼ˆçŸ­æŠ¼ã—ï¼‰
    if (this.#longPressTimer) {
      clearTimeout(this.#longPressTimer);
      this.#longPressTimer = null;
    }
  });
  
  this.#gridElement.addEventListener('mouseleave', () => {
    // ãƒã‚¦ã‚¹ãŒé›¢ã‚ŒãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    if (this.#longPressTimer) {
      clearTimeout(this.#longPressTimer);
      this.#longPressTimer = null;
    }
  });
}
```

---

### 3.2 é•·æŠ¼ã—æ™‚ã®å‡¦ç†

```javascript
#handleLongPress(cell) {
  const userId = cell.dataset.userId;
  const date = cell.dataset.date;
  const userData = this.#userData.get(userId);
  
  if (!userData) return;
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
  if (userData.tomariPeriod) {
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    this.#showCalendarEditMode(cell, userId, date, userData.tomariPeriod);
  } else {
    // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
    this.#showCalendarAddMode(cell, userId, date);
  }
}
```

---

## 4. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯

### 4.1 æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰

```javascript
#showCalendarAddMode(cell, userId, date) {
  // çŠ¶æ…‹ã‚’ä½œæˆ
  this.#calendarState = new CalendarState('add', userId, date);
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é…ç½®
  this.#positionCalendar(cell);
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
  this.#renderCalendar();
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
  this.#calendarElement.style.display = 'block';
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  this.dispatchEvent(new CustomEvent('calendar:opened', {
    detail: { mode: 'add', userId, date }
  }));
}
```

---

### 4.2 ç·¨é›†ãƒ¢ãƒ¼ãƒ‰

```javascript
#showCalendarEditMode(cell, userId, date, tomariPeriod) {
  // çŠ¶æ…‹ã‚’ä½œæˆ
  this.#calendarState = new CalendarState(
    'edit',
    userId,
    date,
    tomariPeriod
  );
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é…ç½®
  this.#positionCalendar(cell);
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
  this.#renderCalendar();
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
  this.#calendarElement.style.display = 'block';
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  this.dispatchEvent(new CustomEvent('calendar:opened', {
    detail: { mode: 'edit', userId, date, tomariPeriod }
  }));
}
```

---

### 4.3 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é…ç½®

```javascript
#positionCalendar(cell) {
  const cellRect = cell.getBoundingClientRect();
  
  // åŸºæœ¬ä½ç½®ï¼šã‚»ãƒ«ã®å³ä¸‹
  let left = cellRect.right + 10;
  let top = cellRect.top;
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚µã‚¤ã‚º
  const calendarWidth = 260;
  const calendarHeight = 300;
  
  // ç”»é¢ç«¯ãƒã‚§ãƒƒã‚¯
  if (left + calendarWidth > window.innerWidth) {
    // å·¦å´ã«è¡¨ç¤º
    left = cellRect.left - calendarWidth - 10;
  }
  
  if (top + calendarHeight > window.innerHeight) {
    // ä¸Šã«èª¿æ•´
    top = window.innerHeight - calendarHeight - 10;
  }
  
  // ä¸Šç«¯ã‚’è¶…ãˆã‚‹å ´åˆ
  if (top < 10) {
    top = 10;
  }
  
  // ä½ç½®ã‚’è¨­å®š
  this.#calendarElement.style.left = left + 'px';
  this.#calendarElement.style.top = top + 'px';
}
```

---

## 5. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»

### 5.1 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æç”»

```javascript
#renderCalendar() {
  const state = this.#calendarState;
  if (!state) return;
  
  // æœˆã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
  const monthTitle = this.#calendarElement.querySelector('.month-title');
  const [year, month] = state.origin.split('-');
  monthTitle.textContent = `${year}å¹´ ${parseInt(month)}æœˆ`;
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚»ãƒ«ã‚’ç”Ÿæˆ
  const calendarBody = this.#calendarElement.querySelector('.calendar-table tbody');
  calendarBody.innerHTML = this.#generateCalendarCells(year, month);
  
  // ã‚»ãƒ«ã«ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
  this.#applyCalendarCellClasses();
  
  // ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
  this.#updateCalendarButtons();
}
```

---

### 5.2 æ—¥ä»˜ã‚»ãƒ«ã®ç”Ÿæˆ

```javascript
#generateCalendarCells(year, month) {
  const firstDay = new Date(year, month - 1, 1);
  const lastDay = new Date(year, month, 0);
  const firstDayOfWeek = firstDay.getDay();
  const daysInMonth = lastDay.getDate();
  
  let html = '<tr>';
  
  // å‰æœˆã®ç©ºæ¬„
  for (let i = 0; i < firstDayOfWeek; i++) {
    html += '<td></td>';
  }
  
  // ä»Šæœˆã®æ—¥ä»˜
  for (let day = 1; day <= daysInMonth; day++) {
    const date = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    
    html += `<td class="calendar-cell" data-date="${date}">${day}</td>`;
    
    // åœŸæ›œæ—¥ã§æ”¹è¡Œ
    if ((firstDayOfWeek + day) % 7 === 0) {
      html += '</tr><tr>';
    }
  }
  
  html += '</tr>';
  return html;
}
```

---

### 5.3 ã‚»ãƒ«ã¸ã®ã‚¯ãƒ©ã‚¹é©ç”¨

```javascript
#applyCalendarCellClasses() {
  const state = this.#calendarState;
  const cells = this.#calendarElement.querySelectorAll('.calendar-cell');
  
  cells.forEach(cell => {
    const date = cell.dataset.date;
    
    // ãƒªã‚»ãƒƒãƒˆ
    cell.classList.remove('origin', 'checkin', 'checkout', 'in-period', 'deleting');
    
    if (state.isCleared) {
      // ã‚¯ãƒªã‚¢çŠ¶æ…‹
      if (date >= state.originalCheckInDate && date <= state.originalCheckOutDate) {
        cell.classList.add('deleting');
      }
    } else if (state.mode === 'add' && !state.checkInDate) {
      // æ–°è¦è¿½åŠ ï¼šèµ·ç‚¹ã®ã¿
      if (date === state.origin) {
        cell.classList.add('origin');
      }
    } else if (state.checkInDate && state.checkOutDate) {
      // æœŸé–“ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
      if (date === state.checkInDate) {
        cell.classList.add('checkin');
      }
      if (date === state.checkOutDate) {
        cell.classList.add('checkout');
      }
      if (date > state.checkInDate && date < state.checkOutDate) {
        cell.classList.add('in-period');
      }
    }
  });
}
```

---

## 6. æœŸé–“é¸æŠãƒ­ã‚¸ãƒƒã‚¯

### 6.1 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒ«ã®ã‚¯ãƒªãƒƒã‚¯

```javascript
#initializeCalendarEventListeners() {
  this.#calendarElement.addEventListener('click', (e) => {
    const cell = e.target.closest('.calendar-cell');
    if (!cell) return;
    
    this.#handleCalendarCellClick(cell);
  });
}

#handleCalendarCellClick(cell) {
  const state = this.#calendarState;
  if (!state) return;
  
  const clickedDate = cell.dataset.date;
  
  if (state.mode === 'add') {
    // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
    this.#handleAddModeClick(clickedDate);
  } else if (state.mode === 'edit') {
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    this.#handleEditModeClick(clickedDate);
  }
  
  // å†æç”»
  this.#renderCalendar();
}
```

---

### 6.2 æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯

```javascript
#handleAddModeClick(clickedDate) {
  const state = this.#calendarState;
  
  if (!state.checkInDate) {
    // åˆå›ã‚¯ãƒªãƒƒã‚¯
    if (clickedDate < state.origin) {
      // èµ·ç‚¹ã‚ˆã‚Šå‰ â†’ èµ·ç‚¹ãŒé€€æ‰€æ—¥
      state.checkInDate = clickedDate;
      state.checkOutDate = state.origin;
    } else if (clickedDate > state.origin) {
      // èµ·ç‚¹ã‚ˆã‚Šå¾Œ â†’ èµ·ç‚¹ãŒå…¥æ‰€æ—¥
      state.checkInDate = state.origin;
      state.checkOutDate = clickedDate;
    } else {
      // èµ·ç‚¹ã¨åŒã˜ â†’ 1æ³Šï¼ˆç¿Œæ—¥ãŒé€€æ‰€æ—¥ï¼‰
      state.checkInDate = clickedDate;
      state.checkOutDate = this.#addDays(clickedDate, 1);
    }
  } else {
    // æœŸé–“å¤‰æ›´
    const distToCheckIn = Math.abs(
      this.#dateDiff(clickedDate, state.checkInDate)
    );
    const distToCheckOut = Math.abs(
      this.#dateDiff(clickedDate, state.checkOutDate)
    );
    
    if (distToCheckIn < distToCheckOut) {
      state.checkInDate = clickedDate;
    } else {
      state.checkOutDate = clickedDate;
    }
    
    // å…¥æ‰€æ—¥ > é€€æ‰€æ—¥ã®å ´åˆã¯å…¥ã‚Œæ›¿ãˆ
    if (state.checkInDate > state.checkOutDate) {
      [state.checkInDate, state.checkOutDate] = 
        [state.checkOutDate, state.checkInDate];
    }
  }
}
```

---

### 6.3 ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯

```javascript
#handleEditModeClick(clickedDate) {
  const state = this.#calendarState;
  
  // ã©ã¡ã‚‰ã‹ã®æ ã«è¿‘ã„æ–¹ã‚’å¤‰æ›´
  const distToCheckIn = Math.abs(
    this.#dateDiff(clickedDate, state.checkInDate)
  );
  const distToCheckOut = Math.abs(
    this.#dateDiff(clickedDate, state.checkOutDate)
  );
  
  if (distToCheckIn < distToCheckOut) {
    state.checkInDate = clickedDate;
  } else {
    state.checkOutDate = clickedDate;
  }
  
  // å…¥æ‰€æ—¥ > é€€æ‰€æ—¥ã®å ´åˆã¯å…¥ã‚Œæ›¿ãˆ
  if (state.checkInDate > state.checkOutDate) {
    [state.checkInDate, state.checkOutDate] = 
      [state.checkOutDate, state.checkInDate];
  }
}
```

---

## 7. ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†

### 7.1 ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«ã®æ›´æ–°

```javascript
#updateCalendarButtons() {
  const state = this.#calendarState;
  if (!state) return;
  
  const clearBtn = this.#calendarElement.querySelector('#calendar-clear-btn');
  const confirmBtn = this.#calendarElement.querySelector('#calendar-confirm-btn');
  
  // å·¦ãƒœã‚¿ãƒ³ï¼ˆã‚¯ãƒªã‚¢/å…ƒã«æˆ»ã™ï¼‰
  if (state.isCleared) {
    clearBtn.textContent = 'å…ƒã«æˆ»ã™';
  } else {
    clearBtn.textContent = 'ã‚¯ãƒªã‚¢';
  }
  
  // å³ãƒœã‚¿ãƒ³ï¼ˆç¢ºå®š/æˆ»ã‚‹ï¼‰
  if (state.hasChanges()) {
    confirmBtn.textContent = 'ç¢ºå®š';
  } else {
    confirmBtn.textContent = 'æˆ»ã‚‹';
  }
}
```

---

### 7.2 ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®å‡¦ç†

```javascript
#initializeCalendarEventListeners() {
  // ... ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯
  
  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
  const clearBtn = this.#calendarElement.querySelector('#calendar-clear-btn');
  clearBtn.addEventListener('click', () => {
    this.#handleClearButton();
  });
}

#handleClearButton() {
  const state = this.#calendarState;
  if (!state) return;
  
  if (state.isCleared) {
    // å…ƒã«æˆ»ã™
    state.checkInDate = state.originalCheckInDate;
    state.checkOutDate = state.originalCheckOutDate;
    state.isCleared = false;
  } else {
    // ã‚¯ãƒªã‚¢
    state.isCleared = true;
  }
  
  // å†æç”»
  this.#renderCalendar();
}
```

---

### 7.3 ç¢ºå®š/æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†

```javascript
#initializeCalendarEventListeners() {
  // ... ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
  
  // ç¢ºå®š/æˆ»ã‚‹ãƒœã‚¿ãƒ³
  const confirmBtn = this.#calendarElement.querySelector('#calendar-confirm-btn');
  confirmBtn.addEventListener('click', () => {
    this.#handleConfirmButton();
  });
}

#handleConfirmButton() {
  const state = this.#calendarState;
  if (!state) return;
  
  if (confirmBtn.textContent === 'ç¢ºå®š') {
    // å¤‰æ›´ã‚’ç¢ºå®š
    if (state.isCleared) {
      // æ³Šã¾ã‚ŠæœŸé–“å‰Šé™¤
      this.#clearTomariPeriod(state.userId);
    } else {
      // æ³Šã¾ã‚ŠæœŸé–“æ›´æ–°
      this.#setTomariPeriod(
        state.userId,
        state.checkInDate,
        state.checkOutDate
      );
    }
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‰ã˜ã‚‹
    this.#hideCalendar();
    
    // ã‚°ãƒªãƒƒãƒ‰ã‚’å†æç”»
    this.#refreshGrid();
    
  } else {
    // æˆ»ã‚‹ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
    this.#hideCalendar();
  }
}
```

---

## 8. ãƒ‡ãƒ¼ã‚¿æ›´æ–°

### 8.1 æ³Šã¾ã‚ŠæœŸé–“ã®è¨­å®š

```javascript
#setTomariPeriod(userId, checkInDate, checkOutDate) {
  const userData = this.#userData.get(userId);
  if (!userData) return;
  
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (checkInDate >= checkOutDate) {
    alert('å…¥æ‰€æ—¥ã¯é€€æ‰€æ—¥ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
    return;
  }
  
  // æ³Šã¾ã‚ŠæœŸé–“ã‚’è¨­å®š
  userData.tomariPeriod = {
    checkInDate,
    checkOutDate
  };
  
  userData.updatedAt = new Date().toISOString();
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  this.dispatchEvent(new CustomEvent('tomari:periodSet', {
    detail: { userId, checkInDate, checkOutDate }
  }));
}
```

---

### 8.2 æ³Šã¾ã‚ŠæœŸé–“ã®å‰Šé™¤

```javascript
#clearTomariPeriod(userId) {
  const userData = this.#userData.get(userId);
  if (!userData) return;
  
  const oldPeriod = userData.tomariPeriod;
  
  // æ³Šã¾ã‚ŠæœŸé–“ã‚’å‰Šé™¤
  userData.tomariPeriod = null;
  
  // æ³Šã¾ã‚ŠæœŸé–“å†…ã®é€šã„æƒ…å ±ã‚‚å‰Šé™¤
  if (oldPeriod) {
    const { checkInDate, checkOutDate } = oldPeriod;
    for (let date = checkInDate; date <= checkOutDate; date = this.#addDays(date, 1)) {
      delete userData.kayoiSchedule[date];
    }
  }
  
  userData.updatedAt = new Date().toISOString();
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  this.dispatchEvent(new CustomEvent('tomari:periodCleared', {
    detail: { userId }
  }));
}
```

---

## 9. ã‚°ãƒªãƒƒãƒ‰å†æç”»

### 9.1 ã‚°ãƒªãƒƒãƒ‰ã®æ›´æ–°

```javascript
#refreshGrid() {
  // ã™ã¹ã¦ã®ã‚»ãƒ«ã‚’å†æç”»
  const cells = this.#gridElement.querySelectorAll('.schedule-cell');
  
  cells.forEach(cell => {
    const userId = cell.dataset.userId;
    const date = cell.dataset.date;
    const userData = this.#userData.get(userId);
    
    if (!userData) return;
    
    // è¨˜å·ã‚’æ›´æ–°
    const symbol = this.#getDisplaySymbol(userData, date);
    cell.querySelector('.symbol').textContent = symbol;
    
    // ç½«ç·šçŠ¶æ…‹ã‚’æ›´æ–°
    const borderState = this.#getBorderState(userData, date);
    cell.dataset.borderState = borderState;
  });
}

#getDisplaySymbol(userData, date) {
  // L2_é€šã„_ãƒ‡ãƒ¼ã‚¿æ§‹é€ .md v4.0 ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
  const isInTomariPeriod = userData.tomariPeriod && 
    date >= userData.tomariPeriod.checkInDate && 
    date <= userData.tomariPeriod.checkOutDate;
  
  const kayoi = userData.kayoiSchedule[date];
  
  if (kayoi === "çµ‚æ—¥") return "â—‹";
  if (kayoi === "å‰åŠ") return "â—“";
  if (kayoi === "å¾ŒåŠ") return "â—’";
  if (kayoi === null && !isInTomariPeriod) return "";
  
  if (isInTomariPeriod && kayoi === undefined) {
    return "â—‹";
  }
  
  return "";
}

#getBorderState(userData, date) {
  if (!userData.tomariPeriod) return "none";
  
  const { checkInDate, checkOutDate } = userData.tomariPeriod;
  
  if (date >= checkInDate && date < checkOutDate) {
    return "stay";
  }
  
  if (date === checkOutDate) {
    return "checkout";
  }
  
  return "none";
}
```

---

## 10. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°

### 10.1 æ—¥ä»˜æ“ä½œ

```javascript
#addDays(dateStr, days) {
  const date = new Date(dateStr);
  date.setDate(date.getDate() + days);
  return date.toISOString().split('T')[0];
}

#dateDiff(date1, date2) {
  const d1 = new Date(date1);
  const d2 = new Date(date2);
  return Math.floor((d1 - d2) / (1000 * 60 * 60 * 24));
}

#isDateInRange(date, startDate, endDate) {
  return date >= startDate && date <= endDate;
}
```

---

## 11. ã¾ã¨ã‚

### 11.1 ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å®šç¾©ã—ãŸã“ã¨

```
âœ… å®šç¾©ã—ãŸã“ã¨
â”œâ”€ é•·æŠ¼ã—æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€ æœŸé–“é¸æŠãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€ ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†
â”œâ”€ ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‡¦ç†
â””â”€ ã‚°ãƒªãƒƒãƒ‰å†æç”»
```

---

### 11.2 é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

1. **é•·æŠ¼ã—ã¯0.8ç§’**
2. **ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ã‚»ãƒ«ã®è¿‘ãã«è¡¨ç¤º**
3. **èµ·ç‚¹ã®å‹•ãã¯ç›´æ„Ÿçš„**ï¼ˆå‰ã‚’ã‚¯ãƒªãƒƒã‚¯â†’é€€æ‰€æ—¥ã€å¾Œã‚’ã‚¯ãƒªãƒƒã‚¯â†’å…¥æ‰€æ—¥ï¼‰
4. **ãƒœã‚¿ãƒ³ã¯çŠ¶æ…‹ã«å¿œã˜ã¦å¤‰åŒ–**
5. **æ³Šã¾ã‚Šå‰Šé™¤æ™‚ã¯é€šã„ã‚‚å‰Šé™¤**

---

### 11.3 ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•

```
ã‚¤ãƒ™ãƒ³ãƒˆå                     ç™ºç«ã‚¿ã‚¤ãƒŸãƒ³ã‚°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
kayoi:updated                 é€šã„æƒ…å ±æ›´æ–°æ™‚
tomari:periodSet              æ³Šã¾ã‚ŠæœŸé–“è¨­å®šæ™‚
tomari:periodCleared          æ³Šã¾ã‚ŠæœŸé–“å‰Šé™¤æ™‚
calendar:opened               ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºæ™‚
calendar:closed               ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–‰ã˜ãŸæ™‚
```

---

### 11.4 æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

é€šã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­è¨ˆï¼ˆãƒ‡ãƒ¼ã‚¿ã€UIã€ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

æ¬¡ã¯çµ±åˆUIã®è»½å¾®ãªä¿®æ­£ã‚’è¡Œã„ã¾ã™ï¼š

1. **L3_UI_çµ±åˆUIè¨­è¨ˆ.md v3.1** - å®šå“¡è¡¨ç¤ºå‰Šé™¤ã®åæ˜ 

---

## ğŸ“š æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­äº†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«é€²ã‚“ã§ãã ã•ã„ã€‚

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **L2_é€šã„_ãƒ‡ãƒ¼ã‚¿æ§‹é€ .md v4.0** - ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®è©³ç´°
- **L2_é€šã„_UIè¨­è¨ˆ.md v4.0** - UIè¨­è¨ˆã®è©³ç´°
- **L3_UI_çµ±åˆUIè¨­è¨ˆ.md v3.1** - çµ±åˆUIè¨­è¨ˆ

---

## ğŸ“ å‚è€ƒè³‡æ–™

- L2_é€šã„_ãƒ‡ãƒ¼ã‚¿æ§‹é€ .md v4.0ï¼ˆãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼‰
- L2_é€šã„_UIè¨­è¨ˆ.md v4.0ï¼ˆUIè¨­è¨ˆï¼‰
- L1_æŠ€è¡“_å®Ÿè£…åˆ¶ç´„.mdï¼ˆæŠ€è¡“çš„åˆ¶ç´„ï¼‰

---

## ğŸ“… æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | æ‹…å½“ |
|------|----------|---------|------|
| 2025-11-23 | 1.0 | åˆç‰ˆä½œæˆ | Claude |
| 2025-12-19 | 3.0 | é•·æŠ¼ã—å‡¦ç†ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ã€ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†è¿½åŠ  | Claude |

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´12æœˆ19æ—¥  
**æ¬¡å›æ›´æ–°äºˆå®š**: Phase 1å®Ÿè£…ä¸­ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åæ˜ æ™‚

---

## âš ï¸ è¨­è¨ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆv3.0ï¼‰ï¼š

- [x] ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚·ã‚°ãƒãƒãƒ£ãŒæ˜è¨˜ã•ã‚Œã¦ã„ã‚‹
- [x] é•·æŠ¼ã—æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ãŒè©³ç´°
- [x] ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ãŒæ˜ç¢º
- [x] æœŸé–“é¸æŠãƒ­ã‚¸ãƒƒã‚¯ãŒå…·ä½“çš„
- [x] ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†ãŒå®Œå…¨
- [x] ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ•ãƒ­ãƒ¼ãŒæ˜ç¢º
- [x] ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã®è¨­è¨ˆãŒæ˜ç¢º
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒè€ƒæ…®ã•ã‚Œã¦ã„ã‚‹

---

**ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­äº†ã—ãŸã‚‰ã€INDEX_ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹æˆ.md ã«æˆ»ã‚Šã€æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«é€²ã‚“ã§ãã ã•ã„ã€‚**