# 実装指示書作成ガイド

**作成日**: 2025年12月5日  
**用途**: 実装指示書を作成する際のガイドライン  
**対象読者**: 設計担当者（Claude）  
**バージョン**: 2.1  
**更新日**: 2025年12月20日

---

## 📖 このガイドについて

このガイドは、**L1_設計・実装の方針.md で定義された原則**に基づいて、実装指示書を作成する具体的な手順を示します。

### 実装指示書とは

設計書を読んだ実装担当者（GitHub Copilot Agent等）が、**迷わず実装できる**ように、具体的な手順を記載したドキュメントです。

### 実装指示書と設計書の違い

| 項目 | 設計書 | 実装指示書 |
|------|--------|----------|
| **目的** | 「何を作るか」を定義 | 「どう作るか」を指示 |
| **読者** | 設計担当、実装担当、レビュー担当 | 実装担当のみ |
| **内容** | 概念、構造、ロジック、UI仕様 | 具体的なコード例、修正手順 |
| **スタイル** | 説明的、網羅的 | 命令的、簡潔 |

### v2.0での主要な変更

- **L1_設計・実装の方針.mdとの役割分担を明確化**
- **INDEX v2.0の活用方法を追加**（ステップ0.5）
- **書くべきこと・書かないべきこと（具体的判断基準）を追加**（セクション3.5）
- **L1から移動: テンプレート、警告の例、誤実装の例**
- **約650行 → 約900行（+38%）**

### v2.1での主要な変更（2025年12月20日）

- **実装前の最小限チェックを追加**（ステップ0.7）
  - ケース判定（完全新規/機能追加/大幅修正）
  - 最小限チェック（CSS変数、レイアウト全体、HTML基本構造）
  - ケース別チェック（特にケース3の詳細確認）
  - ギャップ分析と修正方針の明記
- **通いv4.0のHTML構造ミス（div vs table）を踏まえた改善**
- **約900行 → 約1,300行（+44%）**

---

## 🚨 【超重要】長さの制約

### GitHub Copilot Agentのタイムアウト問題

**問題**:
実装指示書が長すぎると、GitHub Copilot Agentに送信した際に以下のエラーが発生します：

```
Request Failed: 408
{"error":{"message":"Timed out reading request body. 
Try again, or use a smaller request size.","code":"user_request_timeout"}}
```

**原因**:
- リクエストボディが大きすぎる
- タイムアウト（読み込み時間超過）

**影響**:
- 実装が開始できない
- 何度試しても同じエラーが出る
- 実装指示書を分割する必要がある

---

### 長さの目安

| 行数 | 判定 | 対応 |
|------|------|------|
| **0-200行** | ✅ 安全 | そのまま送信できる |
| **200-300行** | ⚠️ 注意 | ギリギリ送信できるが、簡潔にする努力を |
| **300-500行** | 🚨 危険 | タイムアウトのリスク大、分割を検討 |
| **500行以上** | ❌ 不可 | ほぼ確実にタイムアウト、必ず分割 |

---

### 分割の目安

**1つの実装指示書 = 1つの独立した作業単位**

#### 分割すべき例

**悪い例**（500行）:
```
Phase 1 実装指示書：通いセクション修正
├─ 修正1: 日別サマリー削除
├─ 修正2: ID名の統一（7箇所）
├─ 修正3: クラス名の統一（2箇所）
├─ 修正4: カレンダーヘッダーの構造修正
├─ 修正5: CSS変数の追加
├─ 修正6: CSS変数の誤参照修正
└─ 修正7: </main>タグの重複削除
```

**良い例**（分割）:
```
修正1_日別サマリー削除.md（100行）
修正2-7_細かい修正.md（200行）
```

または、さらに細かく：
```
修正1_日別サマリー削除.md（100行）
修正2_ID名統一.md（80行）
修正3-7_その他修正.md（120行）
```

---

## ⚠️ ステップ0: 設計書の再確認（最重要）

**実装指示書を書き始める前に、必ずこのチェックリストを実行してください。**

### なぜ必要か？

実装指示書作成者（Claude）が**設計を誤解したまま実装指示書を書く**と：
- 実装担当者（GitHub Copilot）が誤った実装をする
- 修正作業が発生する
- 時間とリソースが無駄になる

**予防策**: 実装指示書を書く前に、設計書を徹底的に確認する

---

### チェックリスト

#### 1. 関連設計書をすべて読む

- [ ] L2層（セクション別）の設計書を読んだか？
  - 例: L2_通い_データ構造.md、L2_通い_UI設計.md、L2_通い_ロジック設計.md
  
- [ ] L3層（統合設計）の設計書を読んだか？
  - 例: L3_UI_統合UI設計.md、U3_UI_日別サマリー.md
  
- [ ] L1層（基礎）の制約を確認したか？
  - 例: L1_技術_実装制約.md、L1_技術_アーキテクチャ設計.md

---

#### 2. 「タブ別の違い」を理解する

**よくある誤解**: 「全タブで同じUIを表示する」

- [ ] 全体タブと通いタブの違いを理解したか？
  - 例: 日別サマリーの表示内容が異なる
  
- [ ] 泊まりタブと訪問タブの違いを理解したか？
  - 例: グリッド構造が異なる
  
- [ ] タブ別の実装範囲を理解したか？
  - 例: Phase 1では通いタブのみ実装

**確認方法**:
```
U3_UI_日別サマリー.md のセクション1.4「タブ別の表示内容」を読む
```

---

#### 3. 「セクション独立性」を理解する

**よくある誤解**: 「共通HTMLで効率化する」

- [ ] 各セクションは完全に独立していることを理解したか？
  - 通いセクションは泊まりセクションを参照しない
  - 泊まりセクションは訪問セクションを参照しない
  
- [ ] 共通化してはいけない部分を理解したか？
  - 例: 日別サマリーのHTML（タブ別に専用HTMLを作成）
  
- [ ] 共通化すべき部分を理解したか？
  - 例: CSS変数、共通コンポーネント（トースト、ダイアログ）

**確認方法**:
```
L1_技術_アーキテクチャ設計.md のセクション2.4「データの独立性マトリックス」を読む
GUIDE_LLM誤解予測レビュー.md の警告例を読む
```

---

#### 4. 引継ぎドキュメントに頼りすぎない

**よくある誤解**: 「引継ぎドキュメントに書いてあることが正しい」

- [ ] 引継ぎドキュメントは**要約**であることを理解したか？
  - 詳細は設計書で確認する必要がある
  
- [ ] 引継ぎドキュメントに矛盾がないか確認したか？
  - 例: 「日別サマリーが5行（設計は3行）」→ 実際はタブ別に異なる
  
- [ ] 設計書と引継ぎドキュメントで異なる場合、設計書を優先したか？

---

#### 5. 曖昧な部分を明確にする

**よくある誤解**: 「〜のような」「〜など」は具体例が無限にある

- [ ] 「〜のような」という表現がある場合、具体例を確認したか？
  - 例: 「通いセクションのような構造」→ 他のセクションも同じ？
  
- [ ] 「〜など」という表現がある場合、全パターンを確認したか？
  - 例: 「通い・泊まり・訪問など」→ 他にもある？
  
- [ ] 設計書に書かれていないことは**やらない**ことを理解したか？

---

### よくある誤解パターン

#### パターン1: 「例」を「すべて」だと思う

**誤解**: 「通いセクションの例を見た。他のセクションも同じだろう」

**正しい理解**: 「例」は**あくまで例**。他のセクションは別途設計書を確認する。

**確認方法**: 
- L2_泊まり_UI設計.md を読む
- L2_訪問_UI設計.md を読む
- 構造が異なることを確認する

---

#### パターン2: 「共通」の範囲を勘違い

**誤解**: 「日別サマリーは共通 → 全タブで同じ内容を表示」

**正しい理解**: 「日別サマリーという**機能**は共通だが、表示内容はタブ別」

**確認方法**:
- U3_UI_日別サマリー.md のセクション1.4を読む
- タブ別の表示内容の表を確認する

---

#### パターン3: 「効率化」を優先しすぎる

**誤解**: 「共通HTMLで制御した方が効率的だから、そうしよう」

**正しい理解**: 設計思想（セクション独立性）が最優先。効率化は二の次。

**確認方法**:
- GUIDE_LLM誤解予測レビュー.md を読む
- 「やってはいけない実装パターン」を確認する

---

### チェック完了の確認

すべてのチェックボックスに✓が入ったら、次のステップ（ステップ0.5）に進んでください。

**1つでも未確認の項目がある場合は、実装指示書を書き始めないでください。**

---

## 🗺️ ステップ0.5: INDEX v2.0でナビゲート（NEW）

**実装指示書を書く前に、INDEX_ドキュメント構成.md v2.0を確認してください。**

### なぜINDEX v2.0が必要か

**今回のミス（カレンダーヘッダーを通いグリッドに含めた）を防ぐため**:
- タスク別ナビゲーションで依存関係が分かる
- 責任分界マップで「作らないもの」が分かる
- ドキュメント間の依存関係が明確になる

---

### タスク別ナビゲーションで依存関係を確認

例：「通いUI実装指示書を作成する」

```
INDEX v2.0 タスク2を確認:

必読ドキュメント（この順序で）:
1. L2_通い_データ構造.md（15分）
2. L2_通い_UI設計.md（15分）
   ⚠️ セクション1.1「カレンダーヘッダーはL3で定義」確認
3. L3_UI_統合UI設計.md セクション4（15分）← ⚠️ 必須
   - カレンダーヘッダーの責任分界
   - 読まないとどうなる: 通いグリッド内にヘッダーを含めてしまう
4. L2_通い_ロジック設計.md（20分）
5. L1_制約ゲーム_全体設計.md セクション3（10分）
```

**重要**: 「読まないとどうなる」という警告が書いてある

---

### 責任分界マップで「作らないもの」を確認

```
INDEX v2.0 責任分界マップ:

カレンダーヘッダー:
- 責任者: L3_UI_統合UI設計.md
- 内容: 日付行、曜日行
- ⚠️ 注意: 各セクションはカレンダーヘッダーを作らない

通いセクション:
- 責任者: L2_通い_UI設計.md
- ✅ 作ること: 利用者行、スケジュールセル、定員表示
- ❌ 作らないこと: カレンダーヘッダー（L3の責任）
```

**重要**: 「❌ 作らないこと」が明記されている

---

### 依存関係を確認

```
INDEX v2.0 ドキュメント間の依存関係:

L2_通い_UI設計.md:
  依存先:
  - → L3_UI_統合UI設計.md（カレンダーヘッダーの責任分界）
  - → L1_制約ゲーム_全体設計.md（カラーグラデーション）
  
  警告:
  - カレンダーヘッダーを通いグリッド内に含めてはいけない
  - 理由: セクション独立性、縦軸整列
```

**重要**: 依存関係と警告が明記されている

---

### チェックリスト

ステップ0.5完了の確認：

- [ ] INDEX v2.0のタスク別ナビゲーションを確認したか？
- [ ] 必読ドキュメントをすべて読んだか？
- [ ] 依存関係を確認したか？
- [ ] 責任分界マップで「作らないもの」を確認したか？
- [ ] 警告を理解したか？

**すべてに✓が入ったら、次のステップ（ステップ0.7）に進んでください。**

---

## 🔍 ステップ0.7: 実装前の最小限チェック（HTML/CSS/JS確認）

**実装指示書を書く前に、既存の実装を確認してください。**

### なぜ必要か？

**実装指示書作成時の失敗例（通いv4.0、2025-12-20）**:
- 設計書: table構造を想定
- CSS: `table-layout: fixed`（table専用プロパティ）
- JavaScript: div要素でグリッド生成 ← **確認しなかった**
- 結果: 縦軸が全く揃わない

**予防策**: 既存のHTML/CSS/JavaScript実装を確認し、ギャップを特定する

---

### ステップ1: ケース判定（5分）

まず、今回のタスクがどのケースに該当するか判断：

| ケース | 説明 | 例 |
|--------|------|-----|
| **ケース1: 完全新規** | 既存と独立した新機能 | 統計セクションの新規追加 |
| **ケース2: 機能追加** | 既存に機能を追加 | 通いセクションに検索機能追加 |
| **ケース3: 大幅修正** | 既存の構造を変更 | 通いv3.0 → v4.0（データ構造変更） |

**判断方法**:
```
Q1: 既存のコードを修正する？
  → No  → ケース1（完全新規）
  → Yes → Q2へ

Q2: 既存のデータ構造やUI構造を変更する？
  → No  → ケース2（機能追加）
  → Yes → ケース3（大幅修正）
```

**チェックリスト**:
- [ ] ケースを判定した（ケース1/2/3のいずれか）

---

### ステップ2: 最小限チェック（全ケース共通、20分）

**すべてのケースで必ず確認**:

#### 2-1. CSS変数の確認（5分）

**ファイル**: `variables.css`

**確認すること**:
```css
/* 縦軸整列用の変数が定義されているか */
--label-column-width: ?
--date-cell-width: ?
```

**実装指示書への記録**:
```markdown
## 📋 実装前チェック（完了済み）

### CSS変数の確認

variables.css:
- --label-column-width: 80px
- --date-cell-width: clamp(35px, calc(...), 50px)

評価: ✅ 設計書通り
```

**チェックリスト**:
- [ ] CSS変数を確認した
- [ ] 実装指示書に記録した

---

#### 2-2. レイアウト全体の確認（10分）

**ファイル**: `L3_UI_統合UI設計.md`

**確認すること**:
- カレンダーヘッダーの責任範囲
- 各セクションの責任範囲
- 縦軸整列の要件

**実装指示書への記録**:
```markdown
### レイアウト全体の確認

L3_UI_統合UI設計.md:
- カレンダーヘッダー: L3の責任（このセクションは作らない）
- 縦軸整列: マスト要件
- CSS変数: 全セクション共通

評価: ✅ 責任分界を理解
```

**チェックリスト**:
- [ ] レイアウト全体を確認した
- [ ] 責任分界を理解した
- [ ] 実装指示書に記録した

---

#### 2-3. HTML基本構造の確認（5分）

**ファイル**: `index.html`

**確認すること**:
- セクションの配置
- 共通ヘッダーの構造
- **既存のHTML要素の種類（table or div）** ← **超重要**

**実装指示書への記録**:
```markdown
### HTML基本構造の確認

index.html:
- #kayoi-section: 存在する
- #kayoi-grid: 空のdivコンテナ
- 動的生成: JavaScript（KayoiUI.js）

⚠️ 次のステップ: KayoiUI.jsでどんなHTML構造を生成しているか確認が必要
```

**重要**:
- ここで**table or div**の判断ができない場合、ケース別チェックへ

**チェックリスト**:
- [ ] HTML基本構造を確認した
- [ ] 実装指示書に記録した

---

### ステップ3: ケース別チェック

#### ケース1: 完全新規の場合

```markdown
✅ 最小限チェックのみでOK

次のステップ:
- セクション3（実装指示書の構成）に進む
```

**チェックリスト**:
- [ ] 最小限チェックを完了した

---

#### ケース2: 機能追加の場合

```markdown
✅ 追加先の詳細確認が必要（30分）

確認すべきファイル:
1. JavaScriptクラスの構造（例: KayoiUI.js）
   - どのメソッドに追加するか
   - 既存のイベントリスナー
   
2. CSSの詳細（例: kayoi.css）
   - どのクラス名を使うか
   - 既存のスタイル

3. データ構造
   - 既存のデータをどう使うか
```

**実装指示書への記録**:
```markdown
### 追加先の確認

KayoiUI.js:
- 追加先メソッド: render()
- 既存のイベントリスナー: click, mousedown

kayoi.css:
- 使用するクラス名: .schedule-cell
- 既存スタイルとの整合性: ✅

評価: ✅ 追加先を把握
```

**チェックリスト**:
- [ ] 追加先のJavaScriptを確認した
- [ ] 追加先のCSSを確認した
- [ ] 実装指示書に記録した

---

#### ケース3: 大幅修正の場合（最も重要）

```markdown
✅ 既存実装の全体確認が必須（1時間）

確認すべきファイル:
1. JavaScript（例: KayoiUI.js）
   - renderメソッドは何を生成するか
   - どんなHTML要素を使っているか（table? div?）← 超重要
   - どんなクラス名を使っているか
   
2. CSS（例: kayoi.css）
   - どんなHTML構造を期待しているか
   - table-layout: fixed等の使用
   - セレクタの種類
   
3. 既存データ構造
   - 移行パスの設計が必要か
```

**実装指示書への記録**:
```markdown
### 既存実装の全体確認

**HTML構造**:
- #kayoi-gridは空のdivコンテナ
- KayoiUI.jsで動的生成
- 現在は **div要素** でグリッドを作成 ← 重要

**JavaScript**:
- KayoiUI.js: renderHeader()で **div要素** を生成
- createDataRow()で **div要素** を生成

**CSS**:
- kayoi.css: **table-layout: fixed** を使用
- **table要素** を前提とした設計

**CSS変数**:
- --label-column-width: 80px
- --date-cell-width: clamp(...)

### ギャップ

❌ JavaScriptは **div** を生成
❌ CSSは **table** を期待
→ `table-layout: fixed`がdivには効かない
→ **縦軸が揃わない**

### 修正方針

✅ JavaScriptを **table要素生成** に変更
理由: CSSがすでにtable前提で書かれているため
```

**チェックリスト**:
- [ ] JavaScriptの実装を確認した
- [ ] CSSの実装を確認した
- [ ] ギャップを特定した
- [ ] 修正方針を決定した
- [ ] 実装指示書に記録した

---

### ステップ4: チェック完了の確認

実装指示書に以下のセクションが記載されているか確認：

```markdown
## 📋 実装前チェック（完了済み）

### ケース判定
- ケース: [ケース1/2/3]
- 理由: [判断理由]

### 既存の実装状況
[確認結果]

### ギャップ（ケース3のみ）
[問題点と修正方針]
```

**チェックリスト**:
- [ ] 実装前チェック結果を実装指示書に記載した
- [ ] ギャップがある場合、修正方針を明記した

**すべてに✓が入ったら、次のステップ（セクション3）に進んでください。**

---

### ケース別の確認時間の目安

| ケース | 最小限チェック | 追加チェック | 合計 |
|--------|---------------|-------------|------|
| ケース1（完全新規） | 20分 | - | 20分 |
| ケース2（機能追加） | 20分 | 30分 | 50分 |
| ケース3（大幅修正） | 20分 | 1時間 | 1時間20分 |

---

### 重要な原則

1. **最小限チェックは全ケース必須**
   - CSS変数、レイアウト全体、HTML基本構造
   
2. **ケース3では既存実装の全体確認が必須**
   - JavaScriptが何を生成するか
   - CSSが何を期待するか
   - ギャップの有無
   
3. **実装指示書には必ずチェック結果を記載**
   - 透明性の確保
   - 実装担当者の理解を助ける


---

## 📋 セクション3: 実装指示書の構成

### 3.1 基本テンプレート

```markdown
# [タイトル]

**作成日**: YYYY-MM-DD  
**優先度**: 高/中/低  
**所要時間**: XX分

---

## 🎯 やること

[一文で要約]

---

## ⚠️ 重要な警告（必要に応じて）

### ❌ やってはいけないこと
### ✅ やること
### 💡 理由

---

## 📋 修正内容

### ステップ1: [作業名]
[具体的なコード例]

### ステップ2: [作業名]
[具体的なコード例]

---

## ✅ 完成の確認

- [ ] [確認項目1]
- [ ] [確認項目2]

---

以上です。
```

---

### 3.2 ヘッダー情報

```markdown
# [タイトル]

**作成日**: YYYY-MM-DD  
**優先度**: 高/中/低  
**所要時間**: XX分
```

- タイトル：何をする指示書か一目で分かる
- 優先度：緊急性を明示
- 所要時間：実装の目安

---

### 3.3 やること（要約）

```markdown
## 🎯 やること

[一文で要約]
```

- 一文で要約
- 読者がすぐに理解できる

**例**:
```
通いセクション（`#kayoi-section`）内の日別サマリーを完全に削除する
```

---

### 3.4 警告セクション（L1から移動）

```markdown
## ⚠️ 重要な警告

### ❌ やってはいけないこと
### ✅ やること
### 💡 理由
```

**LLM誤解予測レビューで特定した誤実装パターンを記載**

詳細は `GUIDE_LLM誤解予測レビュー.md` および `L1_設計・実装の方針.md セクション3` を参照。

---

#### いつ警告が必要か

- 実装者が「効率化」を考えそうな場合
- 設計意図と逆の実装をしやすい場合
- 暗黙の前提がある場合

---

#### 警告の書き方（具体例）

**例1: モーダル禁止**

```markdown
### ❌ やってはいけないこと

- モーダル・ダイアログを使用する
- ポップアップで編集画面を表示する

### ✅ やること

- **左クリックでトグルのみ**
- セル内で直接状態を変更

### 💡 理由

- Phase 1は「シンプルに動くもの」を優先
- モーダルは Phase 2 で検討
- 根拠: `docs/L1/L1_概要_プロジェクト概要.md` セクション2.2
```

---

**例2: ライブラリ禁止**

```markdown
### ❌ やってはいけないこと

- jQuery を使用する
- React, Vue等のフレームワークを導入する
- ライブラリをCDNから読み込む

### ✅ やること

- **バニラJavaScriptで実装**
- ライブラリ・フレームワーク不使用

### 💡 理由

- シンプルさを優先
- 学習コストを低く保つ
- 根拠: `docs/L1/L1_技術_実装制約.md` セクション1
```

---

**例3: 仕様の簡略化禁止**

```markdown
### ❌ やってはいけないこと

- 「日別サマリーを5行で表示」のように、独自に簡略化する
- 設計書に書かれていない改善を加える

### ✅ やること

- **設計書通りに実装**
- タブ別に3行（全体・通い・泊まり・訪問それぞれ）

### 💡 理由

- 設計書の意図を尊重
- 勝手な簡略化は誤実装
- 根拠: `docs/U3/U3_UI_日別サマリー.md` セクション1.4
```

---

**例4: 重複コードの削除禁止**

```markdown
### ❌ やってはいけないこと

- カレンダーヘッダーが2箇所にあるから統合する
- 「DRY原則」を適用して共通化する

### ✅ やること

- **設計書通りに実装**
- 統合UIと通いセクションは独立

### 💡 理由

- セクション独立性の原則
- 共通化は設計段階で判断済み
- 根拠: `docs/L1/L1_技術_アーキテクチャ設計.md` セクション2
```

---

**例5: CSS変数を無視しない**

```markdown
### ❌ やってはいけないこと

- セル幅を固定値（30px等）で指定する
- CSS変数を使わずに直接値を書く

### ✅ やること

- CSS変数を無視しない
- 必ず: `var(--date-cell-width)` を使用

### 💡 理由

- 横スクロール禁止のため
- 縦軸整列のため
- 根拠: `docs/L1/L1_技術_実装制約.md` セクション3.6
```

---

#### Phase 1で発生した誤実装の例（L1から移動）

Phase 1実装後に発覚した5つの問題は、全てこの「効率化の誘惑」が原因でした：

```
1. 日別サマリー5行 → 誘惑3（仕様の簡略化）
2. 日付ヘッダー重複 → 誘惑4（重複コードの削除）
3. モーダル表示 → 誘惑1（モーダルを作る）
4. 横スクロール → 誘惑5（CSS変数を無視）
5. セル幅ズレ → 誘惑5（CSS変数を無視）
```

**警告セクションがあれば、これらは全て防げます。**

---

### 3.5 実装指示書に書くべきこと・書かないべきこと（NEW）

**L1_設計・実装の方針.md で定義された原則に基づき、具体的な判断基準を示します。**

原則については `L1_設計・実装の方針.md セクション2.5` を参照してください。

---

#### 書くべきこと（具体的判断基準）

##### 1. 非自明な部分の完全なコード

**判断基準**:
- [ ] 設計書に計算式が書かれているか？ → YES なら完全コードを書く
- [ ] 実装者が「どう書くか」迷う部分か？ → YES なら完全コードを書く

**例1：カラーグラデーション計算式**

```javascript
// 完全なコードを提供（設計書にある計算式）
function calculateColor(count, capacity) {
  const ratio = count / capacity;
  
  // 超過（100%以上）
  if (ratio >= 1.0) {
    return 'rgba(255, 0, 0, 0.1)'; // 赤
  }
  
  // ギリギリ（80-99%）
  if (ratio >= 0.8) {
    return 'rgba(255, 255, 0, 0.1)'; // 黄
  }
  
  // 余裕（0-79%）
  return 'rgba(255, 255, 255, 0)'; // 透明（背景色）
}
```

**理由**: 計算式が設計書にあっても、実装者が正確に書けるとは限らない

---

**例2：状態遷移のロジック**

```javascript
// 完全なコードを提供（状態遷移図があっても、実装は自明ではない）
function getNextState(currentState) {
  const stateTransition = {
    '': '○',      // 空欄 → 終日
    '○': '◓',     // 終日 → 前半
    '◓': '◒',     // 前半 → 後半
    '◒': ''       // 後半 → 空欄
  };
  
  return stateTransition[currentState] || '';
}
```

**理由**: 状態遷移図があっても、実装方法は複数ある

---

##### 2. 警告セクション

**判断基準**:
- [ ] LLM誤解予測レビューで誤実装パターンを特定したか？
- [ ] 「効率化の誘惑」がありそうか？
- [ ] 設計意図と逆の実装をしやすいか？

**書き方は セクション3.4 を参照**

---

##### 3. 完成の定義

**書き方**:
```markdown
## ✅ 完成の確認

機能の動作確認:
- [ ] [確認項目1]
- [ ] [確認項目2]

制約の遵守確認:
- [ ] [確認項目3]
- [ ] [確認項目4]
```

---

#### 書かないべきこと（具体的判断基準）

##### 1. HTML構造の詳細

**理由**: 設計書（L2_×××_UI設計.md）に書いてある

**誤った書き方**:
```markdown
## HTML構造

<div class="kayoi-section">
  <table id="kayoi-grid">
    <thead>
      <tr>
        <th>利用者名</th>
        <th>1日</th>
        ...
      </tr>
    </thead>
  </table>
</div>
```

**正しい書き方**:
```markdown
## HTML構造

L2_通い_UI設計.md セクション2.1「グリッド構造」を参照してください。

要点:
- `#kayoi-section` 内に配置
- `table-layout: fixed` を使用
- CSS変数 `--date-cell-width` で列幅を統一
```

---

##### 2. CSS変数の固定値

**書くべきもの**:
```markdown
✅ 「CSS変数 `--date-cell-width` を使用してください」
✅ 「L2_通い_UI設計.md セクション5で定義されています」
```

**書かないもの**:
```markdown
❌ 「セル幅を 30px にしてください」
❌ 「日付列は width: 30px を指定」
```

**理由**: 
- CSS変数は設計書で定義済み
- 固定値は縦軸整列を壊す
- 画面幅に応じて自動調整される

---

##### 3. 統合UIの構造

**理由**: 責任範囲外（L3_UI_統合UI設計.mdの責任）

**確認方法**:
```
INDEX_ドキュメント構成.md v2.0 の責任分界マップを確認
→ カレンダーヘッダーは統合UIの責任
→ 通いセクションは作らない
```

**正しい書き方**:
```markdown
⚠️ カレンダーヘッダーは作成しないでください。

理由: 
- L3_UI_統合UI設計.mdの責任範囲です
- INDEX_ドキュメント構成.md v2.0 の責任分界マップを参照してください
- 通いセクションは利用者行のみを作成します
```

---

##### 4. 設計書の全文コピー

**理由**: タイムアウトを防ぐため

**誤った書き方**:
```markdown
## データ構造

KayoiScheduleクラス:

プロパティ:
- userId: string - 利用者ID
- date: string - 日付（'YYYY-MM-DD'）
- symbol: string - 記号（'○'/'◓'/'◒'/空欄）
- pickupType: string - 送迎タイプ（'staff'/'family'/null）
- memo: string - メモ
- createdAt: string - 作成日時
- updatedAt: string - 更新日時

メソッド:
- validate(): boolean - バリデーション
- toJSON(): object - JSON変換
... （省略、延々と続く）
```

**正しい書き方**:
```markdown
## データ構造

L2_通い_データ構造.md セクション2「KayoiScheduleクラス」を参照してください。

要点:
- 日付は string型（'YYYY-MM-DD'）
- 記号は string型（'○'/'◓'/'◒'/空欄）
- validate()メソッドで必須チェック
```

---

#### よくある誤解パターン

##### パターン1: 「設計書に詳細があるから省略できる」

**誤解**: 「L2_通い_UI設計.mdにHTML構造があるから、実装指示書には不要」

**正しい理解**: 設計書への参照は必要。どのセクションを読むべきか明記する。

**正しい書き方**:
```markdown
HTML構造については、L2_通い_UI設計.md セクション2.1「グリッド構造」を参照してください。

特に注意:
- セクション2.3「縦軸整列」も確認してください
- CSS変数の使用が必須です
```

---

##### パターン2: 「効率化のために汎用化」

**誤解**: 「通いセクションの構造を汎用化して、他のセクションでも使えるようにする」

**正しい理解**: セクション独立性の原則。各セクションは独立して実装する。

**警告の書き方**:
```markdown
❌ 汎用化しないでください

理由: 
- 各セクションは独立して設計されています
- L1_技術_アーキテクチャ設計.md セクション2を参照
- 共通化は設計段階で判断されています
```

---

##### パターン3: 「テンプレートを短くする」

**誤解**: 「実装指示書が長いから、テンプレートを削って短くしよう」

**正しい理解**: 必要な要素を削ると誤実装が増える。代わりに分割する。

**正しいアプローチ**:
```
実装指示書が200行を超えたら:
1. 作業単位で分割できないか検討
2. 優先度で分割できないか検討
3. Phase分けできないか検討
```

---

### 3.6 修正内容

```markdown
## 📋 修正内容

### ステップ1: [作業名]

**ファイル**: `[ファイル名]`

**削除対象** / **追加内容** / **修正内容**:
```[言語]
[コード例]
```

**修正後**:
```[言語]
[コード例]
```
```

---

### 3.7 完成の確認

```markdown
## ✅ 完成の確認

機能の動作確認:
- [ ] [確認項目1]
- [ ] [確認項目2]

制約の遵守確認:
- [ ] [確認項目3]
- [ ] [確認項目4]

コード品質の確認:
- [ ] [確認項目5]
- [ ] [確認項目6]
```

---

## 📊 分割の判断フローチャート

```
実装指示書を作成
  ↓
行数をカウント
  ↓
200行以内？
  ├─ YES → そのまま完成
  └─ NO → 分割を検討
          ↓
        独立した作業単位に分けられる？
          ├─ YES → 作業単位ごとに分割
          │         （例：修正1、修正2-7）
          └─ NO → 優先度で分割
                    （例：最重要、高優先、低優先）
```

---

## 🎯 チェックリスト

実装指示書を作成したら、以下をチェックしてください：

### 内容の確認

- [ ] タイトルで何をするか分かる
- [ ] 「やること」が一文で要約されている
- [ ] ファイル名が明記されている
- [ ] 具体的なコード例がある（非自明な部分）
- [ ] 設計書への参照が適切（HTML構造等）
- [ ] 完成の確認項目がある

### 長さの確認

- [ ] 200行以内である
- [ ] 200行を超える場合、分割を検討した

### INDEX v2.0の確認

- [ ] タスク別ナビゲーションを確認した
- [ ] 依存関係を確認した
- [ ] 責任分界マップで「作らないもの」を確認した

### LLM誤解予測レビュー

- [ ] LLM誤解予測レビューを実施した
- [ ] 警告セクションが必要か判断した
- [ ] 「やらないこと」を明記した（必要に応じて）

### 品質の確認

- [ ] 簡潔に書かれている
- [ ] 検索しやすいキーワードを使っている
- [ ] 実装者が迷わない内容になっている

---

## 📚 関連ドキュメント

- **L1_設計・実装の方針.md** - 実装指示書の原則（WHY）
- **INDEX_ドキュメント構成.md v2.0** - タスク別ナビゲーション、依存関係、責任分界マップ
- **GUIDE_LLM誤解予測レビュー.md** - 警告セクション作成のガイド
- **CHECKLIST_設計レビュー.md** - 設計書全般のレビュー

---

## 🎓 まとめ

### 実装指示書の成功の鍵

1. **原則を理解する**
   - L1_設計・実装の方針.md を読む

2. **INDEX v2.0を活用する**
   - タスク別ナビゲーション
   - 依存関係
   - 責任分界マップ

3. **設計書を徹底的に確認する**
   - ステップ0のチェックリスト

4. **書くべきこと・書かないべきことを判断する**
   - セクション3.5の判断基準

5. **警告セクションを適切に書く**
   - LLM誤解予測レビュー

6. **簡潔に書く**
   - 200行以内推奨
   - 長すぎたら分割

---

**良い実装指示書は、実装の成功率を大幅に上げます！** 🎉

---

## 📅 更新履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|----------|---------|------|
| 2025-12-05 | 1.0 | 初版作成 | Claude |
| 2025-12-17 | 2.0 | L1との役割分担明確化、INDEX v2.0活用追加、書くべきこと・書かないべきこと追加、L1から移動（テンプレート、警告、誤実装例） | Claude |

---

**最終更新**: 2025年12月17日  
**次回更新予定**: 新しい誤実装パターンが発見された時

---

**このガイドを活用して、高品質な実装指示書を作成してください！**